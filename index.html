<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blogs/images/girl_180_0.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blogs/images/girl_32_0.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blogs/images/girl_16_0.png">
  <link rel="mask-icon" href="/blogs/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blogs/css/main.css">


<link rel="stylesheet" href="/blogs/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tyson-wu.github.io","root":"/blogs/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="If you want, Just do it!">
<meta property="og:type" content="website">
<meta property="og:title" content="TysonWu&#39;s Blog">
<meta property="og:url" content="https://tyson-wu.github.io/blogs/index.html">
<meta property="og:site_name" content="TysonWu&#39;s Blog">
<meta property="og:description" content="If you want, Just do it!">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Tyson Wu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://tyson-wu.github.io/blogs/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>TysonWu's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blogs/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">TysonWu's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">AiCooXiao</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blogs/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blogs/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/blogs/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blogs/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blogs/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2021/06/16/Are-Behavior-Trees-a-Thing-of-the-Past/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2021/06/16/Are-Behavior-Trees-a-Thing-of-the-Past/" class="post-title-link" itemprop="url">Are Behavior Trees a Thing of the Past?</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-16 15:01:00" itemprop="dateCreated datePublished" datetime="2021-06-16T15:01:00+08:00">2021-06-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-17 19:12:22" itemprop="dateModified" datetime="2021-06-17T19:12:22+08:00">2021-06-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/%E7%BF%BB%E8%AF%91/" itemprop="url" rel="index"><span itemprop="name">翻译</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/%E7%BF%BB%E8%AF%91/%E8%A1%8C%E4%B8%BA%E6%A0%91/" itemprop="url" rel="index"><span itemprop="name">行为树</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>原文：<br><a target="_blank" rel="noopener" href="https://www.gamasutra.com/blogs/JakobRasmussen/20160427/271188/Are_Behavior_Trees_a_Thing_of_the_Past.php">Are Behavior Trees a Thing of the Past?</a></p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>基于游戏沉浸感、以及和NPC智能交互的需求，游戏开发者在游戏中使用的AI技术成为了新的焦点。曾经在游戏中普遍使用，也是游戏中AI决策的主要方案的行为树，已经显得乏力。当游戏开发者希望实现更为复杂的AI行为时，例如处理突发情况，行为树已经无法满足。因此，更为先进的AI技术——Utility AI，已经逐步取代行为树的位置，开始在游戏中展现出更为优越的AI性能，开启一个新的游戏AI时代。</p>
<h2 id="行为树是如何屹立游戏AI界（以及它的衰落）"><a href="#行为树是如何屹立游戏AI界（以及它的衰落）" class="headerlink" title="行为树是如何屹立游戏AI界（以及它的衰落）"></a>行为树是如何屹立游戏AI界（以及它的衰落）</h2><p>大多数AI开发者都知道有限状态机（FSM）是一种简单且实用AI方法。通过简单地定义状态、以及状态之间切换的条件，然后可以基于决策实现无限循环的AI行为。例如，FSM将持续保持某种状态，直到满足某种条件，才会从一种状态切换到另一种状态。</p>
<p>任何两个状态之间都可以在特定条件下实现切换，很容易设计FSM来实现AI行为。但是，有利也有弊。在一些大型游戏中，构建FSM需要上百个状态，这么多的状态导致异常分析变的非常困难。Damian Isla在2005 GDC论坛中针对Halo 2的AI系统，详细的指出了这一点。<br><img src="https://gamasutra.com/db_area/images/blog/apexgametools05.png"></p>
<p>为了解决这些问题，FSM进一步演化出层级结构，使得它易于设计和异常分析。分层结构使得FSM能够更好的处理大量的状态，但是并没有从根本上解决这个问题，当状态数量进一步增加时，FSM依然会变得难以管理。<br><img src="https://gamasutra.com/db_area/images/blog/apexgametools011.png"></p>
<p>最终，在这种层级组织的思想上，进一步演化出任务组织的树状结构——行为树。和状态机一样，行为树也是由多个状态节点组成，同一时刻只占据一种状态。不同的是，状态机中，任意两个状态之间的跳转都需要单独配置跳转条件，而行为树则是将这些跳转条件进行拆分，这些拆分后的最小条件单元称为条件装饰器。状态机中的跳转仅仅是对当前状态中的条件进行判断，如果满足条件则跳转，而行为树是从根节点开始，定时进行条件遍历，每经过一个装饰器，会进行次条件判断，然后选择不同的状态分支，以此类推。如果最终筛选出的状态和当前状态不同，那么执行状态跳转。因此，行为树解决了FSM中存在的很多问题，例如，FSM中可能发生条件满足却没有跳转的情况，或者其他跳转异常。在Unreal引擎中就实现了一套非常不错的行为树机制。<br><img src="https://gamasutra.com/db_area/images/blog/271188/image02.png"></p>
<p>相较于层级FSM，行为树能够实现更为复杂、同时容易理解的AI系统。并且这种树结构也便于实现可视化的异常分析。<br><img src="https://gamasutra.com/db_area/images/blog/271188/apexgametools00.png"></p>
<p>然而，行为树也有很多缺陷。很多人试图通过实现各种扩展来消除这些缺陷。</p>
<p>当行为树状态数量变得庞大时，每次条件遍历都需要花费大量的时间。因此，有人引入了子树方案，就是将整个行为树分割为多个嵌套的子树，每次条件遍历只需要遍历当前状态所处的子树就可以，这样可以减少遍历数量，只有满足特定条件，才能跳出子树。但是子树的存在，导致行为树在控制、异常处理方便，变得和FSM一样复杂。</p>
<h2 id="顶级的AI需要满足什么条件"><a href="#顶级的AI需要满足什么条件" class="headerlink" title="顶级的AI需要满足什么条件"></a>顶级的AI需要满足什么条件</h2><p>这需要我们重新回顾一下顶级AI的特性。</p>
<p>顶级AI需要具备更为复杂的、更深层次的、沉浸式的游戏世界的处理能力。例如在《Hitman》、《Witcher》、《Assassin’s Creed》中，NPC的数量、定制化数量、生活化的行为数量都变得越来越多。在《Call of Duty》、《The Division》中，对手的数量、以及深度的要求，可变且复杂的策略行为爆炸式的增长。静态的、脚本化的游戏设计不再适用，需要支持动态的、甚至可演化的场景来满足当下的游戏设计。</p>
<p>这依赖于易于设计的、具有复杂行为表达能力的AI机制。例如，这样的AI能够提高突发处理能力，能够应对游戏设计者未曾预料的场景，能够像人类一样表达更为复杂的行为模式。</p>
<p>以上提到AI技术显然无法处理更为庞大的数据输入。AI设计者不可能使用行为树、或状态机来表示所有可能的情况。更别说设计一套保证AI正常使用的测试用例。因此，我们需要一种更好、且更稳定的AI技术。</p>
<p>处理复杂的行为可能是AI中主要的挑战。在游戏开发中的，有很多问题是由于数据量增加、而AI处理能力不足导致的。</p>
<p>1、 技术性遗留问题 - 如果在游戏开发过程中，扩展AI的难度很大，那么后面需要修复的问题、以及所花费的时间将会暴增。<br>2、 生产效率 - 如果不能快速实现满足游戏设计方案的AI系统，那么游戏设计者无法快速原型化其思路。最终结果是游戏缺乏内容，或者内容偏向程序化、没有趣味性。<br>3、 质量 - 最终很多游戏只能放弃、或者最终只是实现无聊的智障游戏。</p>
<h2 id="一个新的AI范例"><a href="#一个新的AI范例" class="headerlink" title="一个新的AI范例"></a>一个新的AI范例</h2><p>Killzone 2 就具有非常棒的AI设计。Guerilla 游戏使用了一个AI公共系统来实现动态决策，并且展示了如何使用简单的打分系统来实现AI决策，即便是在对游戏世界不了解的情况下，该AI决策系统也能达到一个良好的效果。同样的系统已经使用在其他游戏，例如《文明》。</p>
<p>这种公共系统实现方式是，识别可选项，然后基于当前状态，对每一种选项进行打分，然后选出评分最高的选项最为决策项。这种方案具有很多优势：<br>1、设计简单 -<br>2、易于扩展 -<br>3、质量高 - </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2021/06/05/InfinitMap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2021/06/05/InfinitMap/" class="post-title-link" itemprop="url">InfinitMap</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-05 16:01:00" itemprop="dateCreated datePublished" datetime="2021-06-05T16:01:00+08:00">2021-06-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-17 19:12:22" itemprop="dateModified" datetime="2021-06-17T19:12:22+08:00">2021-06-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Gemotry/" itemprop="url" rel="index"><span itemprop="name">Gemotry</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Gemotry/Mesh/" itemprop="url" rel="index"><span itemprop="name">Mesh</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public struct MeshMapUnitCoord : IEquatable&lt;MeshMapUnitCoord&gt;</span><br><span class="line">&#123;</span><br><span class="line">	public int x;</span><br><span class="line">	public int y;</span><br><span class="line">	public int level;</span><br><span class="line">	public MeshMapUnitCoord(int x &#x3D; 0, int y &#x3D;0, int level &#x3D;0)</span><br><span class="line">	&#123;</span><br><span class="line">		this.x &#x3D; x;</span><br><span class="line">		this.y &#x3D; y;</span><br><span class="line">		this.level &#x3D; leve;</span><br><span class="line">	&#125;</span><br><span class="line">	public override string ToString()</span><br><span class="line">	&#123;</span><br><span class="line">		return string.Format(&quot;(&#123;0&#125;, &#123;1&#125;, &#123;2&#125;)&quot;, x, y,level);</span><br><span class="line">	&#125;</span><br><span class="line">	override public bool Equals(object obj)</span><br><span class="line">	&#123;</span><br><span class="line">		return obj is MeshMapUnitCoord &amp;&amp; Equals((MeshMapUnitCoord)obj);</span><br><span class="line">	&#125;</span><br><span class="line">	public bool Equals(MeshMapUnitCoord other)</span><br><span class="line">	&#123;</span><br><span class="line">		return x &#x3D;&#x3D; other.x &amp;&amp; y &#x3D;&#x3D; other.y &amp;&amp; level &#x3D;&#x3D; other.level;</span><br><span class="line">	&#125;</span><br><span class="line">	public override int GetHashCode()</span><br><span class="line">	&#123;</span><br><span class="line">		return (level&lt;&lt;35) + (y&lt;&lt;20 +x);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br></pre></td><td class="code"><pre><span class="line">public class MeshMap</span><br><span class="line">&#123;</span><br><span class="line">	public const int _tileGroupNum &#x3D; 16;</span><br><span class="line">	public const float _tileGroupLen &#x3D; 16;</span><br><span class="line">	public const float _tileUnit &#x3D; _tileGroupLen &#x2F; _tileGroupNum;</span><br><span class="line"></span><br><span class="line">	private int _maxLevel &#x3D; 1;</span><br><span class="line">	private int _level &#x3D; 0;</span><br><span class="line">	public int Level</span><br><span class="line">	&#123;</span><br><span class="line">		get&#123;return _level;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	private float _minScale &#x3D; 1;</span><br><span class="line">	private float _bounds &#x3D; 0.1f;</span><br><span class="line">	Rect _effectVisibleRegion;</span><br><span class="line">	private Vector3 _effectVisibleRegionInWorldMin;</span><br><span class="line">	private Vector3 _effectVisibleRegionInWorldMax;</span><br><span class="line">	public Vector3 _effectVisibleRegionInBaseMapMin;</span><br><span class="line">	public Vector3 _effectVisibleRegionInBaseMapMax;</span><br><span class="line">	private Vector3 _visibleAreaSize &#x3D; Vector3.zero;</span><br><span class="line">	private Vector3 _VisibleCenterPos &#x3D; Vector3.zero;</span><br><span class="line"></span><br><span class="line">	public Quaternion Rotation&#123;get;private set;&#125;</span><br><span class="line">	private float _unitLen &#x3D; _tileGroupLen;</span><br><span class="line">	private float _unitLenInWorld &#x3D; _tileGroupLen;</span><br><span class="line">	public float UnitLen&#123;get&#123;return _unitLen;&#125;&#125;</span><br><span class="line">	public float UnitLenInWorld&#123;get&#123;return _unitLenInWorld;&#125;&#125;</span><br><span class="line">	private Vector3[] _mapRegionCornor &#x3D; new Vector3[4];&#x2F;&#x2F; lt rt rb lb </span><br><span class="line"></span><br><span class="line">	private float _scale &#x3D; 1;</span><br><span class="line">	public Vector3 Scale&#123;get;private set;&#125;</span><br><span class="line">	private float _maxUnitDis &#x3D; 1;</span><br><span class="line">	private Vector3 _origionPos &#x3D; Vector3.zero;</span><br><span class="line">	public List&lt;int&gt; _visibleMeshCenterPosIndices &#x3D; new List&lt;int&gt;(400);</span><br><span class="line">	public List&lt;Vector3&gt; _visibleMeshCenterPosList &#x3D; new List&lt;Vector3&gt;(400);</span><br><span class="line">	public List&lt;int&gt; _visibleMeshOutLineVertexIndices &#x3D; new List&lt;int&gt;(400);</span><br><span class="line">	public List&lt;Vector3&gt; _visibleMeshOutlineVertexPosList &#x3D; new List&lt;Vector3&gt;(400);</span><br><span class="line">	public List&lt;MeshMapUnitCoord&gt; _visibleMeshUnitCoordList &#x3D; new List&lt;MeshMapUnitCoord&gt;(400);</span><br><span class="line">	public List&lt;Quad&gt; _visibleMeshSubQuad &#x3D; new List&lt;Quad&gt;();</span><br><span class="line">	public Quad _visibleMeshQuad &#x3D; new Quad();</span><br><span class="line"></span><br><span class="line">	private Matrix4x4 _translateMatrix &#x3D; Matrix4x4.identity;</span><br><span class="line">	private Matrix4x4 _rotateMatrix &#x3D; Matrix4x4.identity;</span><br><span class="line">	private Matrix4x4 _scaleMatrix &#x3D; Matrix4x4.identity;</span><br><span class="line">	private Matrix4x4 _localToWorldMatrix &#x3D; Matrix4x4.identity;</span><br><span class="line">	private Matrix4x4 _worldToLocalMatrix &#x3D; Matrix4x4.identity;</span><br><span class="line">	private Matrix4x4 _localToWorldMatrixWithoutRotation &#x3D; Matrix4x4.identity;</span><br><span class="line">	private Matrix4x4 _worldToLocalMatrixWithoutRotation &#x3D; Matrix4x4.identity;</span><br><span class="line"></span><br><span class="line">	private MeshMapUnitCoord _meshUnitCoord &#x3D; new MeshMapUnitCoord();</span><br><span class="line">	private Vector3[] _visibleMapAreaCornerPos &#x3D; new Vector3[4];</span><br><span class="line">	private Vector3[] _visibleAreaCornerPos &#x3D; new Vector3[4];</span><br><span class="line">	private Vector3[] _visibleAreaLineParam &#x3D; new Vector3[4];</span><br><span class="line">	private Action _onMapUpdated &#x3D; null;</span><br><span class="line"></span><br><span class="line">	Vector3 _mapReginMin &#x3D; Vector3.zero;</span><br><span class="line">	Vector3 _mapReginMax &#x3D; Vector3.zero;</span><br><span class="line">	private Vector3 _mapVisibleReginMinCornor;</span><br><span class="line">	private Vector3 _mapVisibleReginMaxCornor;</span><br><span class="line">	public event Action OnMapUpdatae&#123;</span><br><span class="line">		add &#123;_onMapUpdated +&#x3D; value;&#125;</span><br><span class="line">		remove (_onMapUpdated -&#x3D; value;)</span><br><span class="line">	&#125;</span><br><span class="line">	public MeshMap(Rect mapRegin)</span><br><span class="line">	&#123;</span><br><span class="line">		SetMapValidArea(mapRegin.min, mapRegin.max);</span><br><span class="line">		SetUnitLen(_tileGroupLen);</span><br><span class="line">	&#125;</span><br><span class="line">	public void SetMapValidArea(Vector2 min, Vector2 max)</span><br><span class="line">	&#123;</span><br><span class="line">		_mapReginMin &#x3D; new Vector3(min.x, 0, min.y);</span><br><span class="line">		_mapReginMax &#x3D; new Vector3(max.x, 0, max.y);</span><br><span class="line">		Rect rect &#x3D; new Rect(min.x, min.y, max.x - min.x, max.y - min.y);</span><br><span class="line">		_mapRegionCornor[0] &#x3D; new Vector3(rect.min.x, 0, rect.max.y);</span><br><span class="line">		_mapRegionCornor[1] &#x3D; new Vector3(rect.max.x, 0, rect.max.y);</span><br><span class="line">		_mapRegionCornor[2] &#x3D; new Vector3(rect.max.x, 0, rect.min.y);</span><br><span class="line">		_mapRegionCornor[3] &#x3D; new Vector3(rect.min.x, 0, rect.min.y);</span><br><span class="line">		SetMinScale();</span><br><span class="line">	&#125;</span><br><span class="line">	public bool IncludedInMapArea(Vector2 mapPos)</span><br><span class="line">	&#123;</span><br><span class="line">		Vector3 pos &#x3D; new Vector3(mapPos.x, 0, mapPos.y);</span><br><span class="line">		pos &#x3D; CvtLocalToWorldPos(pos);</span><br><span class="line">		pos &#x3D; _worldToLocalMatrixWithoutRotation.MultiplyPoint3x4(pos);</span><br><span class="line">		if(pos.x&lt;_mapReginMin.x) return false;</span><br><span class="line">		if(pos.y &lt; _mapReginMin.y) return false;</span><br><span class="line">		if(pos.x &gt; _mapReginMax.x) return false;</span><br><span class="line">		if(pos.y &gt; _mapReginMax.y) return false;</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line">	public void SetMinScale()</span><br><span class="line">	&#123;</span><br><span class="line">		float scale &#x3D; _effectVisibleRegin.width &#x2F; (_MapReginMax.m - _mapReginMin.x);</span><br><span class="line">		float b &#x3D; _effectVisibleRegin.height &#x2F; (_mapReginMax.z - _mapReginMin.z);</span><br><span class="line">		scale &#x3D; Mathf.Max(scale, b);</span><br><span class="line">		scale *&#x3D; 1.1f;</span><br><span class="line">		_minScale &#x3D; scale;</span><br><span class="line">		_maxLevel &#x3D; Mathf.CeilToInt(Mathf.Log(_minScale, 0.5f));</span><br><span class="line">	&#125;</span><br><span class="line">	void SetUnitLen(float len, bool needUpdate &#x3D; false)</span><br><span class="line">	&#123;</span><br><span class="line">		len &#x3D; Mathf.Abs(len);</span><br><span class="line">		_unitLen &#x3D; len;</span><br><span class="line">		_maxUnitDis &#x3D; 1 * _unitLen * _sacle;</span><br><span class="line">		_unitLenInWorld &#x3D; _unitLen * _scale;</span><br><span class="line">		if(needUpdate) CalcualteVisibleGrid();</span><br><span class="line">	&#125;</span><br><span class="line">	public void SetMapRotationalAngle(float angle, bool needUpdate &#x3D; false)</span><br><span class="line">	&#123;</span><br><span class="line">		Rotation &#x3D; Quaternion.Euler(0, angle, 0);</span><br><span class="line">		_rotateMatrix &#x3D; Matrix4x4.Rotate(Rotation);</span><br><span class="line">		UpdateMatrix();</span><br><span class="line">		if(needUpdate) CalcualteVisibleGrid();</span><br><span class="line">	&#125;</span><br><span class="line">	public void SetOriginPosition(Vector3 pos, bool needUpdate &#x3D; false)</span><br><span class="line">	&#123;</span><br><span class="line">		_originPos &#x3D; CorrectMapOriginPos(pos);</span><br><span class="line">		_translateMatrix &#x3D; matrix4x4.Translate(_originPos);</span><br><span class="line">		UpdateMatrix();</span><br><span class="line">		if(needUpdate) CalcualteVisibleGrid();</span><br><span class="line">	&#125;</span><br><span class="line">	Vector3 CorrectMapOriginPos(Vector3 origion)</span><br><span class="line">	&#123;</span><br><span class="line">		_localToWorldMatrixWithoutRotation &#x3D; Matrix4x4.Translate(origin) * _scaleMatrix;</span><br><span class="line">		_worldToLocalMatrixWithoutRotation &#x3D; _localToWorldMatrixWithoutRotation.inverse;</span><br><span class="line">		Vector3 max &#x3D; _localToWorldMatrixWithoutRotation.MultiplyPoint3x4(_mapReginMax);</span><br><span class="line">		Vector3 min &#x3D; _localToWorldMatrixWithoutRotation.MultiplyPoint3x4(_mapReginMin);</span><br><span class="line">		Vector3 center &#x3D; (max + min)&#x2F;2;</span><br><span class="line">		if(_effectVisibleRegin.max.x - _effectVisibleRegin.min.x &lt; max.x - min.x)</span><br><span class="line">		&#123;</span><br><span class="line">			if(_effectVisibleRegin.max.x &gt; max.x)&#123;</span><br><span class="line">				origin.x +&#x3D; _effectVisibleRegin.max.x - max.x;</span><br><span class="line">			&#125;</span><br><span class="line">			if(_effectVisibleRegin.min.x &lt; min.x)</span><br><span class="line">			&#123;</span><br><span class="line">				origin.x +&#x3D; _effectVisibleRegin.min.x - min.x;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		else</span><br><span class="line">		&#123;</span><br><span class="line">			origion.x +&#x3D; _effectVisibleRegin.center.x - center.x;</span><br><span class="line">		&#125;</span><br><span class="line">		if(_effectVisibleRegin.max.y - _effectVisibleRegin.min.y &lt; max.z - min.z)</span><br><span class="line">		&#123;</span><br><span class="line">			if(_effectVisibleRegin.max.y &gt; max.z)</span><br><span class="line">			&#123;</span><br><span class="line">				origin.z +&#x3D; _effectVisibleRegin.max.y - max.z;</span><br><span class="line">			&#125;</span><br><span class="line">			else if(_effectVisibleRegin.min.y &lt; min.z)</span><br><span class="line">			&#123;</span><br><span class="line">				origin.z +&#x3D; _effectVisibleRegin.min.y -min.z;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		else</span><br><span class="line">		&#123;</span><br><span class="line">			origin.z +&#x3D; _effectVisibleRegin.center.y - center.z;</span><br><span class="line">		&#125;</span><br><span class="line">		_localToWorldMatrixWithoutRotation &#x3D; Matrix4x4.Translate(origin) * _scaleMatrix;</span><br><span class="line">		_worldToLocalMatrixWithoutRotation &#x3D; _localToWorldMatrixWithoutRotation.inverse;</span><br><span class="line"></span><br><span class="line">		_effectVisibleReginInBaseMapMin &#x3D; worldToLocalMatrixWithoutRotation.MultiplyPoint3x4(_effectVisibleReginInWorldMin);</span><br><span class="line">		_effectVisibleReginInBaseMapMax &#x3D; worldToLocalMatrixWithoutRotation.MultiplyPoint3x4(_effectVisibleReginInWorldMax);</span><br><span class="line">		return origin;</span><br><span class="line">	&#125;</span><br><span class="line">	public float SetScale(float scale, bool needUpdate &#x3D; false)</span><br><span class="line">	&#123;</span><br><span class="line">		scale &#x3D; Mathf.Abs(scale);</span><br><span class="line">		scale &#x3D; Mathf.Clamp(scale, _minScale, 1+0.1f);</span><br><span class="line">		_scale &#x3D; scale;</span><br><span class="line">		Scale &#x3D; new Vector3(scale, scale, scale);</span><br><span class="line">		_scaleMatrix &#x3D; Matrix4x4.Scale(Vector3.one * scale);</span><br><span class="line">		_level &#x3D; Mathf.CeilToInt(Mathf.Log(scale, 0.5f));</span><br><span class="line">		float unit &#x3D; Mathf.Pow(2, _level);;</span><br><span class="line">		float unitLenInWorld &#x3D; unit * _scale;</span><br><span class="line">		if(unitLenInWorld &gt; 1.5f)</span><br><span class="line">		&#123;</span><br><span class="line">			--_level;</span><br><span class="line">			_level &#x3D; Mathf.Clamp(_level, 0, _maxLevel);</span><br><span class="line">			unit &#x3D; mathf.Pow(2, _level);</span><br><span class="line">		&#125;</span><br><span class="line">		else if(unitLenInWorld&lt;0.75f)</span><br><span class="line">		&#123;</span><br><span class="line">			++_level;</span><br><span class="line">			_level &#x3D; Mathf.Clamp(_level, 0, _maxLevel);</span><br><span class="line">			unit &#x3D; Mathf.Pow(2, _level);</span><br><span class="line">		&#125;</span><br><span class="line">		SetUnitLen(unit * _tileGroupLen);</span><br><span class="line">		UpdateMatrix();</span><br><span class="line">		if(needUpdate) CalcualteVisibleGrid();</span><br><span class="line">		return _scale;</span><br><span class="line">	&#125;</span><br><span class="line">	public Vector3 GetOriginPos()</span><br><span class="line">	&#123;</span><br><span class="line">		return _originPos;</span><br><span class="line">	&#125;</span><br><span class="line">	public Vector3 SetViewAreaInZeroPanel(Vector3[] posList)</span><br><span class="line">	&#123;</span><br><span class="line">		CalculateEffectVisibleSize(posList);</span><br><span class="line">		_visibleCenterPos &#x3D; Vector3.zero;</span><br><span class="line">		Vector3 min &#x3D; Vector3.positiveInfinity;</span><br><span class="line">		Vector3 max &#x3D; Vector3.negativeInfinity;</span><br><span class="line">		float(int i&#x3D;0;i&lt;4;++i)</span><br><span class="line">		&#123;</span><br><span class="line">			Vector3 pos &#x3D; posList[i];</span><br><span class="line">			_visibleAreaCornerPos[i] &#x3D; pos;</span><br><span class="line">			_visibleAreaLineParam[i] &#x3D; GetLineParam(pos, posList[(i+1)%4]);</span><br><span class="line">			_visibleCenterPos +&#x3D; pos;</span><br><span class="line">			min.x &#x3D; min.x &lt; pos.x ? min.x : pos.x;</span><br><span class="line">			min.y &#x3D; min.y &lt; pos.y ? min.y : pos.y;</span><br><span class="line">			min.z &#x3D; min.z &lt; pos.z ? min.z : pos.z;</span><br><span class="line">			max.x &#x3D; max.x &gt; pos.x ? max.x : pos.x;</span><br><span class="line">			max.y &#x3D; max.y &gt; pos.y ? max.y : pos.y;</span><br><span class="line">			max.z &#x3D; max.z &gt; pos.z ? max.z : pos.z;</span><br><span class="line">		&#125;</span><br><span class="line">		_visibleAreaSize &#x3D; max - min;</span><br><span class="line">		_visibleCenterPos &#x2F;&#x3D; 4;</span><br><span class="line">		return _visibleCenterPos;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	void CalculateEffectVisibleSize(Vector3[] polList)</span><br><span class="line">	&#123;</span><br><span class="line">		_effectVisibleRegin.min &#x3D; new Vector2(posList[3].x, posList[3].z);</span><br><span class="line">		_effectVisibleRegin.max &#x3D; new Vector2(posList[2].x, posList[1].z);</span><br><span class="line">		_effectVisibleReginInWorldMin &#x3D; new Vector3(PosList[0].x, _originPos.y, posList[3].z);</span><br><span class="line">		_effectVisibleReginInWorldMax &#x3D; new Vector3(PosList[1].x, _originPos.y, posList[1].z);</span><br><span class="line"></span><br><span class="line">		_visibleMapAreaCornerPos[0] &#x3D; PosList[0];</span><br><span class="line">		_visibleMapAreaCornerPos[1] &#x3D; PosList[1];</span><br><span class="line">		_visibleMapAreaCornerPos[2] &#x3D; PosList[2];</span><br><span class="line">		_visibleMapAreaCornerPos[3] &#x3D; PosList[3];</span><br><span class="line">		SetMinScale();</span><br><span class="line">	&#125;</span><br><span class="line">	public Static Vector3 GetLineParam(Vector3 point1, Vector3 point2)</span><br><span class="line">	&#123;</span><br><span class="line">		Vector3 param &#x3D; Vector3.Cross(Vector3.up, point1 - point2);</span><br><span class="line">		param.y &#x3D; param.z;</span><br><span class="line">		param.z &#x3D; -point1.x * param.x - point1.z * param.y;</span><br><span class="line">		param &#x2F;&#x3D; Mathf.Sqrt(param.x * param.x + param.y * param.y);</span><br><span class="line">		return param;</span><br><span class="line">	&#125;</span><br><span class="line">	public Static Vector2 FloorGridPos(Vector2 mapPos)</span><br><span class="line">	&#123;</span><br><span class="line">		mapPos.x &#x3D; Mathf.Floor(mapPos.x &#x2F; _tileUnit) * _tileUnit;</span><br><span class="line">		mapPos.y &#x3D; Mathf.Floor(mapPos.y &#x2F; _tileUnit) * _tileUnit;</span><br><span class="line">		return mapPos;</span><br><span class="line">	&#125;</span><br><span class="line">	public void BindLocalPosToWorld(Vector3 localPos, Vector3 worldPos, bool needUpdate &#x3D; false)</span><br><span class="line">	&#123;</span><br><span class="line">		Vector3 offset &#x3D; worldPos - CvtLocalToWorldPos(lcoalPos);</span><br><span class="line">		SetOriginPosition(_originPos + offset, needUpdate);</span><br><span class="line">	&#125;</span><br><span class="line">	public Vector3 CvtLocalToWorldPos(Vector3 lcoalPos)</span><br><span class="line">	&#123;</span><br><span class="line">		return _localToWorldMatrix.MultiplyPoint3x4(localPos);</span><br><span class="line">	&#125;</span><br><span class="line">	public Vector3 CvtWorldToLocalPos(Vector3 worldPos)</span><br><span class="line">	&#123;</span><br><span class="line">		return _worldToLocalMatrix.MultiplyPoint3x4(worldPos);</span><br><span class="line">	&#125;</span><br><span class="line">	float tilePovitOffset &#x3D; 0; &#x2F;&#x2F;[0-1]</span><br><span class="line">	public MeshMapUnitCoord PickMeshUnitCoord(Vector3 woldPos)</span><br><span class="line">	&#123;</span><br><span class="line">		worldPos.y &#x3D; 0;</span><br><span class="line">		Vector3 posInMeshMap &#x3D; _worldToLocalMatrix.MultiplyPoint3x4(worldPos);</span><br><span class="line">		int x &#x3D; Mathf.FloorToInt(posInMeshMap.z &#x2F; _unitLen + tilePovitOffset);</span><br><span class="line">		int y &#x3D; Mathf.FloorToInt(posInMeshMap.x &#x2F; _unitLen + tilePovitOffset);</span><br><span class="line">		return new MeshMapUnitCoord(x, y, _level);</span><br><span class="line">	&#125;</span><br><span class="line">	public Vector3 RayCastMeshMapPos(Vector3 origin, Vector3 dir)</span><br><span class="line">	&#123;</span><br><span class="line">		Vector3 centerPos &#x3D; Vector3.zero;</span><br><span class="line">		float t &#x3D; (_origionPos.y - origion.y)&#x2F;dir.y;</span><br><span class="line">		centerPos &#x3D; origion + t* dir;</span><br><span class="line">		centerPos.y &#x3D; _origionPos.y;</span><br><span class="line">		return centerPos;</span><br><span class="line">	&#125;</span><br><span class="line">	void UpdateMatrix()</span><br><span class="line">	&#123;</span><br><span class="line">		_lcoalToWorldMatrix &#x3D; _translateMatrix * rotateMatrix * _scaleMatrix;</span><br><span class="line">		_worldToLocalMatrix &#x3D; _localToWorldMatrix.inverse;</span><br><span class="line">	&#125;</span><br><span class="line">	public Rect _visibleGridRigion &#123;get;private set;&#125;</span><br><span class="line">	Vector3[] cornerPos &#x3D; new Vector3[4];</span><br><span class="line">	public void CalcualteVisibleGrid()</span><br><span class="line">	&#123;</span><br><span class="line">		_visibleMeshQuad &#x3D; new Quad(Vector2.positiveInfinity, Vector2.negativeInfinity);</span><br><span class="line">		_visibleMeshSubQuad.Clear();</span><br><span class="line">		_visibleMeshCenterPosList.Clear();</span><br><span class="line">		_visibleMeshCenterPosIndices.Clear();</span><br><span class="line">		_visibleMeshOutlineVertexIndices.Clear();</span><br><span class="line">		_visibleMeshOutlineVertexPosList.Clear();</span><br><span class="line">		_visibleMeshUnitCoordList.Clear();</span><br><span class="line">		CalcCenterMeshUnitCoord();</span><br><span class="line">		float radius &#x3D; Mathf.Sqrt(_visibleAreaSzie.x * _visibleAreaSzie.x + _visibleAreaSize.z * _visibleAreaSize.z)&#x2F;2;</span><br><span class="line">		float unitLenInWorld &#x3D; _unitLen * _scale;</span><br><span class="line">		int halfCount &#x3D; Mathf.CeilToInt(radius &#x2F; unitLenInWorld) + 1;</span><br><span class="line">		float yStart &#x3D; (-halfCount + _meshUnitCoord.y) * _unitLen;</span><br><span class="line">		int outlineIndicesCount &#x3D; 0;</span><br><span class="line">		int centerIndicesCount &#x3D;0;</span><br><span class="line">		Vector3 centerOffset &#x3D; new Vector3(_unitLen *(0.5f - tilePovitOffset), 0, _unitLen * (0.5f - tilePovitOffset));</span><br><span class="line">		_visibleGridRigion &#x3D; new Rect((-halfCount + _meshUnitCoord.x) * _unitLen,</span><br><span class="line">			(-halfCount + _meshUnitCoord.y) * _unitLen,</span><br><span class="line">				halfCount * _unitLen * 2, halfCount * _unitLen * 2);</span><br><span class="line">		for(int j &#x3D; -halfCount + _meshUnitCoord.y; j&lt;&#x3D; halfCount + _meshUnitCoord.y; ++j)</span><br><span class="line">		&#123;</span><br><span class="line">			float xStart &#x3D;(-halfCount + _meshUnitCoord.x) * _unitLen;</span><br><span class="line">			for(int i&#x3D;-halfCount + _meshUnitCoord.x; i&lt;&#x3D;halfCount+_meshUnitCoord.x; ++i)</span><br><span class="line">			&#123;</span><br><span class="line">				Vector3 posOnMesh &#x3D; new Vector3(xStart, 0, yStart);</span><br><span class="line">				xStart +&#x3D; _unitLen;</span><br><span class="line"></span><br><span class="line">				Vector3 posOnWorld &#x3D; _localToWorldMatrix.MultiplyPoint3x4(posOnMesh + centerOffset);</span><br><span class="line">				if(!MeshIsVisible(posOnWorld)) continue;</span><br><span class="line"></span><br><span class="line">				Quad quad &#x3D; new Quad();</span><br><span class="line">				quad.MinX &#x3D; posOnMesh.x - _unitLen * tilePovitOffset;</span><br><span class="line">				quad.MinY &#x3D; posOnMesh.z - _unitLen * tilePovitOffset;</span><br><span class="line">				quad.MaxX &#x3D; quad.MinX + _unitLen;</span><br><span class="line">				quad.MaxY &#x3D; quad.MinY + _unitLen;</span><br><span class="line">				_visibleMeshSubQuad.Add(quad);</span><br><span class="line">				_visibleMeshQuad.Include(ref quad);</span><br><span class="line">				_visibleMeshCenterPosList.Add(posOnWorld);</span><br><span class="line">				_visibleMeshCenterPosIndices.Add(centerIndicesCount++);</span><br><span class="line">				_visibleMeshUnitCoordList.Add(new MeshMapUnitCoord(i,j,_level));</span><br><span class="line"></span><br><span class="line">				cornerPos[0] &#x3D; new Vector3(posOnMesh.x - _unitLen * tilePovitOffset, posOnMesh.y, posOnMesh.z - _unitLen * tilePovitOffset);</span><br><span class="line">				cornerPos[1] &#x3D; cornerPos[0] + new Vector3(_unitLen, 0,0);</span><br><span class="line">				cornerPos[2] &#x3D; cornerPos[1] + new Vector3(0,0, _unitLen);</span><br><span class="line">				cornerPos[3] &#x3D; cornerPos[2] + new Vector3(-_unitLen, 0,0);</span><br><span class="line"></span><br><span class="line">				_visibleMeshOutlineVertexIndices.Add(outlineIndicesCount++);</span><br><span class="line">				_visibleMeshOutlineVertexPosList.Add(cornerPos[0]);</span><br><span class="line">				_visibleMeshOutlineVertexIndices.Add(outlineIndicesCount++);</span><br><span class="line">				_visibleMeshOutlineVertexPosList.Add(cornerPos[3]);</span><br><span class="line">				_visibleMeshOutlineVertexIndices.Add(outlineIndicesCount++);</span><br><span class="line">				_visibleMeshOutlineVertexPosList.Add(cornerPos[3]);</span><br><span class="line">				_visibleMeshOutlineVertexIndices.Add(outlineIndicesCount++);</span><br><span class="line">				_visibleMeshOutlineVertexPosList.Add(cornerPos[2]);</span><br><span class="line">			&#125;</span><br><span class="line">			yStart +&#x3D; _unitLen;</span><br><span class="line">		&#125;</span><br><span class="line">		_onMapUpdated?.Invoke();</span><br><span class="line">	&#125;</span><br><span class="line">	bool MeshIsVisible(Vector3 pos)</span><br><span class="line">	&#123;</span><br><span class="line">		float distance &#x3D; 0;</span><br><span class="line">		Vector3 param;</span><br><span class="line">		for(int i&#x3D;0;i&lt;4;++i&gt;)</span><br><span class="line">		&#123;</span><br><span class="line">			param &#x3D; _visibleAreaLineParam[i];</span><br><span class="line">			distance &#x3D; param.x * pos.x + param.y * pos.z + param.z;</span><br><span class="line">			if(distance &gt; _maxUnitDis) return false;</span><br><span class="line">		&#125;</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line">	void CalcCenterMeshUnitCoord()</span><br><span class="line">	&#123;</span><br><span class="line">		_meshUnitCoord &#x3D; PickMeshUnitCoord(_visibleCenterPos, false);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2021/06/05/InfinitMap1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2021/06/05/InfinitMap1/" class="post-title-link" itemprop="url">InfinitMap 1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-05 16:01:00" itemprop="dateCreated datePublished" datetime="2021-06-05T16:01:00+08:00">2021-06-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-17 19:12:22" itemprop="dateModified" datetime="2021-06-17T19:12:22+08:00">2021-06-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Gemotry/" itemprop="url" rel="index"><span itemprop="name">Gemotry</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Gemotry/Mesh/" itemprop="url" rel="index"><span itemprop="name">Mesh</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line">public class Map : IDity</span><br><span class="line">&#123;</span><br><span class="line">	WorldMapDataHandle worldMapData;</span><br><span class="line">	MeshMap mapGrid;</span><br><span class="line">	MapPathGenerator pathGenerator;</span><br><span class="line">	bool dirty &#x3D; false;</span><br><span class="line">	public void SetDirty()</span><br><span class="line">	&#123;</span><br><span class="line">		dirty &#x3D; true;</span><br><span class="line">	&#125;</span><br><span class="line">	public void ClearData()</span><br><span class="line">	&#123;</span><br><span class="line">		worldMapData.worldData.Clear();</span><br><span class="line">		SetDirty();</span><br><span class="line">	&#125;</span><br><span class="line">	public event Action&lt;Transform, Vector3, Vector3&gt; UpdateBaseMapLayer;</span><br><span class="line">	public event Action&lt;Rect, float, int&gt; UpdateGridMeshLayer;</span><br><span class="line">	public event Action&lt;List&lt;Vector3&gt;, List&lt;int&gt;&gt; UpdateGridLayer;</span><br><span class="line">	public event Action&lt;Transform, Dictionary&lt;int, List&lt;TileData&gt;&gt;&gt; UpdateOverlayDataLayer;</span><br><span class="line">	Rect edge &#x3D; new Rect(float.NegativeInfinity, float.NegativeInfinity, float.PositiveInfinity, float.PositiveInfinity);</span><br><span class="line">	Camera camera;</span><br><span class="line">	float zoomSpeed &#x3D; 400;</span><br><span class="line">	public Transform rootTransform &#123;get; private set;&#125;</span><br><span class="line">	Transform baseMapLayerRoot &#x3D; null;</span><br><span class="line">	Transform overlayMapLayerRoot &#x3D; null;</span><br><span class="line">	float gridAngle &#x3D; 45;</span><br><span class="line">	float cameraHeight &#x3D; 30;</span><br><span class="line">	float cameraPitchAngle &#x3D; 70;</span><br><span class="line">	Vector3[] viewPortCorner;</span><br><span class="line">	public void SetMapEdge(Rect edge)</span><br><span class="line">	&#123;</span><br><span class="line">		this.edge &#x3D; edge;</span><br><span class="line">	&#125;</span><br><span class="line">	public void SetZoomSpeed(float zoomSpeed)</span><br><span class="line">	&#123;</span><br><span class="line">		this.zoomSpeed &#x3D; zoomSpeed;</span><br><span class="line">	&#125;</span><br><span class="line">	public void SetRootTransform(Transform rootTransform)</span><br><span class="line">	&#123;</span><br><span class="line">		this.rootTransform &#x3D; rootTransform;</span><br><span class="line">	&#125;</span><br><span class="line">	public void SetGridAngle(float angle)</span><br><span class="line">	&#123;</span><br><span class="line">		gridAngle &#x3D; Mathf.Clamp(angle, 0, 45);</span><br><span class="line">	&#125;</span><br><span class="line">	public Void SetCameraHeight(float height)</span><br><span class="line">	&#123;</span><br><span class="line">		cameraHeight &#x3D; height;</span><br><span class="line">	&#125;</span><br><span class="line">	public void SetCameraPitchAngle(float angle)</span><br><span class="line">	&#123;</span><br><span class="line">		cameraPitchAngle &#x3D; Mathf.Clamp(angle, 60, 90);</span><br><span class="line">	&#125;</span><br><span class="line">	void InitRootTransform()</span><br><span class="line">	&#123;</span><br><span class="line">		if(rootTransform &#x3D;&#x3D; null)</span><br><span class="line">			rootTransform &#x3D; new GameObject(&quot;mapRoot&quot;).transform;</span><br><span class="line">		baseMapLayerRoot &#x3D; new GameObject(&quot;baseMapLayer&quot;).transform;</span><br><span class="line">		overlayMapLayerRoot &#x3D; new GameObject(&quot;overlayMapLayer&quot;).transform;</span><br><span class="line">		baseMapLayerRoot.SetParent(rootTransform);</span><br><span class="line">		overlayMapLayerRoot.SetParent(rootTransform);</span><br><span class="line">		rootTransform.rotation &#x3D; Quaternion.Euler(0, gridAngle, 0);</span><br><span class="line">		baseMapLayerRoot.localPosition &#x3D; Vector3.zero;</span><br><span class="line">		baseMapLayerRoot.localRotation &#x3D; Quaternion.Euler(0, -gridAngle, 0);</span><br><span class="line">		baseMapLayerRoot.localScale &#x3D; Vector3.one;</span><br><span class="line">		overlayMapLayerRoot.localPosition &#x3D; Vector3.zero;</span><br><span class="line">		overlayMapLayerRoot.localRotation &#x3D; Quaternion.Euler(0,0,0);</span><br><span class="line">		OverlayMapLayerRoot.localScale &#x3D; Vector3.one;</span><br><span class="line">	&#125;</span><br><span class="line">	void InitCamera(Camera camera)</span><br><span class="line">	&#123;</span><br><span class="line">		this.camera &#x3D; camera;</span><br><span class="line">		camera.transform.position &#x3D; new Vector3(0,cameraHeight, 0);</span><br><span class="line">		camera.transform.rotation &#x3D; Quaterion.Euler(cameraPitchAngle, 0,0);</span><br><span class="line">		viewPortCorner &#x3D; CalcualteViewAreaInZeroPanel();</span><br><span class="line">	&#125;</span><br><span class="line">	void InitGridMesh()</span><br><span class="line">	&#123;</span><br><span class="line">		mapGrid &#x3D; new MeshMap(edge);</span><br><span class="line">		mapGrid.SetMapRotationAngle(gridAngle);</span><br><span class="line">		mapGrid.SetViewAreaInZeroPanel(viewPoreCorner);</span><br><span class="line">	&#125;</span><br><span class="line">	public void Init(Camera camera)</span><br><span class="line">	&#123;</span><br><span class="line">		InitRootTransform();</span><br><span class="line">		InitCamera(camera);</span><br><span class="line">		InitGridMesh();</span><br><span class="line">		worldMapData &#x3D; new WorldMapDataHandel(this);</span><br><span class="line">		pathGenerator &#x3D; new MapPathGenerator();</span><br><span class="line">	&#125;</span><br><span class="line">	Dictionary&lt;int, List&lt;TileData&gt;&gt; tileDataTempList &#x3D; new Dictionary&lt;int, List&lt;TileData&gt;&gt;();</span><br><span class="line">	public bool FindTile(Vector3 mapPos, out Dictionary&lt;int, List&lt;TileData&gt;&gt; tileDatas, uint layerMask)</span><br><span class="line">	&#123;</span><br><span class="line">		var rst &#x3D; worldMapData.SearchTile(mapPos, ref tileDataTempList, layerMask);</span><br><span class="line">		tileDatas &#x3D; tileDataTempList;</span><br><span class="line">		return rst;</span><br><span class="line">	&#125;</span><br><span class="line">	public bool FindTile(Quad region, out Dictionary&lt;int, List&lt;TileData&gt;&gt; tileDatas, uint layerMask)</span><br><span class="line">	&#123;</span><br><span class="line">		var rst &#x3D; worldMapData.SearchTile(region, ref tileDataTempList, layerMask);</span><br><span class="line">		tileDatas &#x3D; tileDataTempList;</span><br><span class="line">		return rst;</span><br><span class="line">	&#125;</span><br><span class="line">	public void AddTile(TileData tile)</span><br><span class="line">	&#123;</span><br><span class="line">		worldMapData.AddTile(tile);</span><br><span class="line">	&#125;</span><br><span class="line">	public RemoveTile(TileData tile)</span><br><span class="line">	&#123;</span><br><span class="line">		worldMapData.RemoveTile(tile);</span><br><span class="line">	&#125;</span><br><span class="line">	public bool IncludedInMapArea(vector3 mapPos)</span><br><span class="line">	&#123;</span><br><span class="line">		return mapGrid.IncludedInMapArea(mapPos);</span><br><span class="line">	&#125;</span><br><span class="line">	public void MoveTile(TileData tile, Vector2 endPos, float speed)</span><br><span class="line">	&#123;</span><br><span class="line">		if(pathGenerator.TryGetPath(tile.position, endPos, out var posList))</span><br><span class="line">		&#123;</span><br><span class="line">			worldMapData.MoveTile(tile, posList, speed);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	Vector3 selectedMapPos &#x3D; Vector3.zero;</span><br><span class="line">	Vector3 selectedUnityPos &#x3D; Vector3.zero;</span><br><span class="line">	float seledValue &#x3D; 1;</span><br><span class="line">	public Dictionary&lt;int, List&lt;TileData&gt;&gt; visibleTileData &#x3D; new Dictionary&lt;int, List&lt;TileData&gt;&gt;();</span><br><span class="line">	public void UpdateMapScale(float scale)</span><br><span class="line">	&#123;</span><br><span class="line">		this.scaleValue &#x3D; scale;</span><br><span class="line">		SetDirty();</span><br><span class="line">	&#125;</span><br><span class="line">	public void UpdateZoomScale(float detal)</span><br><span class="line">	&#123;</span><br><span class="line">		this.scaledValue &#x3D; (detal * zoomSpeed + 1) * scaledValue;</span><br><span class="line">		SetDirty();</span><br><span class="line">	&#125;</span><br><span class="line">	public void UpdateScreenMapCombinedPos(Vector2 screenPos, Vector3 mapPos)</span><br><span class="line">	&#123;</span><br><span class="line">		selectedMapPos &#x3D; mapPos;</span><br><span class="line">		selectedUnityPos &#x3D; screenPos;</span><br><span class="line">		selectedUnityPos &#x3D; ConvertScreen2UnityPos(screenPos);</span><br><span class="line">		SetDirty();</span><br><span class="line">	&#125;</span><br><span class="line">	public void UpdateMap()</span><br><span class="line">	&#123;</span><br><span class="line">		if(!dirty) return;</span><br><span class="line">		dirty &#x3D; false;</span><br><span class="line">		scaledValue &#x3D; mapGrid.SetScale(scaledValue);</span><br><span class="line">		mapGrid.BindLocalPosToWorld(selectedMapPos, selectedUnityPos);</span><br><span class="line">		mapGrid.CalculateVisibleGrid();</span><br><span class="line">		rootTransform.position &#x3D; mapGrid.GetOrigionPos();</span><br><span class="line">		rootTransform.rotation &#x3D; mapGrid.Rotation;</span><br><span class="line">		rootTransform.localScale &#x3D; mapGrid.Scale;</span><br><span class="line">		UpdateBaseMapLayer?.Invoke(baseMapLayerRoot, mapGrid._effectVisibleReginInBaseMapMin, mapGrid._effectVisibleReginInBaseMapMax);</span><br><span class="line">		Rect rect &#x3D; new Rect();</span><br><span class="line">		if(mapGrid.Level &#x3D;&#x3D; 0)</span><br><span class="line">			rect &#x3D; mapGrid._visibleGridRegion;</span><br><span class="line">		UPdateGridMeshLayer?.Invoke(rect, mapGrid.UnitLen, MeshMap._tileGroupNum);</span><br><span class="line">		UpdateGridLayer?.Invoke(mapGrid._visibleMeshOutlineVertexPosList, mapGrid._visibleMeshOutlineVertexIndices);</span><br><span class="line"></span><br><span class="line">		worldMapData.SearchTile(mapGrid._visibleMeshSubQuad, ref visibleTileData);</span><br><span class="line">		UpdateOverlayDataLayer?.Invoke(overlayMapLayerRoot, visibleTileData);</span><br><span class="line">	&#125;</span><br><span class="line">	public Vector3 ConvertScreen2MapPos(vector3 screenPos)</span><br><span class="line">	&#123;</span><br><span class="line">		return mapGrid.CvtWorldToLocalPos(ConvertScreen2UnityPos(screenPos));</span><br><span class="line">	&#125;</span><br><span class="line">	public Vector3 ConvertMap2ScreenPos(Vector3 mapPos)</span><br><span class="line">	&#123;</span><br><span class="line">		return ConvertUnity2ScreenPos(mapGrid.CvtLocalToWorldPos(mapPos));</span><br><span class="line">	&#125;</span><br><span class="line">	public Vector3 ConvertScreen2UnityPos(Vector3 screen)</span><br><span class="line">	&#123;</span><br><span class="line">		Ray ray &#x3D; camera.ScreenPointToRay(screen);</span><br><span class="line">		raturn RayCastUnityPosInZeroPanel(ray.origion, ray.direction);</span><br><span class="line">	&#125;</span><br><span class="line">	public Vector3 ConvertUnity2ScreenPos(Vecotr3 unityPos)</span><br><span class="line">	&#123;</span><br><span class="line">		return camera.WorldToScreenPos(unityPos);</span><br><span class="line">	&#125;</span><br><span class="line">	public Vector3[] CalcualteViewAraInZeroPanle()</span><br><span class="line">	&#123;</span><br><span class="line">		Vector3[] viewPortCorner &#x3D; new Vector3[4];</span><br><span class="line">		Vector3[] camraeNearPanelCorner &#x3D; new Vector3[4];</span><br><span class="line">		Vector3[] cameraFarPanelCorner &#x3D; new Vector3[4];</span><br><span class="line">		if(camera.othographic)</span><br><span class="line">		&#123;</span><br><span class="line">			float halfWidth &#x3D; aspect * camera.orthographicSize;</span><br><span class="line">			cameraNearPanelCorner[0] &#x3D; camera.transform.TransformPoint(new Vector3(-halfWidth, camera.orthographicSize, camera.nearClipPlane));</span><br><span class="line">			cameraNearPanelCorner[1] &#x3D; camera.transform.TransformPoint(new Vector3(halfWidth, camera.orthographicSize, camera.nearClipPlane));</span><br><span class="line">			cameraNearPanleCorner[2] &#x3D; camera.transform.TransformPoint(new Vector3(halfWidth, -camera.othergraphicSize, camera.nearClipPlane));</span><br><span class="line">			cameraNearPanelCorner[3] &#x3D; camera.transform.TransformPoint(new Vector3(-halfWidth, -camera.orthergraphicSize, camera.nearClipPlane));</span><br><span class="line"></span><br><span class="line">			cameraFarPanelCorner[0] &#x3D; camera.transform.TransformPoint(new Vector3(-halfWidth, camera.orthographicSize, camera.farClipPlane));</span><br><span class="line">			cameraFarPanelCorner[1] &#x3D; camera.transform.TransformPoint(new Vector3(halfWidth, camera.orthographicSize, camera.farClipPlane));</span><br><span class="line">			cameraFarPanelCorner[2] &#x3D; camera.transform.TransformPoint(new Vector3(halfWidth, -camera.othergraphicSize, camera.farClipPlane));</span><br><span class="line">			cameraFarPanelCorner[3] &#x3D; camera.transform.TransformPoint(new Vector3(-halfWidth, -camera.orthergraphicSize, camera.farClipPlane));</span><br><span class="line">		&#125;</span><br><span class="line">		else</span><br><span class="line">		&#123;</span><br><span class="line">			float halfNearHeight &#x3D; camera.nearClipPlane * Mathf.Tan(Mathf.Deg2Rad * camera.fieldOfView * 0.5f);</span><br><span class="line">			float halfNearWidth &#x3D; halfNearHeight * aspect;</span><br><span class="line">			float halfFarHeight &#x3D;  camera.farClipPlane * Mathf.Tan(Mathf.Deg2Rad * camera.fieldOfView * 0.5f);</span><br><span class="line">			flaot halfFarWidth &#x3D; halfFarHeight * aspect;</span><br><span class="line"></span><br><span class="line">			cameraNearPanelCorner[0] &#x3D; camera.transform.TransformPoint(new Vector3(-halfNearWidth, halfNearHeight, camera.nearClipPlane));</span><br><span class="line">			cameraNearPanelCorner[1] &#x3D; camera.transform.TransformPoint(new Vector3(halfNearWidth, halfNearHeight, camera.nearClipPlane));</span><br><span class="line">			cameraNearPanleCorner[2] &#x3D; camera.transform.TransformPoint(new Vector3(halfNearWidth, -halfNearHeight, camera.nearClipPlane));</span><br><span class="line">			cameraNearPanelCorner[3] &#x3D; camera.transform.TransformPoint(new Vector3(-halfNearWidth, -halfNearHeight, camera.nearClipPlane));</span><br><span class="line"></span><br><span class="line">			cameraFarPanelCorner[0] &#x3D; camera.transform.TransformPoint(new Vector3(-halfFarWidth, halfFarHeight, camera.farClipPlane));</span><br><span class="line">			cameraFarPanelCorner[1] &#x3D; camera.transform.TransformPoint(new Vector3(halfFarWidth, halfFarHeight, camera.farClipPlane));</span><br><span class="line">			cameraFarPanelCorner[2] &#x3D; camera.transform.TransformPoint(new Vector3(halfFarWidth, -halfFarHeight, camera.farClipPlane));</span><br><span class="line">			cameraFarPanelCorner[3] &#x3D; camera.transform.TransformPoint(new Vector3(-halfFarWidth, -halfFarHeight, camera.farClipPlane));</span><br><span class="line">		&#125;</span><br><span class="line">		for(int i &#x3D;0;i&lt;4; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			viewPortCorner[i] &#x3D; RayCastUnityPosInZeroPanel(cameraFarPlaneCorner[i], cameraNearPlaneCorner[i]  - cameraFarPlaneCorner[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		return viewPortCorner;</span><br><span class="line">	&#125;</span><br><span class="line">	public Vector3 RayCastUnityPosInZeroPanel(Vector3 origin, Vector3 dir)</span><br><span class="line">	&#123;</span><br><span class="line">		float t &#x3D; -origin.y &#x2F; dir.y;</span><br><span class="line">		Vector3 centerPos &#x3D; origin + t * dir;</span><br><span class="line">		centerPos.y &#x3D; 0;</span><br><span class="line">		return centerPos;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class MapPathGenerator</span><br><span class="line">&#123;</span><br><span class="line">	public bool TryGetPath(Vector2 startPos, Vector2 endPos, out List&lt;Vector2&gt; pathPoint)</span><br><span class="line">	&#123;</span><br><span class="line">		pathPoint &#x3D; new List&lt;Vector2&gt;();</span><br><span class="line">		return PathGraphMgr.Instance.FindPath(startPos, endPos, ref pathPoint);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">public class WorldMapDataHandle</span><br><span class="line">&#123;</span><br><span class="line">	public QuadTree&lt;TileData&gt; worldMap;</span><br><span class="line">	Quad region;</span><br><span class="line">	IDirty world;</span><br><span class="line">	Dictionary&lt;int, List&lt;TileData&gt;&gt; tileCache &#x3D; new Dictionary&lt;int, List&lt;TileData&gt;&gt;();</span><br><span class="line">	public WorldMapDataHandle(IDirty world)</span><br><span class="line">	&#123;</span><br><span class="line">		this.world &#x3D; world;</span><br><span class="line">		int halfSize &#x3D; 1&lt;&lt; 20;</span><br><span class="line">		region.MinX &#x3D; -halfSize;</span><br><span class="line">		region.Miny &#x3D; -halfSize;</span><br><span class="line">		reigon.MaxX &#x3D; halfSize;</span><br><span class="line">		region.MaxY &#x3D; halfSize;</span><br><span class="line">		worldData &#x3D; new QuadTree&lt;TileData&gt;(ref region);</span><br><span class="line">		WorldMapServer.Instance._heartbeat &#x3D; HeartBeat;</span><br><span class="line">	&#125;</span><br><span class="line">	private void HeartBeat(List&lt;TileAddMessage&gt; newAdd, List&lt;TileDeleteMessage&gt; delete)</span><br><span class="line">	&#123;</span><br><span class="line">		TileData Tile;</span><br><span class="line">		Quad quad;</span><br><span class="line">		for(int i&#x3D;0; i&lt;delete.Count; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			tile &#x3D; delete[i].tile;</span><br><span class="line">			worldData.Remove(tile);</span><br><span class="line">		&#125;</span><br><span class="line">		for(int i &#x3D; 0;i&lt;newAdd.Count; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			tile &#x3D; new[i].tile;</span><br><span class="line">			quad &#x3D; new Quad(tile.min, tile.max);</span><br><span class="line">			worldData.Insert(tile, ref quad);</span><br><span class="line">		&#125;</span><br><span class="line">		if((newAdd.Count | delete.Count)&gt;0)</span><br><span class="line">		&#123;</span><br><span class="line">			world.SetDirty();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public void AddTile(TileData tile)</span><br><span class="line">	&#123;</span><br><span class="line">		TileAddMessage message &#x3D; new TileAddMessage()</span><br><span class="line">		&#123;</span><br><span class="line">			tile &#x3D; tile</span><br><span class="line">		&#125;;</span><br><span class="line">		WorldMapServer.Instance.Add(message);</span><br><span class="line">	&#125;</span><br><span class="line">	public void MoveTile(TileData tile, List&lt;Vector2&gt; posList, float speed)</span><br><span class="line">	&#123;</span><br><span class="line">		TileMoveMessage message &#x3D; new TileMoveMessage()</span><br><span class="line">		&#123;</span><br><span class="line">			tile &#x3D; tile,</span><br><span class="line">			speed &#x3D; speed,</span><br><span class="line">			progress &#x3D; 0,</span><br><span class="line">		&#125;;</span><br><span class="line">		messge.posList.AddRange(posList);</span><br><span class="line">		WorldMapServer.Instance.Move(message);</span><br><span class="line">	&#125;</span><br><span class="line">	public void RemoveTile(TileData tile)</span><br><span class="line">	&#123;</span><br><span class="line">		TileDeleteMessage message &#x3D; new TileDeleteMessage()</span><br><span class="line">		&#123;</span><br><span class="line">			tile &#x3D; tile</span><br><span class="line">		&#125;;</span><br><span class="line">		WorldMapServer.Instance.Delete(message);</span><br><span class="line">	&#125;</span><br><span class="line">	Quad? newRequestBranch &#x3D; null;</span><br><span class="line">	void RequestNewBranch()</span><br><span class="line">	&#123;</span><br><span class="line">		if(newRequestBranch &#x3D;&#x3D; null) return;</span><br><span class="line">		TileChunkData tileChunk &#x3D; null;</span><br><span class="line">		WorldMapServer.Instance.GetTileChunkData(newRequestBranch.Value, ref tileChunk);</span><br><span class="line">		newRequestBranch &#x3D; null;</span><br><span class="line">		worldData.InsertBranch(tileChunk.tiles, ref tileChunk.quad);</span><br><span class="line">		world.SetDirty();</span><br><span class="line">	&#125;</span><br><span class="line">	public bool SearchTile(List&lt;Quad&gt; region, ref Dictionary&lt;int, List&lt;TileData&gt;&gt; data, uint layerMask &#x3D; ~0u)</span><br><span class="line">	&#123;</span><br><span class="line">		CollectionsEx.Clear(ref data);</span><br><span class="line">		for(int i&#x3D;0;i&lt;region.Count; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			bool rst &#x3D; worldData.SearchArea(region[i], ref tileCache, 0, ref new RequestBranch, layerMask);</span><br><span class="line">			foreach(var tiles in tileCache)</span><br><span class="line">			&#123;</span><br><span class="line">				if(tiles.Value.Count &gt; 0)</span><br><span class="line">				&#123;</span><br><span class="line">					if(!data.TryGetValue(tile.Key, out var tileDatas))</span><br><span class="line">					&#123;</span><br><span class="line">						tileDatas &#x3D; new List&lt;TileData&gt;();</span><br><span class="line">						data.Add(tiles.Key, tiles.Value);</span><br><span class="line">					&#125;</span><br><span class="line">					foreach(var tile in tiles.Value)</span><br><span class="line">					&#123;</span><br><span class="line">						int index &#x3D; tileDatas.FindIndex((a)&#x3D;&gt; a.id &#x3D;&#x3D; tile.id);</span><br><span class="line">						if(index &lt; 0) tileDatas.Add(tile);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		RequestNewBranch();</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line">	public bool SearchTile(Quad region, ref Dictionary&lt;int, List&lt;TileData&gt;&gt; data, uint layerMask &#x3D; ~0u)</span><br><span class="line">	&#123;</span><br><span class="line">		bool rst &#x3D; worldData.SearchArea(region, ref data, 0, ref newRequestBranch, layerMask);</span><br><span class="line">		RequestNewBranch();</span><br><span class="line">		return rst;</span><br><span class="line">	&#125;</span><br><span class="line">	public bool SearchTile(Vector3 mapPos, ref Dictionary&lt;int, List&lt;TileData&gt;&gt; data, uint layerMask &#x3D; ~0U)</span><br><span class="line">	&#123;</span><br><span class="line">		return worldData.SearchPoint(mapPos.x, mapPos.z, ref data, layerMask);</span><br><span class="line">	&#125;</span><br><span class="line">	public bool IncludedInMapArea(Quad region)</span><br><span class="line">	&#123;</span><br><span class="line">		return this.regionContains(ref region);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br></pre></td><td class="code"><pre><span class="line">public class QuadTree&lt;T&gt; where T : ILeafValue</span><br><span class="line">&#123;</span><br><span class="line">	internal static Stack&lt;Branch&gt; branchPool &#x3D; new Stack&lt;Branch&gt;();</span><br><span class="line">	internal static Stack&lt;Leaf&gt; leafPool &#x3D; new Stack&lt;Leaf&gt;();</span><br><span class="line"></span><br><span class="line">	protected Branch root;</span><br><span class="line">	protected Quad region;</span><br><span class="line">	internal Dictionary&lt;int, Dictionary&lt;int, Leaf&gt;&gt; leafLookup &#x3D; new Dictionary&lt;int, Dictionary&lt;int, Leaf&gt;&gt;();</span><br><span class="line">	static int leafCount &#x3D; 0;</span><br><span class="line">	public QuadTree(ref Quad region)</span><br><span class="line">	&#123;</span><br><span class="line">		this.region  &#x3D; region;</span><br><span class="line">	&#125;</span><br><span class="line">	public QuadTree(Quad region):this(ref region)</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	public void Clear()</span><br><span class="line">	&#123;</span><br><span class="line">		root.Clear();</span><br><span class="line">		root.Tree &#x3D; this;</span><br><span class="line">		foreach(var leafs in leafLookup)</span><br><span class="line">		&#123;</span><br><span class="line">			leafs.Value.Clear();</span><br><span class="line">		&#125;</span><br><span class="line">		leafLookup.Clear();</span><br><span class="line">		leafCount &#x3D; 0;</span><br><span class="line">	&#125;</span><br><span class="line">	public static void ClearPools()</span><br><span class="line">	&#123;</span><br><span class="line">		branchPool &#x3D; new Stack&lt;Branch&gt;();</span><br><span class="line">		leafPool &#x3D; new Stack&lt;Leaf&gt;();</span><br><span class="line">	&#125;</span><br><span class="line">	public void Remove(T value)</span><br><span class="line">	&#123;</span><br><span class="line">		if(TryGetLeafsvalue.Layer, out var leaves)</span><br><span class="line">		&#123;</span><br><span class="line">			if(leaves.TryGetValue(value.ID, out var leaf))</span><br><span class="line">			&#123;</span><br><span class="line">				leaves.Remove(value.ID);</span><br><span class="line">				Branch branch &#x3D; leaf.Branch;</span><br><span class="line">				RecycleLeaf(leaf);</span><br><span class="line">				leaf.Branch &#x3D; null;</span><br><span class="line">				leaf.Value &#x3D; default(T);</span><br><span class="line">				return;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	void GetLeafs(int layer, out Dictionary&lt;int, Leaf&gt; leafs)</span><br><span class="line">	&#123;</span><br><span class="line">		if(!leafLookup.TryGetValue(layer, out leafs))</span><br><span class="line">		&#123;</span><br><span class="line">			leafs &#x3D; new Dictionary&lt;int, Leaf&gt;();</span><br><span class="line">			leafLookup.Add(layer, leafs);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	bool TryGetLeafs(int layer, out Dictionary&lt;int, Leaf&gt; leafs)</span><br><span class="line">	&#123;</span><br><span class="line">		return leafLookup.TryGetValue(layer, out leafs);</span><br><span class="line">	&#125;</span><br><span class="line">	public void Insert(T value, ref Quad quad)</span><br><span class="line">	&#123;</span><br><span class="line">		if(root &#x3D;&#x3D; null) return;</span><br><span class="line">		GetLeafs(value.Layer, out var leafs);</span><br><span class="line">		if(!leafs.TryGetValue(value.ID, out var leaf))</span><br><span class="line">		&#123;</span><br><span class="line">			leaf &#x3D; CreateLeaf(value, ref quad);</span><br><span class="line">			leafs.Add(value.ID, leaf);</span><br><span class="line">		&#125;</span><br><span class="line">		else</span><br><span class="line">		&#123;</span><br><span class="line">			leaf.Branch.Remove(leaf);</span><br><span class="line">			leaf.Branch &#x3D; null;</span><br><span class="line">			leaf.Value &#x3D; value;</span><br><span class="line">			leaf.Quad &#x3D; quad;</span><br><span class="line">		&#125;</span><br><span class="line">		if(root.Insert(leaf)&#x3D;&#x3D;null)</span><br><span class="line">		&#123;</span><br><span class="line">			leafs.Remove(value.ID);</span><br><span class="line">			RecycleLeaf(leaf);</span><br><span class="line">			leaf.Branch &#x3D; null;</span><br><span class="line">			leaf.Value &#x3D; default(T);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public void Insert(T value, Quad quad)</span><br><span class="line">	&#123;</span><br><span class="line">		Insert(value, ref quad);</span><br><span class="line">	&#125;</span><br><span class="line">	public void InsertBranch(List&lt;T&gt; tiles, ref Quad quad)</span><br><span class="line">	&#123;</span><br><span class="line">		Branch branch &#x3D; CreateBranch(this, null, quad.MaxX - quad.Minx, ref quad);</span><br><span class="line">		Leaf leaf;</span><br><span class="line">		T tile;</span><br><span class="line">		Quad rect;</span><br><span class="line">		Directionary&lt;int, Leaf&gt; leafs;</span><br><span class="line">		for(int i &#x3D;0;i&lt;tiles.Count;++i)</span><br><span class="line">		&#123;</span><br><span class="line">			tile &#x3D; tiles[i];</span><br><span class="line">			rect &#x3D; new Quad(tile.Min, tile.Max);</span><br><span class="line">			leaf &#x3D; CreateLeaf(tile, ref rect);</span><br><span class="line">			leaf.Branch &#x3D; branch;</span><br><span class="line">			GetLeafs(tile.Layer, out leafs);</span><br><span class="line">			leafs.Add(tile.ID, leaf);</span><br><span class="line">			branch.AddLeaf(leaf);</span><br><span class="line">		&#125;</span><br><span class="line">		if(root &#x3D;&#x3D; null)</span><br><span class="line">		&#123;</span><br><span class="line">			root &#x3D; branch;</span><br><span class="line">			return;</span><br><span class="line">		&#125;</span><br><span class="line">		root.InsertBranch(branch);</span><br><span class="line">	&#125;</span><br><span class="line">	public bool SearchArea(ref Quad quad, ref Dictionary&lt;int,List&lt;T&gt;&gt; valueLayers, float unitLen, ref Quad? new RequestBranch, uint layerMask &#x3D; ~0u)</span><br><span class="line">	&#123;</span><br><span class="line">		CollectionsEx.Clear(ref valueLayers);</span><br><span class="line">		if(root &#x3D;&#x3D;null)</span><br><span class="line">		&#123;</span><br><span class="line">			newRequestBranch &#x3D; region;</span><br><span class="line">			return false;</span><br><span class="line">		&#125;</span><br><span class="line">		int count &#x3D; 0;</span><br><span class="line">		root.SearchQuad(ref quad, ref valueLayers, ref count, unitLen, ref newRequestBranch, layerMask);</span><br><span class="line">		return count &gt; 0;</span><br><span class="line">	&#125;</span><br><span class="line">	public bool SearchArea(Quad, ref Dictionary&lt;int, List&lt;T&gt;&gt;valueLayers, float unitLen, ref Quad? newRequestBranch, uint layerMask &#x3D; ~0u)</span><br><span class="line">	&#123;</span><br><span class="line">		return SearchArea(ref quad, ref valueLayers, unitLen, ref newRequestBranch, layerMask);</span><br><span class="line">	&#125;</span><br><span class="line">	public bool SearchPoint(float x, float y, ref Dictionary&lt;int, List&lt;T&gt;&gt; valueLayers, uint layerMask &#x3D; ~0u)</span><br><span class="line">	&#123;</span><br><span class="line">		CollectionsEx.Clear(ref valueLayers);</span><br><span class="line">		if(root &#x3D;&#x3D; null)</span><br><span class="line">		&#123;</span><br><span class="line">			return false;</span><br><span class="line">		&#125;</span><br><span class="line">		int count &#x3D;0;</span><br><span class="line">		root.SearchPoint(x, y, ref valueLayers, ref count, layerMask);</span><br><span class="line">		return count &gt; 0;</span><br><span class="line">	&#125;</span><br><span class="line">	public bool FindCollision(T value, ref Dictionary&lt;int, List&lt;T&gt;&gt; valueLayers, ref Quad? newRequestBranch, uint layerMask &#x3D; ~0u)</span><br><span class="line">	&#123;</span><br><span class="line">		CollectionsEx.Clear(ref valueLayers);</span><br><span class="line">		Leaf leaf ;</span><br><span class="line">		if(!TryGetLeafs(value.Layer, out var leafs)) return false;</span><br><span class="line">		if(!leafs.TryGetValue(value.ID, out leaf)) return false;</span><br><span class="line">		int count &#x3D; 0;</span><br><span class="line">		var branch &#x3D; leaf.Branch;</span><br><span class="line">		foreach(var leaves in branch.Leaves)</span><br><span class="line">		&#123;</span><br><span class="line">			if(!CheckLayer(leaves.Key, leyerMask)) continue;</span><br><span class="line">			for(int i&#x3D;0;i&lt;leaves.Value.Count; ++i)</span><br><span class="line">			&#123;</span><br><span class="line">				if(leaf !&#x3D; leaves.Value[i] &amp;&amp; leaf.Quad.Intersects(ref leaves.Value[i].Quad))</span><br><span class="line">				&#123;</span><br><span class="line">					CollectionsEx.Add(ref valueLayers, leaves.Value[i].Value.layer, leaves.Value[i].Value);</span><br><span class="line">					++count;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		if(branch.Split)</span><br><span class="line">		&#123;</span><br><span class="line">			for(int i &#x3D; 0;i&lt;4; ++i)</span><br><span class="line">			&#123;</span><br><span class="line">				if(branch.Branches[i]!&#x3D;null)</span><br><span class="line">				&#123;</span><br><span class="line">					branch.Branches.SearchQuad(ref reaf.Quad, ref vaueLayers, ref count, int.MaxValue, ref newRequestBranch, layerMask);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		branch &#x3D; branch.Parent;</span><br><span class="line">		while(branch!&#x3D;null)</span><br><span class="line">		&#123;</span><br><span class="line">			foreach(var leaves in branch.Leaves)</span><br><span class="line">			&#123;</span><br><span class="line">				if(!CheckLayer(leaves.Key, layerMask)) continue;</span><br><span class="line">				for(int i&#x3D;0;i&lt;leaves.Value.Count;++i)</span><br><span class="line">				&#123;</span><br><span class="line">					if(leaf.Quad.Intersects(ref leaves.Value[i].Quad))</span><br><span class="line">					&#123;</span><br><span class="line">						CollectionsEx.Add(ref valueLayers, leaves.Value[i].Value.Layer,leaves.Value[i].Value);</span><br><span class="line">						++count;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			branch &#x3D; branch.Parent;</span><br><span class="line">		&#125;</span><br><span class="line">		return count &gt; 0;</span><br><span class="line">	&#125;</span><br><span class="line">	public int CountBranches()</span><br><span class="line">	&#123;</span><br><span class="line">		int count &#x3D; 0;</span><br><span class="line">		CountBranches(root, ref count);</span><br><span class="line">		return count;</span><br><span class="line">	&#125;</span><br><span class="line">	void CountBranches(Branch branch, ref int count)</span><br><span class="line">	&#123;</span><br><span class="line">		++count;</span><br><span class="line">		if(branch.Split)</span><br><span class="line">		&#123;</span><br><span class="line">			for(int i&#x3D;0;i&lt;4;++i)</span><br><span class="line">			&#123;</span><br><span class="line">				if(branch.Branches[i]!&#x3D;null)</span><br><span class="line">				&#123;</span><br><span class="line">					CountBranches(branch.Branches[i], ref count);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	static Branch CreateBranch(QuadTree&lt;T&gt; tree, Branch parent, float branchLen, ref Quad quad)</span><br><span class="line">	&#123;</span><br><span class="line">		var branch &#x3D; branchPool.Count &gt; 0? branchPool.Pop() : new Branch();</span><br><span class="line">		branch.Tree &#x3D; tree;</span><br><span class="line">		branch.Parent &#x3D; parent;</span><br><span class="line">		branch.UnitLen &#x3D; branchLen;</span><br><span class="line">		float midX &#x3D; quad.MinX + (quad.MaxX - quad.MinX) * 0.5f;</span><br><span class="line">		float midY &#x3D; quad.MinY + (quad.MaxY - quad.MinY) * 0.5f;</span><br><span class="line">		branch.Quads[0].Set(quad.MinX, quad.MinY, midX, minY);</span><br><span class="line">		branch.Quads[1].Set(minX, quad.MinY, quad.MaxX, midY);</span><br><span class="line">		branch.Quads[2].Set(midX, midY, quad.MaxX, quad.MaxY);</span><br><span class="line">		branch.Quads[3].Set(quad.MinX, midY, midX, quad.MaxY);</span><br><span class="line">		return branch;</span><br><span class="line">	&#125;</span><br><span class="line">	static Leaf CreateLeaf(T value, ref Quad quad)</span><br><span class="line">	&#123;</span><br><span class="line">		var leaf &#x3D; leafPool.Count &gt; 0? leafPool.Pop() : new Leaf();</span><br><span class="line">		leaf.Value &#x3D; value;</span><br><span class="line">		leaf.Quad &#x3D; quad;</span><br><span class="line">		++leafCount;</span><br><span class="line">		return leaf;</span><br><span class="line">	&#125;</span><br><span class="line">	static void RecycleLeaf(Leaf leaf)</span><br><span class="line">	&#123;</span><br><span class="line">		leafPool.Push(leaf);</span><br><span class="line">		--leafCount;</span><br><span class="line">	&#125;</span><br><span class="line">	static bool CheckLayer(int layer, uint layerMask)</span><br><span class="line">	&#123;</span><br><span class="line">		return ((1&lt;&lt;layer)&amp; layerMask)&gt;0;</span><br><span class="line">	&#125;</span><br><span class="line">	protected internal class Branch</span><br><span class="line">	&#123;</span><br><span class="line">		internal QuadTree&lt;T&gt; Tree;</span><br><span class="line">		internal Branch Parent;</span><br><span class="line">		internal Quad[] Quads &#x3D; new Quad[4];</span><br><span class="line">		internal Branch[] Branches &#x3D; new Branch[4];</span><br><span class="line">		internal Dictionary&lt;int, List&lt;Leaf&gt;&gt; leaves &#x3D; new Dictionary&lt;int, List&lt;Leaf&gt;&gt;();</span><br><span class="line">		internal bool Split &#x3D; false;</span><br><span class="line">		internal float UnitLen;</span><br><span class="line">		public void AddLeaf(Leaf leaf)</span><br><span class="line">		&#123;</span><br><span class="line">			List&lt;Leaf&gt; leaves;</span><br><span class="line">			if(!Leaves.TryGetValue(leaf.Value.Layer, out leaves))</span><br><span class="line">			&#123;</span><br><span class="line">				leaves &#x3D; new List&lt;Leaf&gt;();</span><br><span class="line">				Leaves.Add(leaf.Value.Layer, leaves);</span><br><span class="line">			&#125;</span><br><span class="line">			leaves.Add(leaf);</span><br><span class="line">		&#125;</span><br><span class="line">		public bool TryGetLeaves(int layer, out List&lt;Leaf&gt; leaves)</span><br><span class="line">		&#123;</span><br><span class="line">			return Leaves.TryGetValue(layer, out leaves);</span><br><span class="line">		&#125;</span><br><span class="line">		internal void Clear()</span><br><span class="line">		&#123;</span><br><span class="line">			Tree &#x3D; null;</span><br><span class="line">			Parent &#x3D; null;</span><br><span class="line">			Split &#x3D; false;</span><br><span class="line">			for(int i&#x3D;0;i&lt;4;++i)</span><br><span class="line">			&#123;</span><br><span class="line">				if(Branches[i]!&#x3D;null)</span><br><span class="line">				&#123;</span><br><span class="line">					branchPool.Push(Branches[i]);</span><br><span class="line">					Branches[i].Clear();</span><br><span class="line">					Branches[i] &#x3D; null;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			foreach(var leaves in Leaves)</span><br><span class="line">			&#123;</span><br><span class="line">				for(int i&#x3D;0;i&lt;leaves.Value.Count;++i)</span><br><span class="line">				&#123;</span><br><span class="line">					RecycleLeaf(leaves.Value[i]);</span><br><span class="line">					leaves.Value[i].Branch &#x3D; null;</span><br><span class="line">					leaves.Value[i].Value &#x3D; default(T);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			CollectionsEx.Clear(ref Leaves);</span><br><span class="line">		&#125;</span><br><span class="line">		internal void Remove(Leaf leaf)</span><br><span class="line">		&#123;</span><br><span class="line">			if(TryGetLeaves(leaf.Value.Layer, out var leaves))</span><br><span class="line">			&#123;</span><br><span class="line">				int index &#x3D; leaves.FindIndex((x)&#x3D;&gt;&#123;return x.Value.ID &#x3D;&#x3D; leaf.Vallue.ID;&#125;);</span><br><span class="line">				if(index &lt; 0&gt;) return;</span><br><span class="line">				leaves[index] &#x3D; leaves[leaves.Count - 1];</span><br><span class="line">				leaves.RemoveAt(leaves.Count - 1);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		internal Branch Insert(Leaf leaf)</span><br><span class="line">		&#123;</span><br><span class="line">			if(leaf.Value.UnitLen&lt;UnitLen)</span><br><span class="line">			&#123;</span><br><span class="line">				for(int i&#x3D;0;i&lt;4; ++i)</span><br><span class="line">				&#123;</span><br><span class="line">					if(Quads[i].Contains(ref leaf.Quad))</span><br><span class="line">					&#123;</span><br><span class="line">						if(Branches[i] &#x3D;&#x3D; null)</span><br><span class="line">						&#123;</span><br><span class="line">							return null;</span><br><span class="line">						&#125;</span><br><span class="line">						return Branches[i].Insert(leaf);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				AddLeaf(leaf);</span><br><span class="line">				leaf.Branch &#x3D; this;</span><br><span class="line">				return this;</span><br><span class="line">			&#125;</span><br><span class="line">			else</span><br><span class="line">			&#123;</span><br><span class="line">				AddLeaf(leaf);</span><br><span class="line">				leaf.Branch &#x3D; this;</span><br><span class="line">				return this;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		internal Branch InsertBranch(Branch branch)</span><br><span class="line">		&#123;</span><br><span class="line">			for(int i&#x3D;0;i&lt;4;++i)</span><br><span class="line">			&#123;</span><br><span class="line">				if(Quads[i].Contains(ref branch.Quads[0]))</span><br><span class="line">				&#123;</span><br><span class="line">					if(Quads[i].MaxX - Quads[i].MinX &#x3D;&#x3D; branch.Quads[2].MaxX - branch.Quads[0].Minx)&#123;</span><br><span class="line">						Branches[i] &#x3D; branch;</span><br><span class="line">						branch.Parent &#x3D; this;</span><br><span class="line">						branch.UnitLen &#x3D; UnitLen &#x2F; 2;</span><br><span class="line">						Split &#x3D; true;</span><br><span class="line">						return this;</span><br><span class="line">					&#125;				</span><br><span class="line">					else</span><br><span class="line">					&#123;</span><br><span class="line">						return Branches[i].InsertBranch(branch);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			return this;</span><br><span class="line">		&#125;</span><br><span class="line">		internal void SearchQuad(ref Quad quad, ref Dictionary&lt;int, List&lt;T&gt;&gt; valueLayers, ref int count, float unitLen, ref Quad? newRequestBranch, uint layerMask)</span><br><span class="line">		&#123;</span><br><span class="line">			if(UnitLen&lt; unitLen) return ;</span><br><span class="line">			foreach(var leaves in Leaves)</span><br><span class="line">			&#123;</span><br><span class="line">				if(!CheckLayer(leaves.Key, layerMask)) continue;</span><br><span class="line">				for(int i &#x3D;0;i&lt;leaves.Value.Count;++i)</span><br><span class="line">				&#123;</span><br><span class="line">					var leaf &#x3D; leaves.Value[i];</span><br><span class="line">					if(leaf.Value.UnitLen &gt;&#x3D; unitLen &amp;&amp; quad.Intersects(ref leaf.Quad))</span><br><span class="line">					&#123;</span><br><span class="line">						CollectionsEx.Add(ref valueLayers, leaf.Value.Laer, leaf.Value);</span><br><span class="line">						++count;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			if(newRequestBranch &#x3D;&#x3D;null)</span><br><span class="line">			&#123;</span><br><span class="line">				for(int i&#x3D;0;i&lt;4;++i)</span><br><span class="line">				&#123;</span><br><span class="line">					if(Branches[i] &#x3D;&#x3D; null &amp;&amp; Quads[i].Contains(ref quad))</span><br><span class="line">					&#123;</span><br><span class="line">						newRequestBranch &#x3D; Quads[i];</span><br><span class="line">						break;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			for(int i&#x3D;0;i&lt;4;++i)</span><br><span class="line">			&#123;</span><br><span class="line">				if(Branches[i]!&#x3D;null &amp;&amp; Quads[i].Contains(ref quad))</span><br><span class="line">				&#123;</span><br><span class="line">					Branches[i].SearchQuad(ref quad, ref valueLayers, ref count, unitLen, ref newReuqestBranch, layerMask);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		internal void SearchPoint(float x, float y, ref Dictionary&lt;int, List&lt;T&gt;&gt; valueLayers, ref int count, uint layerMask)</span><br><span class="line">		&#123;</span><br><span class="line">			foreach(var leaves in Leaves)</span><br><span class="line">			&#123;</span><br><span class="line">				if(!CheckLayer(leaves.Key, layerMask)) continue;</span><br><span class="line">				for(int i&#x3D;0;i&lt;leaves.Value.Count;++i)</span><br><span class="line">				&#123;</span><br><span class="line">					var leaf &#x3D; leaves.Value[i];</span><br><span class="line">					if(leaf.Quad.Contains(x,y))</span><br><span class="line">					&#123;</span><br><span class="line">						CollectionsEx.Add(ref valueLayers, leaf.Value.Layer, leaf.Value);</span><br><span class="line">						++count;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			for(int i&#x3D;0;i&lt;4;++i)</span><br><span class="line">			&#123;</span><br><span class="line">				if(Branches[i]!&#x3D;null &amp;&amp; Quads[i].Contains(x,y))</span><br><span class="line">				&#123;</span><br><span class="line">					Branches[i].SearchPoint(x,y, ref valueLayers, ref count, layerMask);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		internal void SearchPoint(float x, float y, float unitLen, ref Dictionary&lt;int, List&lt;T&gt;&gt; valueLayers, ref int count, uint layerMask)</span><br><span class="line">		&#123;</span><br><span class="line">			if(UnitLen &lt; unitLen) return;</span><br><span class="line">			foreach(var leaves in Leaves)</span><br><span class="line">			&#123;</span><br><span class="line">				if(!CheckLayer(leaves.Key, layerMask)) continue;</span><br><span class="line">				for(int i&#x3D;0;i&lt;leaves.Value.Count;++i)</span><br><span class="line">				&#123;</span><br><span class="line">					var leaf &#x3D; leaves.Value[i];</span><br><span class="line">					if(leaf.Quad.Contains(x,y))</span><br><span class="line">					&#123;</span><br><span class="line">						CollectionsEx.Add(ref valueLayers, leaf.Value.Layer, leaf.Value);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			for(int i&#x3D;0;i&lt;4;++i)</span><br><span class="line">			&#123;</span><br><span class="line">				if(Branches[i]!&#x3D;null &amp;&amp; Quads[i].Contains(x, y))</span><br><span class="line">				&#123;</span><br><span class="line">					Branches[i].SearchPoint(x,y, ref ValueLayers, ref count, layerMask);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	protected internal class Leaf</span><br><span class="line">	&#123;</span><br><span class="line">		internal Branch Branch;</span><br><span class="line">		internal T Value;</span><br><span class="line">		interanl Quad Quad;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[Serializable]</span><br><span class="line">public struct Quad</span><br><span class="line">&#123;</span><br><span class="line">	public const int unitLenLimit &#x3D; 1;</span><br><span class="line">	public float MinX;</span><br><span class="line">	public float MinY;</span><br><span class="line">	public float MaxX;</span><br><span class="line">	public float MaxY;</span><br><span class="line">	public Quad(float minx, float miny, float maxx, float maxy)</span><br><span class="line">	&#123;</span><br><span class="line">		MinX &#x3D; minx;</span><br><span class="line">		MinY &#x3D; miny;</span><br><span class="line">		MaxX &#x3D; maxx;</span><br><span class="line">		MaxY &#x3D; maxy;</span><br><span class="line">	&#125;</span><br><span class="line">	public Quad(Vector2 min, Vector2 max)</span><br><span class="line">	&#123;</span><br><span class="line">		MinX &#x3D; min.x;</span><br><span class="line">		MinY &#x3D; min.y;</span><br><span class="line">		MaxX &#x3D; max.x;</span><br><span class="line">		MaxY &#x3D; max.y;</span><br><span class="line">	&#125;</span><br><span class="line">	public void Set(float minx , float miny, float maxx, float maxy)</span><br><span class="line">	&#123;</span><br><span class="line">		MinX &#x3D; minx;</span><br><span class="line">		MinY &#x3D; miny;</span><br><span class="line">		MaxX &#x3D; maxx;</span><br><span class="line">		MaxY &#x3D; maxy;</span><br><span class="line">	&#125;</span><br><span class="line">	public bool Intersects(ref Quad other)</span><br><span class="line">	&#123;</span><br><span class="line">		return MinX &lt; other.MaxX &amp;&amp; MinY &lt; other.MaxY &amp;&amp; MaxX &gt; other.MinX &amp;&amp; MaxY &gt; other.MinY;</span><br><span class="line">	&#125;</span><br><span class="line">	public bool Contains(ref Quad other)</span><br><span class="line">	&#123;</span><br><span class="line">		return other.MinX &gt;&#x3D; MinX &amp;&amp; other.MinY &gt;&#x3D; MinY &amp;&amp; other.MaxX &lt;&#x3D; MaxX &amp;&amp; other.MaxY &lt;&#x3D; MaxY;</span><br><span class="line">	&#125;</span><br><span class="line">	public bool Contains(float x, float y)</span><br><span class="line">	&#123;</span><br><span class="line">		return x &gt; MinX &amp;&amp; y&gt;MinY &amp;&amp; x&lt; MaxX &amp;&amp; y&lt; MaxY;</span><br><span class="line">	&#125;</span><br><span class="line">	public void Include(ref Quad other)</span><br><span class="line">	&#123;</span><br><span class="line">		MinX &#x3D; MinX &gt; other.MinX ? other.MinX : MinX;</span><br><span class="line">		MinY &#x3D; MinY &gt; other.MinY ? other.MinY : MinY;</span><br><span class="line">		MaxX &#x3D; MaxX &lt; other.MaxX ? other.MaxX : MaxX;</span><br><span class="line">		MaxY &#x3D; MaxY &lt; other.MaxY ? other.MaxY : MaxY;</span><br><span class="line">	&#125;</span><br><span class="line">	publicStatic Quad CreatePowerOfTowQuad(float width, float height)</span><br><span class="line">	&#123;</span><br><span class="line">		int value &#x3D; 1;</span><br><span class="line">		while(value &gt;&#x3D; width &amp;&amp; value &gt;&#x3D; height)</span><br><span class="line">		&#123;</span><br><span class="line">			value &#x3D; value &lt;&lt; 1;</span><br><span class="line">		&#125;</span><br><span class="line">		Quad rect &#x3D; new Quad(0.0, value, value);</span><br><span class="line">		return rect;</span><br><span class="line">	&#125;</span><br><span class="line">	internal static bool SplitQuad(ref Quad quad, ref Quad[] temp)</span><br><span class="line">	&#123;</span><br><span class="line">		float midX &#x3D; quad.MinX + (quad.MaxX - quad.MinX) * 0.5f;</span><br><span class="line">		if(unitLenLimit &gt; midX - quad.Minx) return false;</span><br><span class="line">		float midY &#x3D; quad.MinY + (quad.MaxY - quad.MinY) * 0.5f;</span><br><span class="line">		temp[0].Set(quad.MinX, quad.MinY, midX, midY);</span><br><span class="line">		temp[1].Set(midX, quad.MinY, quad.MaxX, midY);</span><br><span class="line">		temp[2].Set(midX, midY, quad.MaxX, quad.MaxY);</span><br><span class="line">		temp[3].Set(quad.Miny, midY, midX, quad.MaxY);</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line">	public override string ToString()</span><br><span class="line">	&#123;</span><br><span class="line">		return string.Format(&quot;&#123;0&#125;, &#123;1&#125;, &#123;2&#125;, &#123;3&#125;&quot;, MinX, MinY, MaxX, MaxY);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public interface ILeafValue</span><br><span class="line">&#123;</span><br><span class="line">	float UnitLen&#123;get;set;&#125;</span><br><span class="line">	Vector2 Min&#123;get;set;&#125;</span><br><span class="line">	Vector2 Max&#123;get;set;&#125;</span><br><span class="line">	int ID&#123;get;set;&#125;</span><br><span class="line">	int Layer&#123;get;set;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">[Serializable]</span><br><span class="line">public class TileData:ILeafValue</span><br><span class="line">&#123;</span><br><span class="line">	public int id;</span><br><span class="line">	public string typy;</span><br><span class="line">	public string name;</span><br><span class="line">	public Vector2 position;</span><br><span class="line">	public Vector2 min;</span><br><span class="line">	public Vector2 max;</span><br><span class="line">	public float priority;</span><br><span class="line">	public int layer;</span><br><span class="line">	public int userID;</span><br><span class="line">	public List&lt;Vector2&gt; posList &#x3D; new List&lt;Vector2&gt;();</span><br><span class="line">	public float UnitLen &#123;</span><br><span class="line">		get &#123; return priority;&#125;</span><br><span class="line">		set &#123; priority &#x3D; value;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public Vector2 Min&#123;</span><br><span class="line">		get &#123; return min;&#125;</span><br><span class="line">		set &#123; min &#x3D; value;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public Value2 Max&#123;</span><br><span class="line">		get&#123; return max;&#125;</span><br><span class="line">		set &#123;max &#x3D; value;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public int ID&#123;</span><br><span class="line">		get&#123;return id;&#125;</span><br><span class="line">		set&#123;id &#x3D; value;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public int Layer&#123;</span><br><span class="line">		get&#123;return layer;&#125;</span><br><span class="line">		set&#123;layer &#x3D; value;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public TileData Clone()</span><br><span class="line">	&#123;</span><br><span class="line">		TileData tile &#x3D; TileData()</span><br><span class="line">		&#123;</span><br><span class="line">			id &#x3D; id,</span><br><span class="line">			type &#x3D; type,</span><br><span class="line">			name &#x3D; name,</span><br><span class="line">			position &#x3D; position,</span><br><span class="line">			min &#x3D; min,</span><br><span class="line">			max &#x3D; max, </span><br><span class="line">			priority &#x3D; priority,</span><br><span class="line">			layer &#x3D; layer,</span><br><span class="line">			userID &#x3D; userID,</span><br><span class="line">			posList &#x3D; posList</span><br><span class="line">		&#125;;</span><br><span class="line">		return tile;</span><br><span class="line">	&#125;</span><br><span class="line">	public TileData Clone(Vector newPos)</span><br><span class="line">	&#123;</span><br><span class="line">		TileData tile &#x3D; TileData()</span><br><span class="line">		&#123;</span><br><span class="line">			id &#x3D; id,</span><br><span class="line">			type &#x3D; type,</span><br><span class="line">			name &#x3D; name,</span><br><span class="line">			position &#x3D; newPos,</span><br><span class="line">			min &#x3D; min - position + newPos,</span><br><span class="line">			max &#x3D; max - position + newPos, </span><br><span class="line">			priority &#x3D; priority,</span><br><span class="line">			layer &#x3D; layer,</span><br><span class="line">			userID &#x3D; userID,</span><br><span class="line">			posList &#x3D; posList</span><br><span class="line">		&#125;;</span><br><span class="line">		return tile;</span><br><span class="line">	&#125;</span><br><span class="line">	public override stirng ToString()</span><br><span class="line">	&#123;</span><br><span class="line">		return id.ToString();</span><br><span class="line">	&#125;</span><br><span class="line">	public override int GetHashCode()</span><br><span class="line">	&#123;</span><br><span class="line">		return (int)id;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2021/06/05/PathFinding/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2021/06/05/PathFinding/" class="post-title-link" itemprop="url">Graph</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-06-05 15:01:00" itemprop="dateCreated datePublished" datetime="2021-06-05T15:01:00+08:00">2021-06-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-17 19:12:22" itemprop="dateModified" datetime="2021-06-17T19:12:22+08:00">2021-06-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Gemotry/" itemprop="url" rel="index"><span itemprop="name">Gemotry</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Gemotry/Graph/" itemprop="url" rel="index"><span itemprop="name">Graph</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public static class SortHelp</span><br><span class="line">&#123;</span><br><span class="line">	public delegate bool Compare&lt;T&gt;(T a, T b);</span><br><span class="line">	public static void QuickSort&lt;T&gt;(List&lt;T&gt; array, int start, int end, Compare&lt;T&gt; compare)</span><br><span class="line">	&#123;</span><br><span class="line">		if(start &lt; end&gt;)</span><br><span class="line">		&#123;</span><br><span class="line">			int pIndex &#x3D; Partition&lt;T&gt;(array, start, end, compare);</span><br><span class="line">			QuickSort(array, start, pIndex - 1, compare);</span><br><span class="line">			QuickSort(array, pIndex + 1, end, compare);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	static in Partition&lt;T&gt;(List&lt;T&gt; array, int start, int end, Compare&lt;T&gt; compare)</span><br><span class="line">	&#123;</span><br><span class="line">		int pIndex &#x3D; start;</span><br><span class="line">		T pivot &#x3D; array[end];</span><br><span class="line">		for(int i &#x3D; start; i&lt; end; ++i&gt;)</span><br><span class="line">		&#123;</span><br><span class="line">			if(compare(array[i], pivot))</span><br><span class="line">			&#123;</span><br><span class="line">				Swap&lt;T&gt;(array, i, pIndex);</span><br><span class="line">				++i;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		Swap(array, end, pIndex);</span><br><span class="line">		return pIndex;</span><br><span class="line">	&#125;</span><br><span class="line">	static void Swap(List&lt;T&gt; array, int x, int y)</span><br><span class="line">	&#123;</span><br><span class="line">		T t &#x3D; array[x];</span><br><span class="line">		array[x] &#x3D; array[y];</span><br><span class="line">		array[y] &#x3D; t;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">public static class PolygonHelp</span><br><span class="line">&#123;</span><br><span class="line">	public static float Cross(ref Vector2 edge1, ref Vector2 edge2)</span><br><span class="line">	&#123;</span><br><span class="line">		return edge1.x * edge2.y - edge1.y * edge2.x;</span><br><span class="line">	&#125;</span><br><span class="line">	public static float Cross(Vector2 edge1, Vector2 edge2)</span><br><span class="line">	&#123;</span><br><span class="line">		return edge1.x * edge2.y - edge1.y * edge2.x;</span><br><span class="line">	&#125;</span><br><span class="line">	public static float Dot(ref Vector2 edge1, ref Vector2 edge2)</span><br><span class="line">	&#123;</span><br><span class="line">		return edge1.x * edge2.x + edge1.y * edge2.y;</span><br><span class="line">	&#125;</span><br><span class="line">	public static float Dot(Vector2 edge1, Vector2 edge2)</span><br><span class="line">	&#123;</span><br><span class="line">		return edge1.x * edge2.x + edge1.y * edge2.y;</span><br><span class="line">	&#125;</span><br><span class="line">	public static float SignedAngle0_2PI(Vector2 dir1, Vector2 dir2)</span><br><span class="line">	&#123;</span><br><span class="line">		dir1.Normalize();</span><br><span class="line">		dir2.Normalize();</span><br><span class="line">		float aCos &#x3D; Dot(ref dir1, ref dir2);</span><br><span class="line">		float angle &#x3D; Mathf.Acos(aCos);</span><br><span class="line">		float sign &#x3D; Corss(ref dir1, ref dir2);</span><br><span class="line">		if(sign &lt; 0)</span><br><span class="line">		&#123;</span><br><span class="line">			angle &#x3D; 2 * Mathf.PI - angle;</span><br><span class="line">		&#125;</span><br><span class="line">		return angle;</span><br><span class="line">	&#125;</span><br><span class="line">	public static bool ClockWise(List&lt;Vector2&gt; polygon)</span><br><span class="line">	&#123;</span><br><span class="line">		float area &#x3D; 0;</span><br><span class="line">		for(int pre &#x3D; polygon.Count - 1, i &#x3D;0; i &lt; polygon.Count; pre &#x3D; i, ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			area +&#x3D; Corss(polygon[pre], polygon[i] - polygon[pre]);</span><br><span class="line">		&#125;</span><br><span class="line">		return area &gt; 0;</span><br><span class="line">	&#125;</span><br><span class="line">	public static bool PointInsideRegion(Vector2 pt, List&lt;Vector2&gt; region, float eps &#x3D; float.Epsilon)</span><br><span class="line">	&#123;</span><br><span class="line">		var x &#x3D; pt[0];</span><br><span class="line">		var y &#x3D; pt[1];</span><br><span class="line">		var last_x &#x3D; region[region.Count -1][0];</span><br><span class="line">		var last_y &#x3D; region[region.Count -1][1];</span><br><span class="line">		bool inside &#x3D; false;</span><br><span class="line">		for(int i&#x3D;0; i&lt;region.Count; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			int curr_x &#x3D; region[i][0];</span><br><span class="line">			int curr_y &#x3D; region[i][1];</span><br><span class="line">			if((curr_y - y &gt; eps) !&#x3D; (last_y -y &gt; eps) &amp;&amp; </span><br><span class="line">				(last_x - curr_x) * (y - curr_y) &#x2F; (last_y - curr_y) + curr_x - x &gt; eps)</span><br><span class="line">				inside &#x3D; !inside;</span><br><span class="line">			last_x &#x3D; curr_x;</span><br><span class="line">			last_y &#x3D; curr_y;</span><br><span class="line">		&#125;</span><br><span class="line">		return inside;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">class Point</span><br><span class="line">&#123;</span><br><span class="line">	public float x;</span><br><span class="line">	public float y;</span><br><span class="line">	public int index;</span><br><span class="line">	public Edge edge1;</span><br><span class="line">	public Edge edge2;</span><br><span class="line">	public Point prePoint;</span><br><span class="line">	public Point nextPoint;</span><br><span class="line">	public float angle;</span><br><span class="line">	public float maxAngle;</span><br><span class="line">	public Point()&#123;&#125;</span><br><span class="line">	public Point(Vector3 p, int i)</span><br><span class="line">	&#123;</span><br><span class="line">		index &#x3D; i;</span><br><span class="line">		x &#x3D; p.x;</span><br><span class="line">		y &#x3D; p.z;</span><br><span class="line">	&#125;</span><br><span class="line">	public Point(Vector2 p, int i)</span><br><span class="line">	&#123;</span><br><span class="line">		index &#x3D; i;</span><br><span class="line">		x &#x3D; p.x;</span><br><span class="line">		y &#x3D; p.y;</span><br><span class="line">	&#125;</span><br><span class="line">	public Point(float x, float y)</span><br><span class="line">	&#123;</span><br><span class="line">		this.x &#x3D; x;</span><br><span class="line">		this.y &#x3D; y;</span><br><span class="line">	&#125;</span><br><span class="line">	public void Set(ref Vector2 v)</span><br><span class="line">	&#123;</span><br><span class="line">		x &#x3D; v.x;</span><br><span class="line">		y &#x3D; v.y;</span><br><span class="line">	&#125;</span><br><span class="line">	public Vector3 ToVector3()</span><br><span class="line">	&#123;</span><br><span class="line">		return new Vector3(x, 0, y);</span><br><span class="line">	&#125;</span><br><span class="line">	public Vector2 ToVector2()</span><br><span class="line">	&#123;</span><br><span class="line">		return new Vector2(x, y);</span><br><span class="line">	&#125;</span><br><span class="line">	public static float Distance(Point p1, Point p2)</span><br><span class="line">	&#123;</span><br><span class="line">		return Mathf.Sqrt((p1.x - p2.x) * (p1.x - p2.x) + (p1.y - p2.y) * (p1.y - p2.y));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">class Edge</span><br><span class="line">&#123;</span><br><span class="line">	public Point point1;</span><br><span class="line">	public Point point2;</span><br><span class="line">	public Edge(Point p1, Point p2)</span><br><span class="line">	&#123;</span><br><span class="line">		point1 &#x3D; p1;</span><br><span class="line">		point2 &#x3D; p2;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br></pre></td><td class="code"><pre><span class="line">public class linesIntersect</span><br><span class="line">&#123;</span><br><span class="line">	public int alongA;</span><br><span class="line">	public int alongB;</span><br><span class="line">	public Vector2 pt;</span><br><span class="line">&#125;</span><br><span class="line">public class PathGraph</span><br><span class="line">&#123;</span><br><span class="line">	private List&lt;List&lt;Point&gt;&gt; polygons &#x3D; new List&lt;List&lt;Point&gt;&gt;();</span><br><span class="line">	private List&lt;Point&gt; allPoints &#x3D; new List&lt;Point&gt;();</span><br><span class="line">	private List&lt;List&lt;Point&gt;&gt; graph &#x3D; new List&lt;List&lt;Point&gt;&gt;();</span><br><span class="line"></span><br><span class="line">	private Dictionary&lt;int, Dictionary&lt;int, float&gt;&gt; weightedGraph &#x3D; new Dictionary&lt;int, Dictionary&lt;int, float&gt;&gt;();</span><br><span class="line">	void Clear()</span><br><span class="line">	&#123;</span><br><span class="line">		foreach(var t in polygons) t.Clear();</span><br><span class="line">		polygons.Clear();</span><br><span class="line">		foreach(var p in graph) p.Clear();</span><br><span class="line">		graph.Clear();</span><br><span class="line">		allPoints.Clear();</span><br><span class="line">		foreach(var v in weightedGraph) v.Value.Clear();</span><br><span class="line">		weightedGraph.Clear();</span><br><span class="line">	&#125;</span><br><span class="line">	public void InitPolygons(PathBoundary boundary, List&lt;PathBoundary&gt; obstacles)</span><br><span class="line">	&#123;</span><br><span class="line">		Clear();</span><br><span class="line">		List&lt;Point&gt; points &#x3D; null;</span><br><span class="line">		int index &#x3D; 0;</span><br><span class="line">		points &#x3D; new List&lt;Point&gt;();</span><br><span class="line">		foreach(var point in boundary.polygon)</span><br><span class="line">		&#123;</span><br><span class="line">			points.Add(new Point(point, index++));</span><br><span class="line">		&#125;</span><br><span class="line">		this.polygons.Add(points);</span><br><span class="line"></span><br><span class="line">		foreach(var obstacle in obstacles)</span><br><span class="line">		&#123;</span><br><span class="line">			points &#x3D; new List&lt;Point&gt;();</span><br><span class="line">			foreach(var point in obstacle.polygon)</span><br><span class="line">			&#123;</span><br><span class="line">				points.Add(new Point(point, index++));</span><br><span class="line">			&#125;</span><br><span class="line">			this.polygons.Add(points);</span><br><span class="line">		&#125;</span><br><span class="line">		Init();</span><br><span class="line">	&#125;</span><br><span class="line">	void Init()</span><br><span class="line">	&#123;</span><br><span class="line">		Point prePoint, curPoint;</span><br><span class="line">		int pre;</span><br><span class="line">		foreach(var polygon in polygons)</span><br><span class="line">		&#123;</span><br><span class="line">			pre &#x3D; polygon.Count - 1;</span><br><span class="line">			for(int i &#x3D;0; i&lt;polygon.Count; ++i)</span><br><span class="line">			&#123;</span><br><span class="line">				polygon[pre].nextPoint &#x3D; polygon[i];</span><br><span class="line">				polygon[i].prePoint &#x3D; polygon[pre];</span><br><span class="line">				Edge edge &#x3D; new Edge(polygon[pre], polygon[i]);</span><br><span class="line">				polygon[pre].edge2 &#x3D; edge;</span><br><span class="line">				polygon[i].edge1 &#x3D; edge;</span><br><span class="line"></span><br><span class="line">				allPoints.Add(polygon[i]);</span><br><span class="line">				pre &#x3D; i;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		foreach(var polygon in polygons)</span><br><span class="line">		&#123;</span><br><span class="line">			foreach(var point in polygon)</span><br><span class="line">			&#123;</span><br><span class="line">				Vector2 dir1 &#x3D; point.edge1.point1.ToVector2() - point.ToVector2();</span><br><span class="line">				Vector2 dir2 &#x3D; point.edge2.point2.ToVector2() - point.ToVector2();</span><br><span class="line">				point.maxAngle &#x3D; PolygonHelp.SiginAngle0_2PI(dir1, dir2);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public void Graph(ref List&lt;int&gt; point1, ref List&lt;int&gt; point2, ref List&lt;float&gt; dist, ref bool reBuild)</span><br><span class="line">	&#123;</span><br><span class="line">		if(reBuild)</span><br><span class="line">		&#123;</span><br><span class="line">			CalculateGraph();</span><br><span class="line">			point1.Clear();</span><br><span class="line">			point2.Clear();</span><br><span class="line">			dist.Clear();</span><br><span class="line">			foreach(var links in weightedGraph)</span><br><span class="line">			&#123;</span><br><span class="line">				foreach(var end in links.Value)</span><br><span class="line">				&#123;</span><br><span class="line">					point1.Add(links.Key);</span><br><span class="line">					point2.Add(end.Key);</span><br><span class="line">					dist.Add(end.Value);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		else</span><br><span class="line">		&#123;</span><br><span class="line">			SetGraph(ref point1, ref point2, ref dist);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	void SetGraph(ref List&lt;int&gt; startPoints, ref List&lt;int&gt; endPoints, ref List&lt;float&gt; dist)</span><br><span class="line">	&#123;</span><br><span class="line">		graph.Clear();</span><br><span class="line">		weightedGraph.Clear();</span><br><span class="line">		int startIndex &#x3D; 0, endIndex &#x3D; 0;</span><br><span class="line">		float distance &#x3D; 0;</span><br><span class="line">		for(int i&#x3D;0; i&lt;startPoints.Count; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			graph.Add(new List&lt;Point&gt;());</span><br><span class="line">		&#125;</span><br><span class="line">		for(int i&#x3D;0; i&lt;startPoints.Count; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			startIndex &#x3D; startPoints[i];</span><br><span class="line">			endIndex &#x3D; endPoints[i];</span><br><span class="line">			distance &#x3D; dist[i];</span><br><span class="line">			if(!weightedGraph.TryGetValue(startIndex, out var pointDist))</span><br><span class="line">			&#123;</span><br><span class="line">				pointDist &#x3D; new Dictionary&lt;int, float&gt;();</span><br><span class="line">				weightedGraph[startIndex] &#x3D; pointDist;</span><br><span class="line">			&#125;</span><br><span class="line">			pointDist[endIndex] &#x3D; distance;</span><br><span class="line">			var edges &#x3D; graph[startIndex];</span><br><span class="line">			edges.Add(allPoints[endIndex]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	void CalculateGraph()</span><br><span class="line">	&#123;</span><br><span class="line">		List&lt;Point&gt; others &#x3D; new List&lt;Point&gt;();</span><br><span class="line">		for(int i&#x3D; 0;i&lt;allPoints.Count;++i)</span><br><span class="line">		&#123;</span><br><span class="line">			Point point &#x3D; allPoints[i];</span><br><span class="line">			others.Clear();</span><br><span class="line">			others.AddRange(allPoints);</span><br><span class="line">			others.RemoveAt(i);</span><br><span class="line">			var connected &#x3D; RotationalSweep(point, ohters, allPoints);</span><br><span class="line">			connected &#x3D; RemoveNeedlessConnected(point, connected);</span><br><span class="line">			graph.Add(connected);</span><br><span class="line">		&#125;</span><br><span class="line">		for(int i&#x3D;0;i&lt;graph.Count; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			Dictionary&lt;int, float&gt; pointDist &#x3D; new Dictionary&lt;int, float&gt;();</span><br><span class="line">			Point point &#x3D; allPoints[i];</span><br><span class="line">			foreach(var g in graph[i])</span><br><span class="line">			&#123;</span><br><span class="line">				pintDist.Add(g.index, Point.Distance(point, g));</span><br><span class="line">			&#125;</span><br><span class="line">			weightedGraph.Add(point.index, pointDist);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	Point tempP1 &#x3D; new Point();</span><br><span class="line">	Point tempP2 &#x3D; new Point();</span><br><span class="line">	public bool CandirectlyLink(Vector2 point1, Vector2 point2)</span><br><span class="line">	&#123;</span><br><span class="line">		foreach(var p in allPoints)</span><br><span class="line">		&#123;</span><br><span class="line">			var rst &#x3D; LinesIntersect(point1, point2, p.edge1.point1, p.edge1.point2);</span><br><span class="line">			if(rst !&#x3D; null)</span><br><span class="line">			&#123;</span><br><span class="line">				if(rst.alongA &#x3D;&#x3D;0 &amp;&amp; rst.alongB &#x3D;&#x3D; 0) return false;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line">	public bool FindPath(Vector2 point1, Vector2 point2, ref List&lt;Vector2&gt; paths)</span><br><span class="line">	&#123;</span><br><span class="line">		tempP1.Set(ref point1);</span><br><span class="line">		tempP2.Set(ref point2);</span><br><span class="line">		tempP1.maxAngle &#x3D; 1000;</span><br><span class="line">		tempP2.maxAngle &#x3D; 1000;</span><br><span class="line">		return FindPath(tempP1, tempP2, ref paths);</span><br><span class="line">	&#125;</span><br><span class="line">	bool FindPath(Point point1, Point point2, ref List&lt;Vector2&gt; paths)</span><br><span class="line">	&#123;</span><br><span class="line">		paths.Clear();</span><br><span class="line">		List&lt;Point&gt; others &#x3D; new List&lt;Point&gt;();</span><br><span class="line">		others.AddRange(allPoints);</span><br><span class="line">		List&lt;Point&gt; searched1 &#x3D; RotationalSweep(point1, others, allPoints);</span><br><span class="line">		if(searched1.Count &#x3D;&#x3D; 0) return false;</span><br><span class="line">		others.Clear();</span><br><span class="line">		other.AddRange(allPoints);</span><br><span class="line">		List&lt;Point&gt; searched2 &#x3D; RotationalSweep(point2, others, allPoints);</span><br><span class="line">		if(searched2.Count &#x3D;&#x3D; 0) return false;</span><br><span class="line"></span><br><span class="line">		InsertWeightGraph(point1, searched1);</span><br><span class="line">		InsertWeightGraph(point2, searched2);</span><br><span class="line"></span><br><span class="line">		ProorityQueue&lt;int&gt; frontier &#x3D; new PriorityQueue&lt;int&gt;(true);</span><br><span class="line">		frontier.Enqueue(0, point1.index);</span><br><span class="line">		Dictionary&lt;int, int&gt; cameFrom &#x3D; new Dictionary&lt;int,int&gt;();</span><br><span class="line">		Dictionary&lt;int, float&gt; costSoFar &#x3D; new Dictionary&lt;int, float&gt;();</span><br><span class="line">		cameForm[point1.index]&#x3D;-1;</span><br><span class="line">		costSoFar[point1.index] &#x3D; 0;</span><br><span class="line">		while(frontier.Count !&#x3D; 0)</span><br><span class="line">		&#123;</span><br><span class="line">			var current &#x3D; frontier.Dequeue();</span><br><span class="line">			if(current &#x3D;&#x3D; point2.index) break;</span><br><span class="line">			var neightbors &#x3D; weightedGraph[current];</span><br><span class="line">			foreach(var next in neightbors)</span><br><span class="line">			&#123;</span><br><span class="line">				float newCost &#x3D; costSorFar[current] + next.Value;</span><br><span class="line">				if(!cameFrom.ContainsKey(next.Key) || newCost &lt; costSorFar[next.Key])</span><br><span class="line">				&#123;</span><br><span class="line">					costSorFar[next.Key] &#x3D; new Cost;</span><br><span class="line">					frontier.Enqueue(newCost, next.Key);</span><br><span class="line">					cameFrom[next.Key] &#x3D; current;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		List&lt;int&gt; indices &#x3D; new List&lt;int&gt;();</span><br><span class="line">		int end &#x3D; point2.index;</span><br><span class="line">		while(end!&#x3D;-1)</span><br><span class="line">		&#123;</span><br><span class="line">			indices.Add(end);</span><br><span class="line">			end &#x3D; cameForm[end];</span><br><span class="line">		&#125;</span><br><span class="line">		for(int i&#x3D;indices.Count - 1;i&gt;&#x3D;0;--i)</span><br><span class="line">		&#123;</span><br><span class="line">			paths.Add(allPoints[indices[i]].ToVector2());</span><br><span class="line">		&#125;</span><br><span class="line">		RemoveWeightGraph(point2);</span><br><span class="line">		RemoveWeightGraph(point1);</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	void InsertWeightGraph(Point point, List&lt;Point&gt; linkedPoints)</span><br><span class="line">	&#123;</span><br><span class="line">		point.index &#x3D; allPoints.Count;</span><br><span class="line">		allPoints.Add(point);</span><br><span class="line">		Dictionary&lt;int, float&gt; pointDist &#x3D; new Dictionary&lt;int, float&gt;();</span><br><span class="line">		foreach(var s in linkedPoints)</span><br><span class="line">		&#123;</span><br><span class="line">			float dist &#x3D; Point.Distance(s, point);</span><br><span class="line">			pointDist.Add(s.index, dist);</span><br><span class="line">			weightedGraph[s.index].Add(point.index, dist);</span><br><span class="line">		&#125;</span><br><span class="line">		weightedGraph.Add(point.index, pointDist);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	void RemoveWeightGraph(Point point)</span><br><span class="line">	&#123;</span><br><span class="line">		allPoints.RemoveAt(point.index);</span><br><span class="line">		Dictionary&lt;int, float&gt; pointDist &#x3D; weightedGraph[point.index];</span><br><span class="line">		foreach(var v in pointDist)</span><br><span class="line">		&#123;</span><br><span class="line">			weightedGraph[v.Key].Remove(point.index);</span><br><span class="line">		&#125;</span><br><span class="line">		pointDist.Clear();</span><br><span class="line">		weightedGraph.Remove(point.index);</span><br><span class="line">	&#125;</span><br><span class="line">	public void GetMesh(ref List&lt;Vector3&gt; vertices, ref List&lt;int&gt; indices, bool clear &#x3D; false)</span><br><span class="line">	&#123;</span><br><span class="line">		if(clear)</span><br><span class="line">		&#123;</span><br><span class="line">			vertices.Clear();</span><br><span class="line">			indices.Clear();</span><br><span class="line">		&#125;</span><br><span class="line">		int index &#x3D; indices.Count;</span><br><span class="line">		for(int i&#x3D;0;i&lt;allPoints.Count;++i)</span><br><span class="line">		&#123;</span><br><span class="line">			Point point &#x3D; allPoints[i];</span><br><span class="line">			foreach(var g in graph[i])</span><br><span class="line">			&#123;</span><br><span class="line">				vertices.Add(point.ToVector3());</span><br><span class="line">				vertices.Add(g.ToVector3());</span><br><span class="line">				indices.Add(index++);</span><br><span class="line">				indices.Add(index++);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	List&lt;Point&gt; RemoveNeedlessConnected(Point point, List&lt;Point&gt; points)</span><br><span class="line">	&#123;</span><br><span class="line">		List&lt;Point&gt; temp &#x3D; new List&lt;Point&gt;();</span><br><span class="line">		foreach(var p in points)</span><br><span class="line">		&#123;</span><br><span class="line">			if(point &#x3D;&#x3D; p.edge1.point1 || point &#x3D;&#x3D; p.edge2.point2)</span><br><span class="line">			&#123;</span><br><span class="line">				temp.Add(p);</span><br><span class="line">			&#125;</span><br><span class="line">			else if(!points.Contains(p.edge1.point1) || !points.Contains(p.edge2.point2))</span><br><span class="line">			&#123;</span><br><span class="line">				if(!(point.maxAngle &lt; Mathf.PI || p.maxAngle &lt; Mathf.PI))</span><br><span class="line">					temp.Add(p);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		points &#x3D; temp;</span><br><span class="line">		return points;</span><br><span class="line">	&#125;</span><br><span class="line">	List&lt;Point&gt; RotationalSweep(Point point, List&lt;Point&gt; others, List&lt;Point&gt; all)</span><br><span class="line">	&#123;</span><br><span class="line">		Point right &#x3D; new Point(10000+point.x, point.y);</span><br><span class="line">		foreach(var p in others)</span><br><span class="line">		&#123;</span><br><span class="line">			Vector2 dir &#x3D; new Vector(p.x - point.x, p.y - point.y).normalized;</span><br><span class="line">			float dot &#x3D; PolygonHelp.Dot(Vector.right, dir);</span><br><span class="line">			float anlge &#x3D; Mathf.Acos(dot);</span><br><span class="line">			if(dir.y&lt;0) angle &#x3D; 2 * Mathf.PI - angle;</span><br><span class="line">			p.angle &#x3D; angle;</span><br><span class="line">		&#125;</span><br><span class="line">		SortHelp.QuickSort&lt;Point&gt;(others, o, others.Count - , (a, b) &#x3D;&gt;</span><br><span class="line">		&#123;</span><br><span class="line">			return a.angle &lt; b.angle;</span><br><span class="line">		&#125;);</span><br><span class="line">		List&lt;Edge&gt; edges &#x3D; new List&lt;Edge&gt;();</span><br><span class="line">		foreach(var p in all)</span><br><span class="line">		&#123;</span><br><span class="line">			var rst &#x3D; LinesIntersect(point, right, p. edge1.point1, p.edge1.point2);</span><br><span class="line">			if(rst!&#x3D;null)</span><br><span class="line">			&#123;</span><br><span class="line">				if(rst.angleA &#x3D;&#x3D; 0 &amp;&amp; rst.angleB &#x3D;&#x3D;0)</span><br><span class="line">				&#123;</span><br><span class="line">					if(!edges.Contains(p.edge1))</span><br><span class="line">					&#123;</span><br><span class="line">						edges.Add(p.edge1);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		bool visible &#x3D; false;</span><br><span class="line">		List&lt;Point&gt; visiblePoint &#x3D; new List&lt;Point&gt;();</span><br><span class="line">		foreach(var p in others)</span><br><span class="line">		&#123;</span><br><span class="line">			if(point &#x3D;&#x3D; p.edge1.point1 || point &#x3D;&#x3D; p.edge2.point2)&#123;</span><br><span class="line">				visible &#x3D; true;</span><br><span class="line">			&#125;</span><br><span class="line">			else</span><br><span class="line">			&#123;</span><br><span class="line">				if(point.maxAngle &lt; Mathf.PI || point.maxAngle&lt;Mathf.PI)</span><br><span class="line">				&#123;</span><br><span class="line">					visible &#x3D; false;</span><br><span class="line">				&#125;</span><br><span class="line">				else</span><br><span class="line">				&#123;</span><br><span class="line">					visible &#x3D; true;</span><br><span class="line">					foreach(var edge in edges)</span><br><span class="line">					&#123;</span><br><span class="line">						var rst &#x3D; LinesIntersect(point, p, edge.point1, point2)</span><br><span class="line">						if(rst !&#x3D; null)</span><br><span class="line">						&#123;</span><br><span class="line">							if(rst.alongA &#x3D;&#x3D;0 &amp;&amp; rst.alongB &#x3D;&#x3D; 0)</span><br><span class="line">							&#123;</span><br><span class="line">								visible &#x3D; false;</span><br><span class="line">								break;</span><br><span class="line">							&#125;</span><br><span class="line">							else</span><br><span class="line">							&#123;</span><br><span class="line">								if(point.edge1 !&#x3D; null)</span><br><span class="line">								&#123;</span><br><span class="line">									Vertor2 dir1 &#x3D; point.edge1.point1.ToVector2() - point.ToVector2();</span><br><span class="line">									Vector2 dir2 &#x3D; p.ToVector2() - point.ToVector2();</span><br><span class="line">									float angle &#x3D; PolygonHelp.SignedAngle0_2PI(dir1, dir2);</span><br><span class="line">									if(angle &gt; point.maxAngle)</span><br><span class="line">									&#123;</span><br><span class="line">										visible &#x3D; false;</span><br><span class="line">										break;</span><br><span class="line">									&#125;</span><br><span class="line">								&#125;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			if(visible)</span><br><span class="line">			&#123;</span><br><span class="line">				if(point.edge1 !&#x3D;null)</span><br><span class="line">				&#123;</span><br><span class="line">					Vector2 dir1 &#x3D; point.edge1.point1.ToVector2() - point.ToVector2();</span><br><span class="line">					Vector2 dir2 &#x3D; p.ToVector2() - point.ToVector();</span><br><span class="line">					float angle &#x3D; PolygonHelp.SignedAngle0_2PI(dir1, dir2);</span><br><span class="line">					if(angle &gt; point.maxAngle)</span><br><span class="line">					&#123;</span><br><span class="line">						visible &#x3D; false;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			if(visible)</span><br><span class="line">			&#123;</span><br><span class="line">				Vector2 dir &#x3D; p.ToVector2() - point.ToVector();</span><br><span class="line">				Vector2 dir1 &#x3D; p.edge1.point1.ToVector2() - point.ToVector2();</span><br><span class="line">				Vector2 dir2 &#x3D; p.edge2.point2.ToVector2() - point.ToVector2();</span><br><span class="line">				float cross1 &#x3D; PolygonHelp.Corss(dir1, dir);</span><br><span class="line">				float cross2 &#x3D; PolygonHelp.Cross(dir2, dir);</span><br><span class="line">				if((cross1 &gt; 0 &amp;&amp; cross2&lt; 0) || (corss2&gt;0 &amp;&amp; cross1 &lt; 0))</span><br><span class="line">				&#123;</span><br><span class="line">					visible &#x3D; false;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			if(visible)</span><br><span class="line">			&#123;</span><br><span class="line">				visiblePoint.Add(p);</span><br><span class="line">			&#125;</span><br><span class="line">			if(edges.Contains(p.edge1)) edges.Remove(p.edge1);</span><br><span class="line">			else edges.Add(p.edge1);</span><br><span class="line">			if(edges.Contains(p.edge2)) edges.Remove(p.edge2);</span><br><span class="line">			else edges.Add(p.edge2);</span><br><span class="line">		&#125;</span><br><span class="line">		return visiblePoint;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	linesIntersect LinesIntersect(Point a0, Pointa1, Point b0, Point b1, float eps &#x3D; 0.000001f)</span><br><span class="line">	&#123;</span><br><span class="line">		var adx &#x3D; a1.x - a0.x;</span><br><span class="line">		var ady &#x3D; a1.y - a0.y;</span><br><span class="line">		var bdx &#x3D; b1.x - b0.x;</span><br><span class="line">		var bdy &#x3D; b1.y - b0.y;</span><br><span class="line"></span><br><span class="line">		var axb &#x3D; adx * bdy - ady * bdx;</span><br><span class="line">		if(Mathf.Abs(axb) &lt; eps)  return null;</span><br><span class="line"></span><br><span class="line">		var dx &#x3D; a0.x - b0.x;</span><br><span class="line">		var dy &#x3D; a0.y - b0.y;</span><br><span class="line">		var A &#x3D; (bdx * dy - bdy * dx) &#x2F; axb;</span><br><span class="line">		var B &#x3D; (adx * dy - ady * dx) &#x2F; axb;</span><br><span class="line">		linesIntersect ret &#x3D; new linesInterset()</span><br><span class="line">		&#123;</span><br><span class="line">			alongA &#x3D; 0,</span><br><span class="line">			alongB &#x3D; 0, </span><br><span class="line">			pt &#x3D; new Vector2(a0.x + A * adx, a0.y + A * ady)</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		if(A&lt;&#x3D; -eps) ret.alongA &#x3D; -2;</span><br><span class="line">		else if (A &lt; eps) ret.alongA &#x3D; -1;</span><br><span class="line">		else if (A - 1 &lt;&#x3D; -eps) ret.alongA &#x3D; 0;</span><br><span class="line">		else if (A - 1 &lt; eps) ret.alongA &#x3D; 1;</span><br><span class="line">		else ret.alongA &#x3D; 2;</span><br><span class="line"></span><br><span class="line">		if(B&lt;&#x3D; -eps) ret.alongB &#x3D; -2;</span><br><span class="line">		else if (B&lt; eps) ret.alongB &#x3D; -1;</span><br><span class="line">		else if (B - 1&lt;&#x3D; -eps) ret.alongB &#x3D; 0;</span><br><span class="line">		else if (B - 1 &lt; eps) ret.alongB &#x3D; 1;</span><br><span class="line">		else ret.alongB &#x3D; 2;</span><br><span class="line">		return ret;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">public class PriorityQueue&lt;T&gt;</span><br><span class="line">&#123;</span><br><span class="line">	class Node</span><br><span class="line">	&#123;</span><br><span class="line">		public float Priority&#123;get;set;&#125;</span><br><span class="line">		public T Object&#123;get;set;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	List&lt;Node&gt; queue &#x3D; new List&lt;Node&gt;();</span><br><span class="line">	int heapSize &#x3D; -1;</span><br><span class="line">	bool _isMinPriorityQueue;</span><br><span class="line">	public int Count &#123; get &#123; return queue.Count; &#125; &#125;</span><br><span class="line">	public PriorityQueue(bool isMinPriorityQueue &#x3D; true) </span><br><span class="line">	&#123;</span><br><span class="line">		_isMinPriorityQueue &#x3D; isMinPriorityQueue;</span><br><span class="line">	&#125;</span><br><span class="line">	public void Enqueue(float priority, T obj)</span><br><span class="line">	&#123;</span><br><span class="line">		Node node &#x3D; new Node()</span><br><span class="line">		&#123;</span><br><span class="line">			Priority &#x3D; priority, </span><br><span class="line">			Object &#x3D; obj</span><br><span class="line">		&#125;;</span><br><span class="line">		queue.Add(node);</span><br><span class="line">		++heapSize;</span><br><span class="line">		if(_isMinPriorityQueue)</span><br><span class="line">			BuildHeapMin(heapSize);</span><br><span class="line">		else</span><br><span class="line">			BuildHeapMax(heapSize);</span><br><span class="line">	&#125;</span><br><span class="line">	public T Dequeue()</span><br><span class="line">	&#123;</span><br><span class="line">		if(heapSize &gt; -1)</span><br><span class="line">		&#123;</span><br><span class="line">			var returnVal &#x3D; queue[0].Object;</span><br><span class="line">			queue[0] &#x3D; queue[heapSize];</span><br><span class="line">			queue.RemoveAt(heapSize);</span><br><span class="line">			--heapSize;</span><br><span class="line">			if(_isMinPriorityQueue) MinHeapify(0);</span><br><span class="line">			else MaxHeapify(0);</span><br><span class="line">			return returnVal;</span><br><span class="line">		&#125;</span><br><span class="line">		else </span><br><span class="line">			throw new Exception(&quot;Queue is empty&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">	public void UpdatePriority(T obj, float priority)</span><br><span class="line">	&#123;</span><br><span class="line">		for(int i&#x3D;0;i&lt;&#x3D;heapSize;++i)</span><br><span class="line">		&#123;</span><br><span class="line">			Node node &#x3D; queue[i];</span><br><span class="line">			if(Object.ReferenceEquals(node.Object, obj))</span><br><span class="line">			&#123;</span><br><span class="line">				node.Priority &#x3D; priority;</span><br><span class="line">				if(_isMinPriorityQueue)</span><br><span class="line">				&#123;</span><br><span class="line">					BuildHeapMin(i)</span><br><span class="line">					MinHeapify(i);</span><br><span class="line">				&#125;</span><br><span class="line">				else</span><br><span class="line">				&#123;</span><br><span class="line">					BuildHeapMax(i);</span><br><span class="line">					MaxHeapify(i);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public bool IsInQueue(T obj)</span><br><span class="line">	&#123;</span><br><span class="line">		foreach(Node node in queue)</span><br><span class="line">		&#123;</span><br><span class="line">			if(object.ReferenceEquals(node.Object, obj)) return true;</span><br><span class="line">		&#125;</span><br><span class="line">		return false;</span><br><span class="line">	&#125;</span><br><span class="line">	private void BuidlHeapMax(int i)</span><br><span class="line">	&#123;</span><br><span class="line">		while(i&gt;&#x3D;0 &amp;&amp; queue[(i-1)&#x2F;2].Priority &lt; queue[i].Priority)</span><br><span class="line">		&#123;</span><br><span class="line">			Swap(i, (i-1)&#x2F;2);</span><br><span class="line">			i&#x3D;(i-1)&#x2F;2;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	private void BuildHeapMin(int i)</span><br><span class="line">	&#123;</span><br><span class="line">		while(i&gt;&#x3D;0 &amp;&amp; queue[(i-1)&#x2F;2].Priority &gt; queue[i].Priority)</span><br><span class="line">		&#123;</span><br><span class="line">			Swap(i, (i-1)&#x2F;2);</span><br><span class="line">			i&#x3D;(i-1)&#x2F;2;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	private void MaxHeapify(int i)</span><br><span class="line">	&#123;</span><br><span class="line">		int left &#x3D; ChildL(i);</span><br><span class="line">		int reft &#x3D; ChildR(i);</span><br><span class="line">		int heightst&#x3D; i;</span><br><span class="line">		if(left&lt;&#x3D;heapSize &amp;&amp; queue[heightst].Priority &lt; queue[left].Priority)</span><br><span class="line">			heightst&#x3D; left;</span><br><span class="line">		if(ritht &lt;&#x3D; heapSize &amp;&amp; queue[heightst].Priority &lt; queue[right].Priority)</span><br><span class="line">			heightst &#x3D; right;</span><br><span class="line">		if(heightst !&#x3D;i)</span><br><span class="line">		&#123;</span><br><span class="line">			Swap(heightst, i);</span><br><span class="line">			MaxHeapify(heightst);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	private void MinHeapify(int i)</span><br><span class="line">	&#123;</span><br><span class="line">		int left &#x3D; ChildL(i);</span><br><span class="line">		int reft &#x3D; ChildR(i);</span><br><span class="line">		int heightst&#x3D; i;</span><br><span class="line">		if(left&lt;&#x3D;heapSize &amp;&amp; queue[heightst].Priority &gt; queue[left].Priority)</span><br><span class="line">			heightst&#x3D; left;</span><br><span class="line">		if(ritht &lt;&#x3D; heapSize &amp;&amp; queue[heightst].Priority &gt; queue[right].Priority)</span><br><span class="line">			heightst &#x3D; right;</span><br><span class="line">		if(heightst !&#x3D;i)</span><br><span class="line">		&#123;</span><br><span class="line">			Swap(heightst, i);</span><br><span class="line">			MinHeapify(heightst);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private void Swap(int i, int j)</span><br><span class="line">	&#123;</span><br><span class="line">		var temp &#x3D; queue[i];</span><br><span class="line">		quque[i] &#x3D; queue[j];</span><br><span class="line">		queue[j] &#x3D; temp;</span><br><span class="line">	&#125;</span><br><span class="line">	private int ChildL(int i)</span><br><span class="line">	&#123;</span><br><span class="line">		return i*2 +1;</span><br><span class="line">	&#125;</span><br><span class="line">	private int ChildR(int i)</span><br><span class="line">	&#123;</span><br><span class="line">		return i*2 +2;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[Serializable]</span><br><span class="line">public class PathBoundary</span><br><span class="line">&#123;</span><br><span class="line">	public Vector2 min;</span><br><span class="line">	public Vector2 max;</span><br><span class="line">	public List&lt;Vector2&gt; polygon &#x3D; new List&lt;Vector2&gt;();</span><br><span class="line">	public List&lt;Vector3&gt; GetPolygon3()</span><br><span class="line">	&#123;</span><br><span class="line">		List&lt;Vector3&gt; vector3s &#x3D; new List&lt;Vector3&gt;();</span><br><span class="line">		foreach(var p in polygon)</span><br><span class="line">		&#123;</span><br><span class="line">			vector3s.Add(new Vector3(p.x, 0, p.y));</span><br><span class="line">		&#125;</span><br><span class="line">		return vector3s;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">[Serializable]</span><br><span class="line">public class PathData</span><br><span class="line">&#123;</span><br><span class="line">	public PathBoundary boundary;</span><br><span class="line">	public List&lt;PathBoundary&gt; obstacles &#x3D; new List&lt;PathBoundary&gt;();</span><br><span class="line">	public List&lt;PathBoundary&gt; buildAreas &#x3D; new List&lt;PathBoundary&gt;();</span><br><span class="line">	public List&lt;int&gt; startPoints &#x3D; new List&lt;int&gt;();</span><br><span class="line">	public List&lt;int&gt; endPoints &#x3D; new List&lt;int&gt;();</span><br><span class="line">	public List&lt;float&gt; edgeLens &#x3D; new List&lt;float&gt;();</span><br><span class="line">&#125;</span><br><span class="line">[Serializable]</span><br><span class="line">public class PathDataHandle</span><br><span class="line">&#123;</span><br><span class="line">	public List&lt;PathData&gt; pathDatas &#x3D; new List&lt;PathData&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br></pre></td><td class="code"><pre><span class="line">public class PathGraphs</span><br><span class="line">&#123;</span><br><span class="line">	private const string folder &#x3D; &quot;PathData;</span><br><span class="line">	static PathGraphMgr _instance;</span><br><span class="line">	public static PathGraphMgr Instance</span><br><span class="line">	&#123;</span><br><span class="line">		get</span><br><span class="line">		&#123;</span><br><span class="line">			if(_instance&#x3D;&#x3D;null)</span><br><span class="line">			&#123;</span><br><span class="line">				_instance &#x3D; new PathGraphMgr();</span><br><span class="line">			&#125;</span><br><span class="line">			return _instance;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	private PathGraphMgr()</span><br><span class="line">	&#123;</span><br><span class="line">		InitData();</span><br><span class="line">	&#125;</span><br><span class="line">	public PathDataHandle pathDataHandle;</span><br><span class="line">	void InitData()</span><br><span class="line">	&#123;</span><br><span class="line">		pathDataHandle &#x3D; GetPathData();</span><br><span class="line">		for(int i &#x3D;0;i&lt;pathDataHandle.pathDatas.Count; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			pathGraphs.Add(new PathGraph());</span><br><span class="line">		&#125;</span><br><span class="line">		BuildGraph(false);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	bool IsInTherSameRegion(Vector2 point1, Vector2 point2, Out PathData data)</span><br><span class="line">	&#123;</span><br><span class="line">		data &#x3D; null;</span><br><span class="line">		List&lt;PathData&gt; pathDatas1 &#x3D; new List&lt;PathData&gt;();</span><br><span class="line">		if(!FindPathData(pathDataHandle, point1, ref pathDatas1)) return false;</span><br><span class="line">		List&lt;PathData&gt; pathDatas2 &#x3D; new List&lt;PathData&gt;();</span><br><span class="line">		if(!FindPathData(pathDataHandle, point1, ref pathDatas2)) return false;</span><br><span class="line">		data &#x3D; pathDatas1[0];</span><br><span class="line">		return pathDatas1[0] &#x3D;&#x3D; pathDatas2[0];</span><br><span class="line">	&#125;</span><br><span class="line">	bool CanDirectlyLink(Vector2 point1, Vector2 point2, PathGraph pathGraph)</span><br><span class="line">	&#123;</span><br><span class="line">		return pathGraph.CanDirectlyLink(point1, point2);</span><br><span class="line">	&#125;</span><br><span class="line">	public bool FindPath(Vector2 point1, Vector2 point2, ref List&lt;Vector2&gt; paths)</span><br><span class="line">	&#123;</span><br><span class="line">		if(!IsInTheSameRegion(point1, point2, out var pathData)) return false;</span><br><span class="line">		int index &#x3D; pathDataHandle.pathDatas.FindIndex((data)&#x3D;&gt;&#123;return pathData &#x3D;&#x3D; data;&#125;);</span><br><span class="line">		var pathGraph &#x3D; pathGraphs[index];</span><br><span class="line">		paths.Clear();</span><br><span class="line">		if(!CanDireclyLink(point1, point2, pathGraph))</span><br><span class="line">			return pathGraph.FindPath(point1, point2, ref paths);</span><br><span class="line">		paths.Add(point1);</span><br><span class="line">		paths.Add(point2);</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line">	public void BuildGraph(bool forceToRebuild &#x3D; true)</span><br><span class="line">	&#123;</span><br><span class="line">		for(int i &#x3D;0; i&lt; pathDataHandle.pathDatas.Count;++i)</span><br><span class="line">		&#123;</span><br><span class="line">			var pathData &#x3D; pathDataHandle.pathDatas[i];</span><br><span class="line">			var pathGraph &#x3D; pathGraphs[i];</span><br><span class="line">			pathGraph.InitPolygons(pathData.boundary, pathData.obstacles);</span><br><span class="line">			pathGraph.Graph(ref pathData.startPoints, ref pathData.endpoints, ref pathData.edgeLens, ref forceToRebuild);</span><br><span class="line">		&#125;</span><br><span class="line">		if(forceToRebuild) SaveData();</span><br><span class="line">	&#125;</span><br><span class="line">	public bool FindPathData(Vector point, ref List&lt;PathData&gt; pathDatas, ref List&lt;PathBoundary&gt; rst)</span><br><span class="line">	&#123;</span><br><span class="line">		is(!FindPathData(pathDataHandle, point, ref pathDatas)) return false;</span><br><span class="line">		if(pathDatas.Count &gt; 1) Debug.LogError(&quot;error&quot;);</span><br><span class="line">		List&lt;PathBoundary&gt; pathBoundary &#x3D; new List&lt;PathBoundary&gt;();</span><br><span class="line">		if(!FindPathData(pathDatas[0], point, ref pathBoundary))</span><br><span class="line">		&#123;</span><br><span class="line">			rst.Add(pathDatas[0].boundary);</span><br><span class="line">		&#125;</span><br><span class="line">		else</span><br><span class="line">		&#123;</span><br><span class="line">			if(pathBoundary.Count &gt; 1) Debug.LogError(&quot;error&quot;);</span><br><span class="line">			rst.Add(pathBoundary[0]);</span><br><span class="line">		&#125;</span><br><span class="line">		return true;</span><br><span class="line">	&#125;</span><br><span class="line">	public bool FindPathData(PathDataHandle data, Vector2 point, ref List&lt;PathData&gt; rst)</span><br><span class="line">	&#123;</span><br><span class="line">		if(rst.Count &gt; 0) rst.Clear();</span><br><span class="line">		Vector2 min, max;</span><br><span class="line">		foreach(var pathdata in data.pathDatas)</span><br><span class="line">		&#123;</span><br><span class="line">			max &#x3D; pathdata.boundary.max;</span><br><span class="line">			min &#x3D; pathdata.boundary.min;</span><br><span class="line">			if(point.x&lt;max.x &amp;&amp; point.x&gt;min.x &amp;&amp; point.y&lt;max.y &amp;&amp; point.y&gt;min.y)</span><br><span class="line">			&#123;</span><br><span class="line">				if(PolygonHelp.PointInsideRegion(point, pathData.boundary.polygon))</span><br><span class="line">					rst.Add(pathdata);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return rst.Count &gt; 0;</span><br><span class="line">	&#125;</span><br><span class="line">	public bool FindPathData(PathData data, Vector2 point, ref List&lt;PathBoundary&gt; pathBoundary)</span><br><span class="line">	&#123;</span><br><span class="line">		int count &#x3D;0;</span><br><span class="line">		vector2 min, max;</span><br><span class="line">		foreach(var pathdata in data.obstales)</span><br><span class="line">		&#123;</span><br><span class="line">			max &#x3D; pathdata.max;</span><br><span class="line">			min &#x3D; pathdata.min;</span><br><span class="line">			if(point.x &lt; max.x &amp;&amp; point.x&gt;min.x &amp;&amp; point.y &lt; max.y &amp;&amp; point.y&gt;min.y)</span><br><span class="line">			&#123;</span><br><span class="line">				if(PolygonHelp.PointInsideRegion(point, pathdata.polygon))</span><br><span class="line">				&#123;</span><br><span class="line">					pathBoundary.Add(pathdata);</span><br><span class="line">					++count;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	System.Random random &#x3D; new System.Random(DateTime.Now.Millisecond);</span><br><span class="line">	public Vector2 GetRandomPos()</span><br><span class="line">	&#123;</span><br><span class="line">		int index &#x3D; random.Next(0, pathDataHandle.pathDatas.Count - 1);</span><br><span class="line">		var pathdata &#x3D; pathDataHandle.pathDatas[index];</span><br><span class="line">		Vector2 min, max;</span><br><span class="line">		bool inTherRegion &#x3D; false;</span><br><span class="line">		Vector2 point &#x3D; new Vector2();</span><br><span class="line">		while(true)</span><br><span class="line">		&#123;</span><br><span class="line">			point.x &#x3D; random.Next((int)(pathdata.boundary.min.x * 100), (int)(pathdata.boundary.max.x * 100))&#x2F;100.0f;</span><br><span class="line">			point.y &#x3D; random.Next((int)(pathdata.boundary.min.y * 100), (int)(pathdata.boundary.max.y * 100))&#x2F;100.0f;</span><br><span class="line">			max &#x3D; pathdata.boundary.max;</span><br><span class="line">			min &#x3D; pathdata.boundary.min;</span><br><span class="line">			inTheRegion &#x3D; false;</span><br><span class="line">			if(point.x&lt;max.x&amp;&amp; point.x&gt;min.x &amp;&amp; point.y&lt;max.y&amp;&amp; point.y&gt;min.y)&#123;</span><br><span class="line">				inTheRegion &#x3D; PolygonHelp.PointInsideRegion(point, pathdata.boundary.polygon);</span><br><span class="line">			&#125;</span><br><span class="line">			if(!inTheRegion) continue;</span><br><span class="line">			inTheRegion &#x3D; false;</span><br><span class="line">			foreach(var obstacle in pahtdata.obstacles)</span><br><span class="line">			&#123;</span><br><span class="line">				max &#x3D; obstacle.max;</span><br><span class="line">				min &#x3D; obstacle.min;</span><br><span class="line">				if(point.x&lt;max.x &amp;&amp; point.x&gt;min.x &amp;&amp; point.y&lt; max.y &amp;&amp; point.y&gt;min.y)</span><br><span class="line">				&#123;</span><br><span class="line">					if(PolygonHelp.PointInsideRegion(point, obstacle.polygon))</span><br><span class="line">					&#123;</span><br><span class="line">						inTheRegion &#x3D; true;</span><br><span class="line">						break;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			if(inTheRegion) continue;</span><br><span class="line">			return point;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	public void RemoveBoundary(PathData pathData, PathBoundary boundary)</span><br><span class="line">	&#123;</span><br><span class="line">		if(pathData.boundary &#x3D;&#x3D; boundary) RemovePathData(PathData);</span><br><span class="line">		else RemoveObstacle(PathData, boundary);</span><br><span class="line">	&#125;</span><br><span class="line">	public void RemovePathData(PathData pathData)</span><br><span class="line">	&#123;</span><br><span class="line">		pathDataHandle.pathDatas.Remove(pathData);</span><br><span class="line">		SaveData();</span><br><span class="line">	&#125;</span><br><span class="line">	public void RemoveObstacle(PathData pathData, PathBoundary obstacle)</span><br><span class="line">	&#123;</span><br><span class="line">		pahtData.obstacles.Remove(obstacle);</span><br><span class="line">		SaveData();</span><br><span class="line">	&#125;</span><br><span class="line">	public void AddObstacle(List&lt;Vector3&gt; obstacle)</span><br><span class="line">	&#123;</span><br><span class="line">		PathBoundary boundary &#x3D; new PathBoundary();</span><br><span class="line">		List&lt;Vector2&gt; polygon &#x3D; boundary.polygon;</span><br><span class="line">		Vector2 min &#x3D; Vector2.positiveInfinity;</span><br><span class="line">		Vector2 max &#x3D; Vector2.negativeInfinity;</span><br><span class="line">		Vector2 temp;</span><br><span class="line">		foreach(var b in obstacle)</span><br><span class="line">		&#123;</span><br><span class="line">			temp &#x3D; new Vector2(b.x, b.z);</span><br><span class="line">			polygon.Add(temp);</span><br><span class="line">			min &#x3D; Vector2.Min(temp, min);</span><br><span class="line">			max &#x3D; Vector2.Max(temp, max);</span><br><span class="line">		&#125;</span><br><span class="line">		if(!PolygonHelp.ClockWise(polygon))</span><br><span class="line">			polygon.Reversy();</span><br><span class="line">		boundary.min &#x3D; min;</span><br><span class="line">		boundary.max &#x3D; max;</span><br><span class="line">		List&lt;PathData&gt; datas &#x3D; new List&lt;PathData&gt;();</span><br><span class="line">		if(!FindPathData(pathDataHandle, polgyon[0], ref datas)) return;</span><br><span class="line">		if(datas.Count&gt; 1) Debug.LogError(&quot;error&quot;);</span><br><span class="line">		datas[0].obstacles.Add(boundary);</span><br><span class="line">		SaveData();</span><br><span class="line">	&#125;</span><br><span class="line">	public void AddBoundary(List&lt;Vector3&gt; boundary)</span><br><span class="line">	&#123;</span><br><span class="line">		PathData pathData &#x3D; new PathData();</span><br><span class="line">		pathData.boundary &#x3D; new PathBoundary();</span><br><span class="line">		List&lt;Vector2&gt; polygon &#x3D; pathData.boundary.polygon;</span><br><span class="line">		Vector2 min &#x3D; Vector2.positiveInfinity;</span><br><span class="line">		Vector2 max &#x3D; Vector2.negativeInfinity;</span><br><span class="line">		Vector2 temp;</span><br><span class="line">		foreach(var b in boundary)</span><br><span class="line">		&#123;</span><br><span class="line">			temp &#x3D; new Vector2(b.x, b.z);</span><br><span class="line">			polygon.Add(temp);</span><br><span class="line">			min &#x3D; Vector2.Min(temp, min);</span><br><span class="line">			max &#x3D; Vector2.Max(temp, max);</span><br><span class="line">		&#125;</span><br><span class="line">		if(PolygonHelp.ClockWise(polygon))</span><br><span class="line">			polygon.Reversy();</span><br><span class="line">		pathData.boundary.min &#x3D; min;</span><br><span class="line">		pathData.boundary.max &#x3D; max;</span><br><span class="line">		pathDataHandle.pathDatas.Add(pathData);</span><br><span class="line">		SaveData();</span><br><span class="line">	&#125;</span><br><span class="line">	List&lt;Vector3&gt; verticesTemp &#x3D; new List&lt;Vector3&gt;();</span><br><span class="line">	List&lt;int&gt; indicesTemp &#x3D; new List&lt;int&gt;();</span><br><span class="line">	List&lt;Color&gt; colorsTemp &#x3D; new List&lt;Color&gt;();</span><br><span class="line">	public void GetAllMesh(out List&lt;Vector3&gt; vertices, out List&lt;int&gt; indices, out List&lt;Color&gt; colors)</span><br><span class="line">	&#123;</span><br><span class="line">		verticesTemp.Clear();</span><br><span class="line">		indicesTemp.Clear();</span><br><span class="line">		colorsTemp.Clear();</span><br><span class="line">		Color boundary &#x3D; Color.White;</span><br><span class="line">		Color obstacle &#x3D; Color.Green;</span><br><span class="line">		int index &#x3D; 0, count &#x3D;0, pre &#x3D;0;</span><br><span class="line">		List&lt;Vector2&gt; polygon;</span><br><span class="line">		foreach(var pathData in pahtDataHandle.pathDatas)</span><br><span class="line">		&#123;</span><br><span class="line">			polygon &#x3D; pathData.boundary.polygon;</span><br><span class="line">			count &#x3D; polygon.Count;</span><br><span class="line">			pre &#x3D; count - 1;</span><br><span class="line">			for(int i &#x3D;0;i&lt;count;pre &#x3D; i, ++i)</span><br><span class="line">			&#123;</span><br><span class="line">				verticesTemp.Add(new Vector3(polygon[pre].x, 0, polygon[pre].y));</span><br><span class="line">				verticesTemp.Add(new Vector3(polygon[i].x, 0, polygon[i].y));</span><br><span class="line">				indicesTemp.Add(index++);</span><br><span class="line">				indicesTemp.Add(index++);</span><br><span class="line">				colorsTemp.Add(boundary);</span><br><span class="line">				colorsTemp.Add(boundary);</span><br><span class="line">			&#125;</span><br><span class="line">			foreach(var obstacleData in pathData.obstacles)</span><br><span class="line">			&#123;</span><br><span class="line">				polygon &#x3D; obstacleData.polygon;</span><br><span class="line">				count &#x3D; polygon.Count;</span><br><span class="line">				pre &#x3D; count -1;</span><br><span class="line">				for(int i&#x3D;0;i&lt;count;pre &#x3D; i, ++i)</span><br><span class="line">				&#123;</span><br><span class="line">					verticesTemp.Add(new Vector3(polygon[pre].x, 0, polygon[pre].y));</span><br><span class="line">					verticesTemp.Add(new Vector3(polygon[i].x, 0, polygon[i].y));</span><br><span class="line">					indicesTemp.Add(index++);</span><br><span class="line">					indicesTemp.Add(index++);</span><br><span class="line">					colorsTemp.Add(obstacle);</span><br><span class="line">					colorsTemp.Add(obstacle);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		vertices &#x3D; verticesTemp;</span><br><span class="line">		indices &#x3D; indicesTemp;</span><br><span class="line">		colors &#x3D; colorsTemp;</span><br><span class="line">	&#125;</span><br><span class="line">	public void GetBoundaryMesh(out List&lt;Vector3&gt; vertices, out List&lt;int&gt; indices)</span><br><span class="line">	&#123;</span><br><span class="line">		verticesTemp.Clear();</span><br><span class="line">		indicesTemp.Clear();</span><br><span class="line">		int index &#x3D; 0, count &#x3D;0, pre &#x3D;0;</span><br><span class="line">		List&lt;Vector2&gt; polygon;</span><br><span class="line">		foreach(var pathData in pahtDataHandle.pathDatas)</span><br><span class="line">		&#123;</span><br><span class="line">			polygon &#x3D; pathData.boundary.polygon;</span><br><span class="line">			count &#x3D; polygon.Count;</span><br><span class="line">			pre &#x3D; count - 1;</span><br><span class="line">			for(int i &#x3D;0;i&lt;count;pre &#x3D; i, ++i)</span><br><span class="line">			&#123;</span><br><span class="line">				verticesTemp.Add(new Vector3(polygon[pre].x, 0, polygon[pre].y));</span><br><span class="line">				verticesTemp.Add(new Vector3(polygon[i].x, 0, polygon[i].y));</span><br><span class="line">				indicesTemp.Add(index++);</span><br><span class="line">				indicesTemp.Add(index++);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		vertices &#x3D; verticesTemp;</span><br><span class="line">		indices &#x3D; indicesTemp;</span><br><span class="line">	&#125;</span><br><span class="line">	public void GetObstacleMesh(out List&lt;Vector3&gt; vertices, out List&lt;int&gt; indices)</span><br><span class="line">	&#123;</span><br><span class="line">		verticesTemp.Clear();</span><br><span class="line">		indicesTemp.Clear();</span><br><span class="line">		int index &#x3D; 0, count &#x3D;0, pre &#x3D;0;</span><br><span class="line">		List&lt;Vector2&gt; polygon;</span><br><span class="line">		foreach(var pathData in pahtDataHandle.pathDatas)</span><br><span class="line">		&#123;</span><br><span class="line">			foreach(var obstacleData in pathData.obstacles)</span><br><span class="line">			&#123;</span><br><span class="line">				polygon &#x3D; obstacleData.polygon;</span><br><span class="line">				count &#x3D; polygon.Count;</span><br><span class="line">				pre &#x3D; count -1;</span><br><span class="line">				for(int i&#x3D;0;i&lt;count;pre &#x3D; i, ++i)</span><br><span class="line">				&#123;</span><br><span class="line">					verticesTemp.Add(new Vector3(polygon[pre].x, 0, polygon[pre].y));</span><br><span class="line">					verticesTemp.Add(new Vector3(polygon[i].x, 0, polygon[i].y));</span><br><span class="line">					indicesTemp.Add(index++);</span><br><span class="line">					indicesTemp.Add(index++);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		vertices &#x3D; verticesTemp;</span><br><span class="line">		indices &#x3D; indicesTemp;</span><br><span class="line">	&#125;</span><br><span class="line">	public void GetPathMesh(out List&lt;Vector3&gt; vertices, out List&lt;int&gt; indices)</span><br><span class="line">	&#123;</span><br><span class="line">		verticesTemp.Clear();</span><br><span class="line">		indicesTemp.Clear();</span><br><span class="line">		foreach(var pathGraph in pathGraphs)</span><br><span class="line">		&#123;</span><br><span class="line">			pathGraph.GetMesh(ref vertices, ref indices);</span><br><span class="line">		&#125;</span><br><span class="line">		vertices &#x3D; verticesTemp;</span><br><span class="line">		indices &#x3D; indicesTemp;</span><br><span class="line">	&#125;</span><br><span class="line">	string GetRootFolder()</span><br><span class="line">	&#123;</span><br><span class="line">		string folder &#x3D; Path.Combine(Directory.GetParent(Application.dataPaht).Parent.FullName, PathGraphMgr.folder);</span><br><span class="line">		if(!Directory.Exists(folder)) Directory.CreateDirectory(folder);</span><br><span class="line">		return folder;</span><br><span class="line">	&#125;</span><br><span class="line">	voi SaveUserData(PathDataHandle pathDataHandle)</span><br><span class="line">	&#123;</span><br><span class="line">		string fileName &#x3D; &quot;pathData&quot;;</span><br><span class="line">		stirng folder &#x3D; GetRootFolder();</span><br><span class="line">		string path &#x3D; Path.Combine(folder, stirng.Format(&quot;&#123;0&#125;.json&quot;, fileName));</span><br><span class="line">		StreamWriter file &#x3D; new StreamWriter(path);</span><br><span class="line">		file.Write(JsonUtility.ToJson(pathDataHandle));</span><br><span class="line">		file.Close();</span><br><span class="line">	&#125;</span><br><span class="line">	PathDataHandle GetPathData()</span><br><span class="line">	&#123;</span><br><span class="line">		string fileName &#x3D; &quot;pathData&quot;;</span><br><span class="line">		string folder &#x3D; GetRootFolder();</span><br><span class="line">		string path &#x3D; Path.Combine(folder, stirng.Format(&quot;&#123;0&#125;.json&quot;, fileName));</span><br><span class="line">		PathDataHandle pathDataHandle;</span><br><span class="line">		if(File.Exists(path))</span><br><span class="line">		&#123;</span><br><span class="line">			StreamReader file &#x3D; new StreamReader(path);</span><br><span class="line">			pathDataHandle &#x3D; JsonUtility.FromJson&lt;PathDataHandle&gt;(file.ReadToEnd());</span><br><span class="line">			file.Close();</span><br><span class="line">		&#125;</span><br><span class="line">		else</span><br><span class="line">		&#123;</span><br><span class="line">			pathDataHandle &#x3D; new PathDataHandle();</span><br><span class="line">		&#125;</span><br><span class="line">		return pathDataHandle;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2021/05/27/WebReference/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2021/05/27/WebReference/" class="post-title-link" itemprop="url">Web Reference</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-27 17:01:34" itemprop="dateCreated datePublished" datetime="2021-05-27T17:01:34+08:00">2021-05-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-17 19:12:22" itemprop="dateModified" datetime="2021-06-17T19:12:22+08:00">2021-06-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Geometry"><a href="#Geometry" class="headerlink" title="Geometry"></a>Geometry</h2><h3 id="Math"><a href="#Math" class="headerlink" title="Math"></a>Math</h3><p><a target="_blank" rel="noopener" href="http://www.songho.ca/opengl/gl_projectionmatrix.html">OpenGL Projection Matrix</a>:Opengl中的矩阵应用；<br><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/21999356">欧拉公式 e^{i<em>k}=cos(k)+i</em>sin(k) 的来历是什么？</a>:欧拉公式;<br><a target="_blank" rel="noopener" href="https://www.shuxuele.com/algebra/systems-linear-equations-matrices.html">线性方程组矩阵解法</a>:线性方程组矩阵解法;<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/leonardohaig/article/details/110881364">判断线段是否相交并求交点</a>:判断线段是否相交并求交点;<br><a target="_blank" rel="noopener" href="https://fgiesen.wordpress.com/">The ryg blog</a><br><a target="_blank" rel="noopener" href="https://bit-hack.net/2014/03/30/circular-harmonics/">Circular Harmonics</a></p>
<h3 id="Noise"><a href="#Noise" class="headerlink" title="Noise"></a>Noise</h3><p><a target="_blank" rel="noopener" href="http://devmag.org.za/2009/05/03/poisson-disk-sampling/">Poisson Disk Sampling</a>:泊松采样；<br><a target="_blank" rel="noopener" href="https://iquilezles.org/www/articles/warp/warp.htm">Warping</a>:Warping, or dommain distortion is a very common technique in computer graphics for generating procedural textures and geometry;<br><a target="_blank" rel="noopener" href="https://www.redblobgames.com/articles/noise/2d/">2D noise</a>:These are some quick &amp; dirty experiments I did with 2D noise;<br><a target="_blank" rel="noopener" href="https://github.com/KdotJPG/OpenSimplex2">OpenSimplex 2</a>:Successors to OpenSimplex Noise, plus updated OpenSimplex;</p>
<h3 id="Polygon"><a href="#Polygon" class="headerlink" title="Polygon"></a>Polygon</h3><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Even%E2%80%93odd_rule">Even–odd rule</a>:奇偶法判定点与多边形的关系；<br><a target="_blank" rel="noopener" href="https://sean.cm/a/polygon-clipping-pt1">Polygon Clipping (Part 1)</a>:多边形布尔运算；<br><a target="_blank" rel="noopener" href="https://sean.cm/a/polygon-clipping-pt2">Polygon Clipping (Part 2)</a>:多边形布尔运算；<br><a target="_blank" rel="noopener" href="https://barendgehrels.blogspot.com/2010/12/intersections-1.html">Barend’s Blog</a>:多边形布尔运算；<br><a target="_blank" rel="noopener" href="https://cs.stackexchange.com/questions/99927/concave-polygon-intersection-algorithm">Concave Polygon Intersection - Algorithm</a>:多边形布尔运算；<br><a target="_blank" rel="noopener" href="https://wrf.ecse.rpi.edu/Research/Short_Notes/pnpoly.html">PNPOLY - Point Inclusion in Polygon Test W. Randolph Franklin (WRF)</a>:…;</p>
<h3 id="Mesh"><a href="#Mesh" class="headerlink" title="Mesh"></a>Mesh</h3><p><a target="_blank" rel="noopener" href="https://0fps.net/2012/06/30/meshing-in-a-minecraft-game/">Meshing in a Minecraft Game</a>:网格合并贪心算法；<br><a target="_blank" rel="noopener" href="http://experilous.com/1/blog/post/procedural-planet-generation">planet generator</a>:行星网格；<br><a target="_blank" rel="noopener" href="http://eveliosdev.blogspot.com/2016/06/plate-tectonics.html">Evelios Development</a>:地图网格生成；<br><a target="_blank" rel="noopener" href="https://heredragonsabound.blogspot.com/2019/02/perlin-noise-procedural-content.html">Exploring procedural generation and display of fantasy maps</a>:地图生成；<br><a target="_blank" rel="noopener" href="https://squeakyspacebar.github.io/2017/07/12/Procedural-Map-Generation-With-Voronoi-Diagrams.html">Procedural Terrain Generation With Voronoi Diagrams</a>:地图生成；<br><a target="_blank" rel="noopener" href="https://github.com/squeakyspacebar/novatellus">a map generator based on Voronoi diagrams</a>:地图生成；<br><a target="_blank" rel="noopener" href="https://github.com/averrin/mapgen-viewer">Map generator based on Voronoi Diagram and Perlin noise</a>:地图生成；<br><a target="_blank" rel="noopener" href="https://github.com/Zalgo2462/VoronoiLib">VoronoiLib</a>:C# implementation of Fortune’s Algorithm;<br><a target="_blank" rel="noopener" href="https://leatherbee.org/index.php/2018/10/06/terrain-generation-3-voronoi-diagrams/">Terrain Generation 3: Voronoi Diagrams</a>:generating a small number of large Voronoi cells as tectonic plates;<br><a target="_blank" rel="noopener" href="https://github.com/michaellasky/ManyLandsGenerator">ManyLandsGenerator</a>:The Random Island Generator being developed for use in The Rogue Sea;<br><a target="_blank" rel="noopener" href="https://github.com/jceipek/Unity-delaunay">Unity-delaunay</a>:Port of as3delaunay to C# for Unity;<br><a target="_blank" rel="noopener" href="https://github.com/KHN190/miniHexMap">miniHexMap</a>:Create, edit, generate hex mesh in Unity Editor mode;<br><a target="_blank" rel="noopener" href="https://mapbox.github.io/delaunator/">Delaunator guide</a>:a fast library for Delaunay triangulation;<br><a target="_blank" rel="noopener" href="https://github.com/squeakyspacebar/csDelaunay">#csDelaunay</a>:This is a refactoring of PouletFrit’s C# port of as3delaunay;<br><a target="_blank" rel="noopener" href="https://github.com/PouletFrit/csDelaunay">csDelaunay</a>:This is a port and interpretation of actionscript library as3delaunay;<br><a target="_blank" rel="noopener" href="https://github.com/tyoden/VoronoiUnityDOTS">VoronoiUnityDOTS</a>:Fortune’s Voronoi diagram for Unity DOTS (Job System, Burst Compiler) - WIP;<br><a target="_blank" rel="noopener" href="https://github.com/LanLou123/Webgl-Erosion">Terrain erosion sandbox in WebGl</a>:Erosion simulation in Web Browser;</p>
<h3 id="Path"><a href="#Path" class="headerlink" title="Path"></a>Path</h3><p><a target="_blank" rel="noopener" href="https://fribbels.github.io/shortestpath/writeup.html">Euclidean Shortest Paths</a>:避障寻路；<br><a target="_blank" rel="noopener" href="https://www.cs.cmu.edu/~16311/current/schedule/ppp/Lec12-MotionPlanning4.pdf">Motion Planning, Part IV Graph Search Part II</a>:路径规划；<br><a target="_blank" rel="noopener" href="https://aaai.org/ocs/index.php/AIIDE/AIIDE10/paper/view/2139/2547">A Comparison of High-Level Approaches for Speeding Up Pathfinding</a>:寻路优化；<br><a target="_blank" rel="noopener" href="http://citeseerx.ist.psu.edu/viewdoc/download;jsessionid=5E67F3A553B41B61F9F0FCA0DDF17128?doi=10.1.1.138.7223&rep=rep1&type=pdf">TRANSIT: Ultrafast Shortest-Path Queries with Linear-Time Preprocessing</a>:寻路；<br><a target="_blank" rel="noopener" href="https://www.aaai.org/ocs/index.php/AIIDE/AIIDE12/paper/view/5459/5688">TRANSIT Routing on Video Game Maps</a>:寻路；<br><a target="_blank" rel="noopener" href="https://harablog.wordpress.com/2009/02/05/hierarchical-clearance-based-pathfinding/">Shortest Path</a>:寻路；<br><a target="_blank" rel="noopener" href="https://harablog.files.wordpress.com/2009/01/haa.pdf">Hierarchical Path Planning for Multi-Size Agents in Heterogeneous Environments</a>:寻路；<br><a target="_blank" rel="noopener" href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.14.6477&rep=rep1&type=pdf">Fully Dynamic Constrained Delaunay Triangulations</a>:寻路；<br><a target="_blank" rel="noopener" href="http://algo2.iti.kit.edu/schultes/hwy/schultes_diss.pdf">Route Planning in Road Networks</a>:路网寻路方案；<br><a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/research/wp-content/uploads/2004/07/tr-2004-24.pdf">Computing the Sortest Path: A* Search Meets Graph Theory</a>:A<em>寻路；<br><a target="_blank" rel="noopener" href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.42.1704&rep=rep1&type=pdf">Hierarchical A*: Searching Abstraction Hierarchies Efficiently</a>:A</em>寻路算法优化；<br><a target="_blank" rel="noopener" href="https://www.redblobgames.com/pathfinding/a-star/introduction.html">Introduction to the A* Algorithm</a>:Introduction to the A* Algorithm;<br><a target="_blank" rel="noopener" href="http://blog.runevision.com/2016/03/note-on-creating-natural-paths-in.html">Creating natural paths on terrains using pathfinding</a>:道路自动生成；<br><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/dijkstras-shortest-path-algorithm-greedy-algo-7/">Dijkstra’s shortest path algorithm | Greedy Algo-7</a><br><a target="_blank" rel="noopener" href="https://www.freecodecamp.org/news/dijkstras-shortest-path-algorithm-visual-introduction/">Dijkstra’s Shortest Path Algorithm - A Detailed and Visual Introduction</a></p>
<h3 id="Graphs"><a href="#Graphs" class="headerlink" title="Graphs"></a>Graphs</h3><p><a target="_blank" rel="noopener" href="http://www.science.smith.edu/~istreinu/Teaching/Courses/274/Spring98/Projects/Philip/fp/algVisibility.htm">Algorithm for Computing Visibility Graphs</a>:基于障碍物构造图；<br><a target="_blank" rel="noopener" href="http://www.cs.kent.edu/~dragan/ST-Spring2016/visibility%20graphs.pdf">Visibility graphs</a>:视线图;<br><a target="_blank" rel="noopener" href="https://github.com/xw0/spherical_voronoi_core">spherical_voronoi_core</a>:Voronoi Tessellation of the Sphere;</p>
<h2 id="Game"><a href="#Game" class="headerlink" title="Game"></a>Game</h2><h3 id="SLG"><a href="#SLG" class="headerlink" title="SLG"></a>SLG</h3><p><a target="_blank" rel="noopener" href="https://pvigier.github.io/2020/02/09/vagabond-building-generation.html">pvigier’s blog</a>:地图自动生成、寻路等一套完整的解决方案；<br><a target="_blank" rel="noopener" href="http://www-cs-students.stanford.edu/~amitp/games.html">The SimBlob Project</a>:地图自动生成、寻路等一套完整的解决方案；<br><a target="_blank" rel="noopener" href="https://thecolonistsgame.com/">The Colonists</a>:游戏；<br><a target="_blank" rel="noopener" href="http://www.82apps.com/factorytown/">Factory Town</a>:游戏；<br><a target="_blank" rel="noopener" href="https://store.steampowered.com/app/874390/The_Battle_of_Polytopia/">The Battle of Polytopia</a>:游戏；<br><a target="_blank" rel="noopener" href="https://civilization.com/zh-CN/new-frontier-pass/civilization-vi-vietnam-kublai-khan-pack/">文明VI: 新纪元季票</a>:游戏；<br><a target="_blank" rel="noopener" href="http://www.shiningrocksoftware.com/2011-05-16-the-doors-are-open/">Banished</a>:一些设计实现思路；<br><a target="_blank" rel="noopener" href="https://github.com/Wargus/stratagus">stratagus</a>:The Stratagus strategy game engine;<br><a target="_blank" rel="noopener" href="https://sourceforge.net/directory/?q=turn%20based%20military%20strategy%20games">turn based military strategy games</a>:搜索游戏；<br><a target="_blank" rel="noopener" href="http://assetstore.unitylover.com/unity_asset/turn-based-toolkit-tbtk/">Turn-Based ToolKit (TBTK)</a>:子走棋；<br><a target="_blank" rel="noopener" href="https://unity.com/how-to/advanced/optimize-lighting-mobile-games?_ga=2.238992768.1610235152.1617097265-1411223696.1612421527">Light baked Prefabs &amp; other tips to get 60 fps on low-end phones</a>:tips from Michelle Martin, software engineer at MetalPop Games, on how to optimize games for a range of mobile devices, so you can reach as many potential players as possible;<br><a target="_blank" rel="noopener" href="https://tuanisapps.itch.io/extinction-eclipse">Extinction Eclipse</a><br><a target="_blank" rel="noopener" href="https://manlaig.github.io/projects">Michael Ganzorig</a></p>
<h2 id="Render"><a href="#Render" class="headerlink" title="Render"></a>Render</h2><h3 id="Color"><a href="#Color" class="headerlink" title="Color"></a>Color</h3><p><a target="_blank" rel="noopener" href="https://simonstechblog.blogspot.com/">Studying Gamut Clipping</a>:色域裁剪研究，用于将颜色限定在有效范围内；</p>
<h3 id="Lighting"><a href="#Lighting" class="headerlink" title="Lighting"></a>Lighting</h3><p><a target="_blank" rel="noopener" href="https://theory.cpe.ku.ac.th/~pramook/files/prosem_paper.pdf">Spherical Harmonics</a>:球谐函数原理；<br><a target="_blank" rel="noopener" href="http://www.ppsloan.org/publications/StupidSH36.pdf">Stupid Spherical Harmonics (SH) Tricks</a>:球谐函数原理；<br><a target="_blank" rel="noopener" href="https://www.cs.cornell.edu/courses/cs5625/2016sp/slides/14sh-lighting.pdf">Spherical Harmonic Lighting</a>:球谐函数在光照中的应用；<br><a target="_blank" rel="noopener" href="https://lianera.github.io/post/2016/sh-lighting-exp/">Spherical Harmonics Lighting</a>:球谐函数光照应用；<br><a target="_blank" rel="noopener" href="https://zvxryb.github.io/blog/2015/08/20/sh-lighting-part1/">Spherical Harmonics Lighting: Part I</a>:球谐函数光照应用；<br><a target="_blank" rel="noopener" href="http://www.cse.chalmers.se/~uffe/xjobb/Readings/GlobalIllumination/Spherical%20Harmonic%20Lighting%20-%20the%20gritty%20details.pdf">Spherical Harmonic Lighting: The Gritty Details</a>:球谐函数光照应用；<br><a target="_blank" rel="noopener" href="https://www.gamasutra.com/view/news/128550/InDepth_Spherical_Harmonic_Lighting.php">In-Depth: Spherical Harmonic Lighting</a>:球鞋函数；<br><a target="_blank" rel="noopener" href="https://mynameismjp.wordpress.com/2016/10/09/sg-series-part-1-a-brief-and-incomplete-history-of-baked-lighting-representations/">SG SERIES PART 1: A BRIEF (AND INCOMPLETE) HISTORY OF BAKED LIGHTING REPRESENTATIONS</a>:烘焙光照介绍；<br><a target="_blank" rel="noopener" href="http://www.ppsloan.org/publications/">ppsloan</a>:一系列光照相关资料；<br><a target="_blank" rel="noopener" href="https://www.pbr-book.org/">Physically Based Rendering:From Theory To Implementation</a>:物理光照；<br><a target="_blank" rel="noopener" href="https://www.jordanstevenstechart.com/physically-based-rendering">Physically Based Rendering Algorithms: A Comprehensive Study In Unity3D</a>:物理光照详解；<br><a target="_blank" rel="noopener" href="https://www.codinblack.com/graphics-rendering-pipeline/">Graphics Rendering Pipeline</a>:渲染管线；<br><a target="_blank" rel="noopener" href="https://gameinstitute.qq.com/community/detail/115786">HLSL固有函数 【Intrinsic Functions (DirectX HLSL)】</a>:HLSL固有函数；<br><a target="_blank" rel="noopener" href="http://www.thetenthplanet.de/archives/255">The Blinn-Phong Normalization Zoo</a>:The Blinn-Phong Normalization Zoo;</p>
<h3 id="Shader"><a href="#Shader" class="headerlink" title="Shader"></a>Shader</h3><p><a target="_blank" rel="noopener" href="https://origin.80.lv/articles/creating-a-stylized-waterfall-in-unity-part-1/">Creating A Stylized Waterfall in Unity: Part 1</a>:Math Roodhuizen allowed us to repost his guide to creating a RiME-style waterfall in Unity, Amplify Shader Editor, and Maya;<br><a target="_blank" rel="noopener" href="https://bronsonzgeb.com/index.php/2021/02/27/particle-metaballs-in-unity-using-urp-and-shader-graph-part-1/">Particle Metaballs in Unity using URP and Shader Graph Part 1</a>:This series will explain how to draw Metaballs in Unity using the Universal Render Pipeline (URP) and Shader Graph;<br><a target="_blank" rel="noopener" href="https://www.scratchapixel.com/lessons/advanced-rendering/rendering-distance-fields/introduction">Rendering Implicit Surfaces and Distance Fields: Sphere Tracing</a>:Rendering Implicit Surfaces and Distance Fields: Sphere Tracing;<br><a target="_blank" rel="noopener" href="https://www.ronja-tutorials.com/">Shader Tutorials by Ronja</a>:The focus of this tutorials is on unity shaders with hlsl;</p>
<h2 id="AI"><a href="#AI" class="headerlink" title="AI"></a>AI</h2><p><a target="_blank" rel="noopener" href="https://github.com/stolk/GPGOAP">GPGOAP</a>:面向目标的行为规划；<br><a target="_blank" rel="noopener" href="http://alumni.media.mit.edu/~jorkin/goap.html">Goal-Oriented Action Planning (GOAP)</a><br><a target="_blank" rel="noopener" href="https://github.com/luxkun/ReGoap">ReGoap</a>:Generic C# GOAP (Goal Oriented Action Planning) library with Unity3d examples;<br><a target="_blank" rel="noopener" href="https://github.com/apoch/curvature">Curvature</a><br><a target="_blank" rel="noopener" href="https://github.com/FBast/ReflexityAI">ReflexityAI</a><br><a target="_blank" rel="noopener" href="https://github.com/Jay2645/UnrealUtilityAI">UnrealUtilityAI</a><br><a target="_blank" rel="noopener" href="https://gamedevelopment.tutsplus.com/tutorials/goal-oriented-action-planning-for-a-smarter-ai--cms-20793">Goal Oriented Action Planning for a Smarter AI</a><br><a target="_blank" rel="noopener" href="https://cryscan.github.io/project-chen/update/2021/02/17/goal-oriented-action-planning.html">Goal Oriented Action Planning Instructions</a></p>
<h2 id="Data-Struct"><a href="#Data-Struct" class="headerlink" title="Data Struct"></a>Data Struct</h2><h3 id="Tree"><a href="#Tree" class="headerlink" title="Tree"></a>Tree</h3><p><a target="_blank" rel="noopener" href="http://www.mikechambers.com/blog/2011/03/21/javascript-quadtree-implementation/">JavaScript QuadTree Implementation</a>:四叉树；<br><a target="_blank" rel="noopener" href="https://fribbels.github.io/vptree/writeup">VP Tree</a></p>
<h3 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h3><p><a target="_blank" rel="noopener" href="https://github.com/BlueRaja/High-Speed-Priority-Queue-for-C-Sharp">High-Speed-Priority-Queue-for-C-Sharp</a><br><a target="_blank" rel="noopener" href="https://www.dotnetlovers.com/article/231/priority-queue">Priority Queue</a><br><a target="_blank" rel="noopener" href="https://ericbackhage.net/c/how-to-design-a-priority-queue-in-c/">How to design a Priority Queue in C#</a><br><a target="_blank" rel="noopener" href="https://visualstudiomagazine.com/articles/2012/11/01/priority-queues-with-c.aspx">Priority Queues with C#</a></p>
<h2 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h2><h3 id="Sort"><a href="#Sort" class="headerlink" title="Sort"></a>Sort</h3><p><a target="_blank" rel="noopener" href="https://www.log2base2.com/algorithms/sorting/quick-sort.html">Quick Sort</a><br><a target="_blank" rel="noopener" href="https://www.interviewbit.com/tutorial/quicksort-algorithm/">Quick Sort Algorithm</a><br><a target="_blank" rel="noopener" href="https://www.tutorialspoint.com/data_structures_algorithms/quick_sort_algorithm.htm">Data Structure and Algorithms - Quick Sort</a></p>
<h3 id="AOI"><a href="#AOI" class="headerlink" title="AOI"></a>AOI</h3><p><a target="_blank" rel="noopener" href="http://docs2x.smartfoxserver.com/AdvancedTopics/advanced-mmo-api">Advanced uses of the MMORoom and MMO API</a><br><a target="_blank" rel="noopener" href="http://lecturer.ukdw.ac.id/~mahas/dossier/gameng_AIFG.pdf">ARTIFICIAL INTELLIGENCE FOR GAMES</a></p>
<h3 id="Fog"><a href="#Fog" class="headerlink" title="Fog"></a>Fog</h3><p><a target="_blank" rel="noopener" href="http://bobkoon.com/how-to-implement-a-fog-of-war-part-1-chunky/">How To: Implement a Fog of War – Part 1 – Chunky</a><br><a target="_blank" rel="noopener" href="https://bit-hack.net/2013/07/27/lode-storm-implementing-classic-fog-of-war/">Lode Storm – Implementing classic fog of war</a><br><a target="_blank" rel="noopener" href="https://github.com/topics/fog-of-war">fog-of-war</a><br><a target="_blank" rel="noopener" href="https://wiki.roll20.net/Advanced_Fog_of_War">Advanced Fog of War</a><br><a target="_blank" rel="noopener" href="http://phungdinhthang.com/2016/12/12/unreal-engine-4-fog-of-war-tutorial/?i=1">Unreal Engine 4 Fog Of War Tutorial – Ready To Use</a><br><a target="_blank" rel="noopener" href="https://github.com/manlaig/FogOfWar">Fog Of War in Unity</a></p>
<h2 id="Engine"><a href="#Engine" class="headerlink" title="Engine"></a>Engine</h2><h3 id="Unity"><a href="#Unity" class="headerlink" title="Unity"></a>Unity</h3><p><a target="_blank" rel="noopener" href="https://weeklyhow.com/unity-custom-editor-window/">Unity Tutorials: How To Create Custom Editor Window</a>:Create Custom Editor Window;<br><a target="_blank" rel="noopener" href="https://unitylist.com/p/5c3/Unity-editor-icons">Unity Editor Built-in Icons</a>:Unity version: 2020.1.0f1 Icons what can load using EditorGUIUtility.IconContent;<br><a target="_blank" rel="noopener" href="https://docs.unity3d.com/Packages/com.unity.render-pipelines.universal@7.1/manual/universalrp-asset.html">Universal Render Pipeline</a>:URP;<br><a target="_blank" rel="noopener" href="https://www.cyanilux.com/tutorials/intro-to-shader-graph/">Intro to Shader Graph</a>:This post is a detailed introduction to using Shader Graph ;<br><a target="_blank" rel="noopener" href="https://cyangamedev.wordpress.com/2020/06/05/urp-shader-code/">Writing Shader Code for the Universal RP</a>:Writing Shader Code for the Universal RP;<br><a target="_blank" rel="noopener" href="https://github.com/Unity-Technologies/UniversalRenderingExamples">Universal Rendering Examples</a>:This project contains a collection of Custom Renderer examples. This will be updated as we refine the feature and add more options;<br><a target="_blank" rel="noopener" href="https://www.codinblack.com/the-big-shader-graph-tutorial-introduction/">The Big Shader Graph Tutorial: Introduction</a>:This is the first part of a fundamental tutorial about shader graph;<br><a target="_blank" rel="noopener" href="https://forum.unity.com/threads/urp-sampling-shadow-map-from-shader-graph.857581/">URP - Sampling Shadow Map from Shader Graph</a>:URP - Sampling Shadow Map from Shader Graph;<br><a target="_blank" rel="noopener" href="https://www.raywenderlich.com/138-introduction-to-unity-particle-systems">Introduction To Unity: Particle Systems</a>:Unity’s particle system is both robust and feature packed. In this tutorial, you’ll learn the ins-and-outs of it to create both fire and explosions;<br><a target="_blank" rel="noopener" href="https://forum.unity.com/threads/using-materialpropertyblocks-with-shadergraph-shaders-help-wanted.651547/">Using MaterialPropertyBlocks with ShaderGraph shaders</a>:Using MaterialPropertyBlocks with ShaderGraph shaders;<br><a target="_blank" rel="noopener" href="https://game-developers.org/how-to-use-terrain-with-urp-in-unity-2020-beginner-tutorial/">How to Use Terrain with URP in Unity 2020 | Beginner Tutorial</a>:How to Use Terrain with URP in Unity 2020 | Beginner Tutorial;<br><a target="_blank" rel="noopener" href="https://forum.unity.com/threads/bake-static-light-and-shadows-directly-into-texture-optimizing-for-mobile.824526/">Bake static light and shadows directly into texture ! optimizing for mobile</a>:Bake static light and shadows directly into texture ! optimizing for mobile;<br><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/gaming/acoustics/unity-baking">Project Acoustics Unity Bake Tutorial</a>:his article describes acoustics baking by using Project Acoustics in Unity;<br><a target="_blank" rel="noopener" href="https://support.unity.com/hc/en-us/articles/210223733-How-to-customize-Unity-script-templates">How to customize Unity script templates</a>:When I create a new script, the Unity Editor generates its content. For C# scripts it uses the file name as the class name;<br><a target="_blank" rel="noopener" href="https://github.com/joaoborks/myunitytools-script-template">Unity Tools - Script Template</a>:This tool adds custom Script Templates to Unity that will serve as alternatives for the default “C#Script” that I personally always modify before writing my scripts;<br><a target="_blank" rel="noopener" href="https://riptutorial.com/unity3d/example/14519/editor-window">Editor Window</a>:Create a basic EditorWindow;<br><a target="_blank" rel="noopener" href="https://www.synnaxium.com/en/2019/01/unity-custom-map-editor-part-1/">Unity – Creating a custom map editor</a>:make a custom map editor in Unity;<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/114371275">unity编辑器扩展之SceneUI</a>:unity编辑器扩展之SceneUI——贴在Scene View的SceneCanvas;</p>
<h3 id="Duality"><a href="#Duality" class="headerlink" title="Duality"></a>Duality</h3><p><a target="_blank" rel="noopener" href="https://docs.duality2d.net/pages/v3/getting-started.html">Getting Started</a>:It’s an extensible 2D game engine;<br><a target="_blank" rel="noopener" href="https://hub.packtpub.com/turn-based-game-framework-duality-c/">Turn-based game framework in Duality (C#)</a>:This post presents a simple turn-based game framework using the Duality game engine;</p>
<h2 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h2><h3 id="Tutorial"><a href="#Tutorial" class="headerlink" title="Tutorial"></a>Tutorial</h3><p><a target="_blank" rel="noopener" href="https://www.mbsoftworks.sk/index.php?page=tutorials&series=1&tutorial=24">C++, OpenGL and more…</a>:…;<br><a target="_blank" rel="noopener" href="https://www.construct.net/en/tutorials?flang=45">GAME DEVELOPMENT TUTORIALS</a>:Read our free tutorials on game development submitted by our staff and expert users in our community;<br><a target="_blank" rel="noopener" href="https://gamasutra.com/blogs/MikeMarrone/20210312/378423/Game_Dev_Digest_Issue_85__Platforms_Performance_and_Tutorials.php">Performance optimization tips: Physics in Unity | Tutorial</a>:…;</p>
<h3 id="ECS"><a href="#ECS" class="headerlink" title="ECS"></a>ECS</h3><p><a target="_blank" rel="noopener" href="https://github.com/pvigier/ecs">entity-component-system</a>:A simple and easy to use entity-component-system C++ library;</p>
<h3 id="Library"><a href="#Library" class="headerlink" title="Library"></a>Library</h3><p><a target="_blank" rel="noopener" href="http://www.angusj.com/delphi/clipper.php">Clipper - an open source freeware library</a>:The Clipper library performs line &amp; polygon clipping - intersection, union, difference &amp; exclusive-or,and line &amp; polygon offsetting. The library is based on Vatti’s clipping algorithm;<br><a target="_blank" rel="noopener" href="https://unity.stelabouras.com/">The Unity Library</a>:The Unity Library;</p>
<h3 id="Papers"><a href="#Papers" class="headerlink" title="Papers"></a>Papers</h3><p><a target="_blank" rel="noopener" href="https://www.highgroundgaming.com/best-turn-based-strategy-games/">10 Best Turn-Based Strategy Games in 2021 for Master Tacticians</a>:10 Best Turn-Based Strategy Games in 2021 for Master Tacticians;<br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/column/88095">壹种念头Unity blog</a></p>
<h2 id="Bing-Map"><a href="#Bing-Map" class="headerlink" title="Bing Map"></a>Bing Map</h2><p><a target="_blank" rel="noopener" href="http://blogs.developpeur.org/nicoboo/default.aspx">MVP - Bing Maps : une année supplémentaire !</a><br><a target="_blank" rel="noopener" href="https://rbrundritt.wordpress.com/">Geocoding and Routing improvements added to Bing Maps</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2021/05/27/Line/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2021/05/27/Line/" class="post-title-link" itemprop="url">Line</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-27 15:01:00" itemprop="dateCreated datePublished" datetime="2021-05-27T15:01:00+08:00">2021-05-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-17 19:12:22" itemprop="dateModified" datetime="2021-06-17T19:12:22+08:00">2021-06-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Math/" itemprop="url" rel="index"><span itemprop="name">Math</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Math/Line/" itemprop="url" rel="index"><span itemprop="name">Line</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="线段相交"><a href="#线段相交" class="headerlink" title="线段相交"></a>线段相交</h2><p>对于平面上给定的两个线段line0、line1，求解其交点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public static bool LinesIntersect(Vector2 line0_start, Vector2 line0_end, Vector2 line1_start, Vector2 line1_end, out float line0_cross_line1, out float along_line0, out along_line1, out Vector2 intersect_point)</span><br><span class="line">&#123;</span><br><span class="line">	var dir_line0 &#x3D; line0_end - line0_start;</span><br><span class="line">	var dir_line1 &#x3D; line1_end - line1_start;</span><br><span class="line">	line0_cross_line1 &#x3D; dir_line0.x * dir_line1.y - dir_line0.y * dir_line1.x;</span><br><span class="line">	along_line0 &#x3D; 0;</span><br><span class="line">	along_line1 &#x3D; 0;</span><br><span class="line">	intersect_point &#x3D; Vector2.zero;</span><br><span class="line">	if(line0_cross_line1 &#x3D;&#x3D; 0) return false;</span><br><span class="line">	var dir_line_start01 &#x3D; line0_start - line1_start;</span><br><span class="line">	along_line0 &#x3D; (dir_line1.x * dir_line_start01.y - dir_line1.y * dir_line_start01.x) &#x2F; line0_cross_line1;</span><br><span class="line">	along_line1 &#x3D; (dir_line0.x * dir_line_start01.y - dir_line0.y * dir_line_start01.x) &#x2F; line0_cross_line1;</span><br><span class="line">	&#x2F;&#x2F; if (along_line0 &lt; 0 || along_line0 &gt; 1 || along_line1 &lt; 0 || along_line1 &gt; 1) return false;</span><br><span class="line">	return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相关链接：<br><a target="_blank" rel="noopener" href="https://mathopenref.com/coordintersection.html">Math Open Reference</a><br><a target="_blank" rel="noopener" href="https://sean.cm/a/polygon-clipping-pt1">Polygon Clipping</a><br><a target="_blank" rel="noopener" href="https://barendgehrels.blogspot.com/2010/12/intersections-1.html">Barend’s Blog</a><br><a target="_blank" rel="noopener" href="https://cs.stackexchange.com/questions/99927/concave-polygon-intersection-algorithm">Concave Polygon Intersection - Algorithm</a><br><a target="_blank" rel="noopener" href="https://fribbels.github.io/shortestpath/writeup.html">Euclidean Shortest Paths</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2021/04/14/Spherical-harmonics-light/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2021/04/14/Spherical-harmonics-light/" class="post-title-link" itemprop="url">Basics of Spherical Harmonics And Light Probes</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-14 10:01:00" itemprop="dateCreated datePublished" datetime="2021-04-14T10:01:00+08:00">2021-04-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-17 19:12:22" itemprop="dateModified" datetime="2021-06-17T19:12:22+08:00">2021-06-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/URP/" itemprop="url" rel="index"><span itemprop="name">URP</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/URP/Light/" itemprop="url" rel="index"><span itemprop="name">Light</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Basics-of-Spherical-Harmonics"><a href="#Basics-of-Spherical-Harmonics" class="headerlink" title="Basics of Spherical Harmonics"></a><a target="_blank" rel="noopener" href="https://computergraphics.stackexchange.com/questions/4164/what-are-spherical-harmonics-light-probes">Basics of Spherical Harmonics</a></h2><p>球谐函数是一种球面二维函数。在图形学中可以使用Cube六面体来表示空间区域，以及环境贴图等，但是它表示的还是三维空间。球谐空间是定义在频域的一种空间，具有很多有趣的属性，而且很多操作和光有一定的关联，因此在光照渲染中使用球谐空间可以提高性能。随着球谐空间“次”的提升，我们可以拟合出高频函数，如下图所示，l表示的是“次”。通过对下面基本函数的组合，我们可以拟合出球面上的二维函数。这些基础函数是由“associated legendre polynomials”-<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Associated_Legendre_polynomials">关联拉格朗日多项式</a>定义。但是我们并不需要自行推导这些函数，因为别人已经推导过了<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Table_of_spherical_harmonics#Real_spherical_harmonics">spherical harmonics</a></p>
<p><img src="https://i.stack.imgur.com/QPNGz.png"></p>
<p>在球谐函数中有一个高效的操作叫做<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Convolution">卷积</a>，通过卷积我们可以对两个球面函数求积和，这在光学中是一个非常常用的操作。例如我们用一个球谐函数表示入射光，另一个表示BRDF，这样的话，我们只需要简单的点乘两个球谐因子向量。</p>
<p>另一个有趣的操作是可以实现低通滤波。因为球谐函数本身表示的是频域。我们只需要对球谐函数进行缩放，然后剔除小于零的值就行。但是也有一些操作，相较于空域来说，会比较复杂。例如，我们使用球谐函数来表达旋转函数时，随着球谐函数“次”的增高（高次球谐函数），计算量也会急剧升高。所以需要考虑球谐函数的适用场景。</p>
<p>球谐函数通常只是用来拟合低频函数，因为高频函数需要增加球谐因子，以及运算量。因此我们不会用球谐函数来拟合高光反射。</p>
<p>还有一个操作叫做“球谐投影”，用来将空域转换到球谐函数。这个操作是通过对空域数据和球谐基本函数进行卷积。相比于空域，转换后的球谐函数不会产生锯齿效果，即便是低次球谐函数也是如此。</p>
<h2 id="Light-Probes"><a href="#Light-Probes" class="headerlink" title="Light Probes"></a>Light Probes</h2><p>前面介绍了球谐函数的一些操作和特性。下面来看一下如何将球谐函数应用到GI中。光照探针是用来采集某个空间位置的光照强度，也就是各个方向射向该位置的光照强度。因此需要用一个球面来记录这些光照强度。前面讲到球谐函数是用来拟合球面的二维函数。那么一个球谐函数就可以表示球面上各个点的亮度，三个球谐函数可以用来表示球面上各个点的颜色。</p>
<p>光照探针只记录Lambertian漫反射光(入射光)，所以低次球谐函数就足够了。光照探针的球谐函数求解思路很简单，就是先基于光照探针位置捕捉一个Cube环境贴图，然后将环境贴图投影到球面，然后再拟合球谐函数，计算出球谐因子。</p>
<p>当我们渲染模型时，我们通过筛选出附件几个光照探针，然后对这些光照探针进行插值，从而计算出指定空间点的入射光。例如，我们直接对附近光照探针的球谐因子进行插值，然后执行基于像素点法向量的卷积操作。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2021/04/06/URP_Render_1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2021/04/06/URP_Render_1/" class="post-title-link" itemprop="url">URP 学习总结1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-06 10:01:00" itemprop="dateCreated datePublished" datetime="2021-04-06T10:01:00+08:00">2021-04-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-17 19:12:22" itemprop="dateModified" datetime="2021-06-17T19:12:22+08:00">2021-06-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/URP/" itemprop="url" rel="index"><span itemprop="name">URP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="URP提供的工具函数"><a href="#URP提供的工具函数" class="headerlink" title="URP提供的工具函数"></a>URP提供的工具函数</h2><p><code>VertexPositionInputs GetVertexPositionInputs(positionOS)</code><br>计算出各个空间下的顶点坐标</p>
<p><code>VertexNormalInputs GetVertexNormalInputs(normalOS)</code><br>计算出各个空间下的顶点法向坐标</p>
<p><code>half3 VertexLighting(positionWS, normalWS)</code><br>获取指定顶点的顶点光照，当定义了<code>_ADDITIONAL_LIGHTS_VERTEX</code>，表明使用顶点光照，并返回光照值，否则返回零<br><code>uint GetAdditionalLightsCount()</code><br>获取作用在当前空间位置上的辅光源数量，其中<code>_AdditionalLightsCount.x</code>表示场景中所有被激活的灯光，在场景剔除的过程中，由渲染管线计算并提交。而<code>unity_LightData.y</code>应该是表示所有的光照数量。<br><code>Light GetAdditionalLight(lightIndex, positionWS)</code><br>获取指定辅光源作用在指定空间位置的光照值，<code>lightIndex</code>表示辅光源在当前空间点辅光源列表中的索引值。<br><code>int GetPerObjectLightIndex(lightIndex)</code><br>基于当前辅光源在当前空间点辅光源列表中的索引值，计算辅光源在所有激活光源中的索引值<br><code>Light GetAttitionalPerObjectLight</code>(perObjectLightIndex, positionWS)`<br>场景中的每个物体受部分光源的影响，具体受哪些光源的影响根据光源排序确定，然后每个物体记录其受光源的索引值。需要清楚地是所有的光源信息是统一存放在一个公共Buffer里面。</p>
<p>shadowParams.x : 阴影强度<br>shadowParams.y : 1.0 表示软阴影， 0.0表示其他</p>
<p>unity_LightData.x ：表示当前模型灯光在灯光缓存中的起始索引偏移值</p>
<p>unity_LightData.z : 表示该光源是否可见，可见为1.0，不可见为0.0</p>
<p>float4 unity_LightIndices[2] : 每个模型最大辅光源个数为8， 这里面便存着实际光源的索引值</p>
<p>物理含义<br>NdotH : 表示观察视角和镜面反射的重合度，重合度越高，观察的光越强<br>LdotH : 表示入射光和观察视角的重合度</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2021/04/06/Unity-Editor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2021/04/06/Unity-Editor/" class="post-title-link" itemprop="url">Unity Editor</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-06 10:01:00" itemprop="dateCreated datePublished" datetime="2021-04-06T10:01:00+08:00">2021-04-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-17 19:12:22" itemprop="dateModified" datetime="2021-06-17T19:12:22+08:00">2021-06-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/Editor/" itemprop="url" rel="index"><span itemprop="name">Editor</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="获取当前选择的目录"><a href="#获取当前选择的目录" class="headerlink" title="获取当前选择的目录"></a>获取当前选择的目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public static string GetCurrentAssetDirectory()</span><br><span class="line">&#123;</span><br><span class="line">	foreach(var obj in Selection.GetFiltered&lt;Object&gt;(SelectionMode.Assets))</span><br><span class="line">	&#123;</span><br><span class="line">		var path &#x3D; AssetDataBase.GetAssetPath(obj);</span><br><span class="line">		if(string.IsNullOrEmpty(path))</span><br><span class="line">		&#123;</span><br><span class="line">			return path;</span><br><span class="line">		&#125;</span><br><span class="line">		else if(System.IO.File.Exists(path))</span><br><span class="line">		&#123;</span><br><span class="line">			return System.IO.Path.GetDirectory(path);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return &quot;Assets&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建hlsl脚本"><a href="#创建hlsl脚本" class="headerlink" title="创建hlsl脚本"></a>创建hlsl脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public static class AssetsMenu</span><br><span class="line">&#123;</span><br><span class="line">	[MenuItem(&quot;Assets&#x2F;Create HLSL&quot;)]</span><br><span class="line">	public static void CreateHLSL()</span><br><span class="line">	&#123;</span><br><span class="line">		&#x2F;&#x2F;string projectPath &#x3D; Path.GetDirectoryName(Application.dataPath);</span><br><span class="line">		</span><br><span class="line">		string assetPath &#x3D; Path.Combine(GetCurrentAssetDirectory(), &quot;temp.hlsl&quot;);</span><br><span class="line">		assetPath &#x3D; AssetDataBase.generateuniqueAssetPath(assetPath);</span><br><span class="line">		</span><br><span class="line">		AssetDataBase.CreateAsset(new TextAsset(&quot;--&quot;, assetPath);</span><br><span class="line">		File.WriteAllText(assetPath, &quot;&quot;); &#x2F;&#x2F; clean</span><br><span class="line">		</span><br><span class="line">		AssetDataBase.SaveAssets();</span><br><span class="line">		AssetDataBase.Refresh();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2021/01/30/EmmyLua-for-IntelliJ-IDEA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2021/01/30/EmmyLua-for-IntelliJ-IDEA/" class="post-title-link" itemprop="url">EmmyLua 的使用方法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-30 10:38:34" itemprop="dateCreated datePublished" datetime="2021-01-30T10:38:34+08:00">2021-01-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-17 19:12:22" itemprop="dateModified" datetime="2021-06-17T19:12:22+08:00">2021-06-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Lua/" itemprop="url" rel="index"><span itemprop="name">Lua</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Lua/EmmyLua/" itemprop="url" rel="index"><span itemprop="name">EmmyLua</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>EmmyLua是Jetbrains IDE的一个插件，它提供了一套注解的语法，可以帮助IDE进行代码之间索引跳转，以及变量名称提示等功能。总而言之，EmmyLua是丰富IDE的功能，和实际的代码没有关系，IDE的跳转也只是限于注释之间。</p>
<h2 id="类的声明"><a href="#类的声明" class="headerlink" title="类的声明"></a>类的声明</h2><p>EmmyLua使用@class来模拟面向对象编程，支持继承和属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--- my supper class</span><br><span class="line">---@class Transport</span><br><span class="line">local p &#x3D; Class()</span><br><span class="line"></span><br><span class="line">--- 子类</span><br><span class="line">---@class Car : Transport</span><br><span class="line">local cls &#x3D; Class(p)</span><br><span class="line">function c:test()</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--@class my_type[: parent_type] [@comment]</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---@class Car : Transport @define class Car extends Transport</span><br><span class="line">local cls &#x3D; class()</span><br><span class="line">function clas:test()</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>上面定义了一个Car类，我们可以使用@type Car来表明某个变量属于Car类</p>
<h2 id="变量的声明"><a href="#变量的声明" class="headerlink" title="变量的声明"></a>变量的声明</h2><p>使用<code>@type</code>可以指明某个变量的类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---@type Car</span><br><span class="line">local car1 &#x3D; getCar()</span><br><span class="line">---@type Car</span><br><span class="line">global_car &#x3D; getCar()</span><br><span class="line">global_car:test()</span><br></pre></td></tr></table></figure>
<p>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@type my_type[|other_type] [@comment]</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">---@type Car @instance of car</span><br><span class="line">local car1 &#x3D; &#123;&#125;</span><br><span class="line"></span><br><span class="line">---@type Car|Ship @transport tools, car or ship. Since lua is dynamic-typed, a variable may be of different types</span><br><span class="line">---use | to list all possible types</span><br><span class="line">local transport &#x3D; &#123;&#125;</span><br><span class="line"></span><br><span class="line">---@type Car @global variable type</span><br><span class="line">global_car &#x3D; &#123;&#125;</span><br><span class="line"></span><br><span class="line">local obj &#x3D; &#123;&#125;</span><br><span class="line">---@type Car @property type</span><br><span class="line">obj.car &#x3D; getCar()</span><br></pre></td></tr></table></figure>

<h2 id="别名注释"><a href="#别名注释" class="headerlink" title="别名注释"></a>别名注释</h2><p>使用<code>@alias</code>将一些复杂不容易输入的类型注册为新的容易输入的类型<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@alias new_name type</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---@alias Handler fun( type: string, data: any):void</span><br><span class="line">---@param handler Handler</span><br><span class="line">function addHandler(handler)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h2 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h2><p>使用<code>@param</code>来指定函数的参数类型<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@param param_name my_type[|other_type] [@comment]</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">---@param car Car</span><br><span class="line">local function setCar(car)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">---@param car Car</span><br><span class="line">setCallback(function(car)</span><br><span class="line">end)</span><br><span class="line"></span><br><span class="line">---@param car Car</span><br><span class="line">for k, car in pairs(list) do</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h2 id="函数返回值类型说明"><a href="#函数返回值类型说明" class="headerlink" title="函数返回值类型说明"></a>函数返回值类型说明</h2><p>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@return my_type[|other_type] [@comment]</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">---@return Car|Ship</span><br><span class="line">local function crate()</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">---here car_or_ship doesn&#39;t need @type annotation, EmmyLua has already inferred the type via &quot;create&quot; function</span><br><span class="line">local car_or_ship &#x3D; create()</span><br><span class="line"></span><br><span class="line">---@return Car</span><br><span class="line">function factory:create()</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h2 id="属性声明"><a href="#属性声明" class="headerlink" title="属性声明"></a>属性声明</h2><p>使用<code>@field</code>可以标明类所具有的属性，即使类中没有使用到这个属性<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@field [public|protected|private] field_name field_type[|other_type] [@comment]</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">---@class Car</span><br><span class="line">---@field public name string @add name field to class Car, you&#39;ll see it in code completion</span><br><span class="line">local cls &#x3D; class()</span><br></pre></td></tr></table></figure>

<h2 id="泛型声明"><a href="#泛型声明" class="headerlink" title="泛型声明"></a>泛型声明</h2><p>使用<code>@generic</code>来模拟一些高级语言的泛型<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@generic T1 [: parent_type] [, T2 [: parent_type]]</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">---@generic T : Transport, K</span><br><span class="line">---@param param1 T</span><br><span class="line">---@param param2 K</span><br><span class="line">---@return T</span><br><span class="line">local function test(param1, param2)</span><br><span class="line">	-- todo</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">---@type Car</span><br><span class="line">local car &#x3D; ...</span><br><span class="line">local value &#x3D; test(car)</span><br></pre></td></tr></table></figure>
<p>这里说明一下，上面的<code>T</code>和<code>K</code>都是类型，只不过<code>T</code>是继承自<code>Transport</code>的一种类型，而<code>K</code>可以是任何类型。<br>然后<code>param1</code>是类型<code>T</code>的实例</p>
<h2 id="不定参数的注释"><a href="#不定参数的注释" class="headerlink" title="不定参数的注释"></a>不定参数的注释</h2><p>使用<code>@vararg</code>注解函数不定参数部分<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@vararg type</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---@vararg string</span><br><span class="line">---@return string</span><br><span class="line">local function format(...)</span><br><span class="line">	local tbl &#x3D; &#123;...&#125; --inferred as string[]</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h2 id="嵌入其他语言"><a href="#嵌入其他语言" class="headerlink" title="嵌入其他语言"></a>嵌入其他语言</h2><p>使用<code>@language</code>可以在lua代码中嵌入其他语言<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@language language_id</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---@language JSON</span><br><span class="line">local jsonText &#x3D; [[&#123;</span><br><span class="line">	&quot;name&quot;:&quot;Emmy&quot;</span><br><span class="line">	&#125;]]</span><br></pre></td></tr></table></figure>

<h2 id="数组类型声明"><a href="#数组类型声明" class="headerlink" title="数组类型声明"></a>数组类型声明</h2><p>使用<code>@type mytype[]</code>可以指定变量类型为数组<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@type my_type[]</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---@type Car[]</span><br><span class="line">local list &#x3D; &#123;&#125;</span><br><span class="line">local car &#x3D; list[1]</span><br><span class="line">-- car, and you &#39;ll see completion</span><br><span class="line"></span><br><span class="line">for i, car in pairs(list) do</span><br><span class="line">	-- car. and you&#39;ll see completion</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h2 id="table类型声明"><a href="#table类型声明" class="headerlink" title="table类型声明"></a>table类型声明</h2><p>使用<code>@type table</code>可以表示某变量为表格类型<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@type table&lt;key_type, value_type&gt;</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---@type table&lt;string, Car&gt;</span><br><span class="line">local dict &#x3D; &#123;&#125;</span><br><span class="line">local car &#x3D; dict[&#39;key&#39;]</span><br><span class="line">-- car. and you&#39;ll see completion</span><br><span class="line">for key, car in pairs(dict) do</span><br><span class="line">	-- car. and you&#39;ll see completion</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h2 id="函数声明"><a href="#函数声明" class="headerlink" title="函数声明"></a>函数声明</h2><p>使用<code>fun(param:my_type):return_type</code>来表示函数类型变量<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@type fun(param:my_type):return_type</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@type fun(key:string):Car</span><br><span class="line">local carCreatorFn1</span><br><span class="line"></span><br><span class="line">local car &#x3D; carCreatorFn1(&#39;key&#39;)</span><br><span class="line">-- car. and you see code completion</span><br><span class="line"></span><br><span class="line">---@type fun():Car[]</span><br><span class="line">local carCreatorFn2</span><br><span class="line"></span><br><span class="line">for i, car in pairs(carCreatorFn2()) do</span><br><span class="line">	-- car. and you see completion</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h2 id="字面常量类型声明"><a href="#字面常量类型声明" class="headerlink" title="字面常量类型声明"></a>字面常量类型声明</h2><p>字面常量也可以指定特定字符串来作为代码提示，结合别名，可以起到类似于枚举的效果<br>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---@alias Handler fun(type: string, data: any): void</span><br><span class="line"></span><br><span class="line">---@param event string | &quot;&#39;onClised&#39;&quot; | &quot;&#39;onData&#39;&quot;</span><br><span class="line">---@param handler Handler | &quot;function(type, data) print(data) end&quot;</span><br><span class="line">function addEventListener(event, handler)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>上面的写法还是比较复杂，我们可以用<code>@alias</code>再简化一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---@alias Handler fun(type: string, data: any): void</span><br><span class="line">---@alias IOEventEnum string | &quot;&#39;onClised&#39;&quot; | &quot;&#39;onData&#39;&quot;</span><br><span class="line">---@param event IOEventEnum</span><br><span class="line">---@param handler Handler | &quot;function(type, data) print(data) end&quot;</span><br><span class="line">function addEventListener(event, handler)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<pre><code>

</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/blogs/page/2/">2</a><a class="page-number" href="/blogs/page/3/">3</a><a class="extend next" rel="next" href="/blogs/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Tyson Wu"
      src="/blogs/images/avatar.png">
  <p class="site-author-name" itemprop="name">Tyson Wu</p>
  <div class="site-description" itemprop="description">If you want, Just do it!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blogs/archives/">
        
          <span class="site-state-item-count">24</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blogs/categories/">
          
        <span class="site-state-item-count">27</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blogs/tags/">
          
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Tyson-Wu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Tyson-Wu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/zhao-wu-zhu-43" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;zhao-wu-zhu-43" rel="noopener" target="_blank"><i class="知乎 fa-fw"></i>知乎</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.cnblogs.com/Hi-blog/" title="https:&#x2F;&#x2F;www.cnblogs.com&#x2F;Hi-blog&#x2F;" rel="noopener" target="_blank">starnight_cyber</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tyson Wu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blogs/lib/anime.min.js"></script>
  <script src="/blogs/lib/velocity/velocity.min.js"></script>
  <script src="/blogs/lib/velocity/velocity.ui.min.js"></script>

<script src="/blogs/js/utils.js"></script>

<script src="/blogs/js/motion.js"></script>


<script src="/blogs/js/schemes/pisces.js"></script>


<script src="/blogs/js/next-boot.js"></script>




  















  

  

</body>
</html>
