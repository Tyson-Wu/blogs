---
title: GOAP
date: 2021-05-27 15:01:00
categories:
- [AI, GOAP]
tags:
- AI
- GOAP
---

GOAP是以目标为导向的行为规划。其思路是对行为进行拆分，同时描述每个行为发生的前置条件，以及相应会产生的结果。然后将条件、结果、目标统一视为状态集合，那么只需要关心这三类状态集之间的关系，然后进行有效的拼接组合，其相应的行为之间的关系也就明了了。

## 提出问题
首先，整个世界就是一个状态集，每个行为可以对部分状态产生影响，正向或反向。而有些行为可能需满足特定状态下才坑能发生。
那么，以什么样的顺序执行哪些行为，才能达到相应的状态，实现特定的目标呢？

## 分析
上面的问题表明，我们需要求出一组有序的行为组合。而行为之所以有序，是因为行为之间有一定的相互依赖关系，例如只有伐木、做家具、卖家具，这三者是前后依赖关系。伐木可以得到木材，得到木材就是伐木的结果；做家具需要木材，得到木材就是做家具的条件；做家具得到家具，家具就是做家具的结果；买家具需要有家具，所以有家具是卖家具的条件。
假设我想卖家具，此时卖家具是我的目标，然后我从这三个行为里面查找，发现第三个行为刚好满足我的目标，但是从卖家具这个行为来看，我们首先得有家具，如果刚好有，那么完美。如果没有，那么有家具就是我们的新目标，然后根据这个新目标，我们查找到第二个行为刚好可以满足。至此我们得到做家具、卖家具这条行为组合，但是还没完，我们还需要判断做家具的条件是否满足，如果不满足，则需要继续查找它的上一个行为。
上面这个卖家具的问题简单的阐述了GOAP的一个从目标出发的、不断迭代的一个逆向查找解决方案的思路。但是，在实际应用中，遇到的问题可能会更复杂，状态会更多，同时状态之间的关联也不是一对一的。这时候我们就需要把握GOAP的一些关键信息，将其抽取出来。

## 泛化
为了将问题泛化，我们假设目标可以划分为多个状态的组合，而每个行为会对部分状态产生影响。这时候如何应用目标导向的思路呢？
首先我们也是找到最接近目标的行为。然后判断这个行为的条件是否满足，如果不满足，则将其条件也纳入目标中，形成一个新的目标。同时，对于该行为已经达成的状态，则从新目标中剔除。然后继续查找最接近新目标的行为，依此类推，不断迭代，直到新目标中的状态为空时。
这里提到最接近目标的行为。什么事最接近目标的行为呢？
以我想打扫卫生为例，环境状态为：我是否饥饿、地是否干净、桌子是否干净、是否有水、是否有生活垃圾；而我可以执行的行为有：吃饭、扫地、抹桌子、把水倒掉、把生活垃圾倒在地上。那么我的目标就是：地干净、桌子干净。
1、该行为的结果一定会对目标的状态集产生影响，即便不能立即达成目标，也能完成部分状态。如果没有这种正向的影响，说明这个行为和目标无关。如这里的吃饭；
2、该行为的结果不能对目标的状态集产生消极的影响。如把垃圾倒在地上，很明显倒完之后还得清理，所以对于打扫卫生来说并不是最接近目标的一步。
3、在执行该行为后，不能立即达到当前目标，也就是该行为的结果不能覆盖目标状态，这时候该行为的条件不能和目标状态相冲突。例如扫地和抹桌子都只能完成部分清理，假设我们选抹桌子为最后的行为，其条件为空，和目标状态冲突。如果说抹桌子的条件是地必须是脏的，这时候和目标状态地是干净的相冲突，在抹完桌子后肯定还得扫地，所以抹桌子不可以作为左后行为。

## 总结
假设世界有一系列状态组成，同时有一系列可选行为，这些行为分别有各自的状态前置条件、以及执行后能产生的状态影响。
那么我们需要达成某一目标时，首先分离出目标中的状态集。然后基于这个状态集，查找最近行为，在查找到最近行为后，将最近行为所达成的状态从目标状态集中剔除，然后将最近行为中未达成的前置条件纳入到新的目标状态集中。然后基于新的目标状态集进行新一轮的最近行为筛选，依此类推，直到新的目标状态为空时，说明我们筛选出的行为组合和目标状态已经形成了一个闭环。而我们的行为组合是从最后一个开始，倒序筛查的，所以需要进行颠倒才能得到正常的行为执行顺序。
而最近行为的标准，需要满足：
- 能都达成部分目标
- 其行为结果和目标没有冲突，不会对已经达成的目标产生破坏
- 其前置条件和目标没有冲突，如果有冲突，其行为结果能够修复这种冲突


