---
title: 4.1 Git On the Server - The Protocols
date: 2020-11-21 17:01:34
categories:
- [Git, Server]
tags:
- Git
---
学习本节之前，我们应该熟练使用Git完成日常版本维护工作。然而，在多人配合开发时，我们还需要一个远端Git仓库。远端仓库作为公共的Git仓库，可以保证即使某个成员的电脑处于关机状态，其他成员也可以知道彼此的开发进度以及修改内容。

建立Git服务非常简单，首先，我们选择服务所使用的协议。本节将会介绍可选的协议，以及这些协议的优缺点。然后我们会再介绍这些协议相关的常用设置。最后，我们学习部分托管选项，如果我们不介意在其他服务器上托管代码，并且不想设置和维护自己的Git服务，这些托管选项可以帮我们实现这个目标。

本章最后一节介绍的时如何搭建自己的Git服务，不感兴趣可以跳过，直接进入下一章节。下一章节讨论分布式源码控制环境的各种利弊。

远端仓库只是一个纯粹的仓库，换句话来说，它只包含.git文件。

## The Protocols

Git可以使用四种不同的协议来传输数据：Local、HTTP、Secure Shell(SSH)、 以及 Git。下面我们看下这些协议是什么以及在什么情况下需要。

### Local Protocol

Local是最基本的协议，当我们在本机上建立Git远端仓库时，就是通过Local协议来访问的。例如在所有成员可访问的共享文件系统上搭建的Git仓库。

使用Local协议可以访问这种本机创建的Git仓库，包括上传和下载。例如克隆仓库：
``` bash
git clone /srv/git/project.git
```
也可以这样写：
``` bash
git clone file:///srv/git/project.git
```

上面两种写法有一些区别，第一种是类似于本机直接文件复制的操作。第二种数据会经过网络，所以会更慢一点。下面采用的第一种方法，因为速度会更快一点。
将本地Git仓库导入到一个现有的本地Git服务，我们执行下面的操作：
``` bash
git remote add local_proj /srv/git/project.git
```

#### The Pros

基于文件系统的仓库的好处是，他们的建立方式简单，可以使用现有的文件权限以及网络进行访问。如果我们有一个共享文件系统，那么建立共享的Git服务是非常方便的。我们只要将纯数据仓库，也就是包含.git的文件放到一个共享路径下，然后像其他共享文件一样，设置其读写权限。

相比于从网络远端访问Git仓库，这种共享本地本地仓库无疑是最快速的。

#### The Cons

缺点是，这种方式难以从多个不同的地方进行访问。如果我们想在家访问的话，我们必须安装远程磁盘。相比于直接网络请求，这种方式很复杂也很慢。

还有一点是，Local协议并不一定是最快的，这和仓库部署的位置有关。如果是本机上部署，无疑是最快的。如果是在NFS上部署，那么其访问速度反而比不上SSH。

最后，这种协议无法保证仓库不受偶然性损坏。任何一个能够访问仓库的人，都能直接访问到.git文件，因此一旦发生手动修改.git文件，将导致仓库损坏。

### The HTTP Protocols
 
Git可以通过HTTP协议进行通信，通信方式有两种。在Git 1.6.6版本之前，只有一种方法，这种方法很简单，通常只有只读功能。在1.6.6版本之后，加入一个新的、更智能的协议，这种协议和SSH类型，能够智能地调整数据传输方式。在最近几年，这种新的协议方式开始普及，因为它具有简单、智能通信方式。这种新的方式通常被称为Smart Http，而老的方式则被称为Dump Http。我们先看一下Smart Http.

#### Smart Http

Smart Http操作非常类型于SSH和Git协议。区别在于他是走标准的HTTPS端口，能够使用HTTP权限机制。这意味着，他比SSH更容易使用，因为我们可以使用账号密码权限，而不需要设置SSH Key值。

Smart Http很可能称为Git种最流行的协议。因为他可以设置为像 git://协议一样的匿名服务，亦可以像SSH一样使用权限加密推送。但是他不需要为两种方式设置不同的URL，我们只需要一个URL就可以实现两种方式。如果我们像执行推送上传操作，但是远端仓库需要权限，这时候服务会提示账号密码，读取方式也一样。

时结束，像GitHub这种服务，我们用来查看线上仓库的URL，可以用来执行克隆操作，如果我们权限足够的话，也可以进行推送上传操作。

#### Dump Http

如果远端服务不是以Smart Http方式响应，那么Git客户端会使用Dump Http协议。这种协议假定我们的Git仓库在网络服务中的管理方式像普通文件一样。Dump HTTP最吸引人的地方是他简洁的设置方式。基本上来说，我们只需要将Git仓库放在Http文档的根目录下，然后设置一个post-update连接。此时，任何可以访问您部署仓库的Web服务器的人也可以克隆您的存储库。若要允许通过 HTTP 读取对存储库的访问，请进行如下操作：
``` bash
cd /var/www/htdocs/
git clone --bare /path/to/git_project git project.git
cd gitproject.git
mv hooks/post-update.sample hooks/post-update
chmod a+x hooks/post-update
```

#### The Pros

来重点看一下Smart Http协议。

对于所有访问类型简化为只有一个URL，并且服务只有需要权限时才会提示账号密码，这些使得Smart Http使用起来非常容易。相比于SSH而言，使用账号密码进行身份验证也是其一大优势。因为用户不必去创建SSH key，也不用上传这个key到服务端。只要输入账号密码就可以访问Git服务。对于初级用户或者不了解SSH的用户，这是一个巨大的优势。但是Smart HTTP和SSH一样，属于快速有效的协议。

我们还可以通过 HTTPS 为存储库提供只读服务，这意味着我们可以加密内容传输;我们甚至可以让客户端使用特定的签名 SSL 证书。

还有就是，HTTP和HTTPS都是非常通用的协议，公司防火墙通常不会拦截这个端口。

#### The Cons

相比于SSH，在使用HTTPS在些某些服务上部署Git会更麻烦点。除此之外，相比于HTTP部署的Git，其他协议的优势几乎没有。

但是，如果我们使用签名验证的方式推送上传的话，HTTP提供凭证的方式会比SSH使用key的方式更麻烦。当然，有很多缓存凭证的工具可以解决这个问题，像macOS上的Keychin，Windows上的Credential Manager。查看[凭证存储](https://git-scm.com/book/en/v2/ch00/_credential_caching)了解如何在我们系统上设置安全的HTTP密码缓存。

### SSH Protocol

自托管在SSH上时，一种常用的Git传输协议。因为在很多服务上都设置了SSH访问方式，即便没有，我们也可以很容易进行设置。SSH也是一个签名验证网络协议，因为他无处不在，非常容易设置与使用。

通过SSH克隆Git仓库，我们需要指定一个以ssh://开头的URL：
``` bash
git clone ssh://[user@]server/project.git
```

或者我们可以使用SCP形式的、更短的语法来使用SSH协议：
``` bash
git clone [user@]server:project.git
```

#### The Pros

SSH的优势非常多。首先SHH是一个相对容易去设置的-SSH的守护程序遍地都是；很多网络管理者熟悉他；很多系统部署都需要他来设置，或者有工具去管理他们。第二，使用SSH方式访问是安全的-所有数据传输都是金国加密的，并且需要签名验证。第三，像HTTPS、Git、和Local协议，SSH是高效的，数据传输前经过不断的压缩。

#### The Cons

SSH的缺点是，他不支持Git仓库的匿名访问。如果我们使用SSH，我们必须拥有计算机的SSH的访问权限，及时只是只读的权限。这使得SSH不利于开源项目，因为很多时候我们只想克隆一个开源项目。如果我们仅仅只是在公司内网使用Git服务，那么SSH可能是最合适的协议了。如果我们既想只读匿名访问，又想使用SSH，则我们需要设置SSH，使得我们可以推送上传，但是其他人只能下载。

### The Git Protocol

最后是Git协议。它是一种特殊的、附加在Git中的进程守护协议。她监听一个具体的端口(9418)，这个端口提供一个类似于SSH协议的服务，但是没有签名验证。为了使用Git协议访问仓库，我们必须创建一个git-daemon-export-ok文件，如果没有这个文件，守护进程是不会管理这个仓库的，仓库的安全性得不到保证。无论Git仓库可供所有人克隆，也可以不供所有人克隆。这意味着，通常不会使用这个协议进行推送上传操作。我么可以开启推送权限，但是由于缺少签名验证，任何人只要知道我们项目的URL，都可能向我们项目仓库执行推送上传操作。因此很少会是哦也能够这个协议进行推送。

#### The Pros

Git协议通常是最快的网络传输协议。如果我们刚好需要处理一个开源项目、或者一个不需要签名验证的只读权限的大项目，这时候可能会用到Git守护进程来维护我们的项目。Git协议的数据传输方式和SSH协议一样，只是没有了加密和签名验证。

#### The Cons

缺点就是没有签名验证。我们不应该将Git协议作为我们项目唯一的访问方式。通常我们是将Git协议和SSH或HTTPS协议一起使用的，少数开发者使用SSH或HTTPS协议对项目进行推送操作。而其他人则使用git://对项目进行只读操作。从设置的角度来说，Git协议也可能是最复杂的协议。她必须执行Git的守护进程，这个进程需要xinetd、systemd配置，或者类似的配置。还需要防火访问端口9418，这不是所有公司防火墙允许的标准端口。在一些大公司中，这个端口通常被锁。