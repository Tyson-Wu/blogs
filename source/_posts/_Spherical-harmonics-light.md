---
title: Basics of Spherical Harmonics And Light Probes
date: 2021-04-014 10:01:00
categories:
- [Unity, URP, Light]
tags:
- Render
- Shader
---

## [Basics of Spherical Harmonics](https://computergraphics.stackexchange.com/questions/4164/what-are-spherical-harmonics-light-probes)

球谐函数是一种球面二维函数。在图形学中可以使用Cube六面体来表示空间区域，以及环境贴图等，但是它表示的还是三维空间。球谐空间是定义在频域的一种空间，具有很多有趣的属性，而且很多操作和光有一定的关联，因此在光照渲染中使用球谐空间可以提高性能。随着球谐空间“次”的提升，我们可以拟合出高频函数，如下图所示，l表示的是“次”。通过对下面基本函数的组合，我们可以拟合出球面上的二维函数。这些基础函数是由“associated legendre polynomials”-[关联拉格朗日多项式](https://en.wikipedia.org/wiki/Associated_Legendre_polynomials)定义。但是我们并不需要自行推导这些函数，因为别人已经推导过了[spherical harmonics](https://en.wikipedia.org/wiki/Table_of_spherical_harmonics#Real_spherical_harmonics)

![](https://i.stack.imgur.com/QPNGz.png)

在球谐函数中有一个高效的操作叫做[卷积](https://en.wikipedia.org/wiki/Convolution)，通过卷积我们可以对两个球面函数求积和，这在光学中是一个非常常用的操作。例如我们用一个球谐函数表示入射光，另一个表示BRDF，这样的话，我们只需要简单的点乘两个球谐因子向量。

另一个有趣的操作是可以实现低通滤波。因为球谐函数本身表示的是频域。我们只需要对球谐函数进行缩放，然后剔除小于零的值就行。但是也有一些操作，相较于空域来说，会比较复杂。例如，我们使用球谐函数来表达旋转函数时，随着球谐函数“次”的增高（高次球谐函数），计算量也会急剧升高。所以需要考虑球谐函数的适用场景。

球谐函数通常只是用来拟合低频函数，因为高频函数需要增加球谐因子，以及运算量。因此我们不会用球谐函数来拟合高光反射。

还有一个操作叫做“球谐投影”，用来将空域转换到球谐函数。这个操作是通过对空域数据和球谐基本函数进行卷积。相比于空域，转换后的球谐函数不会产生锯齿效果，即便是低次球谐函数也是如此。


## Light Probes

前面介绍了球谐函数的一些操作和特性。下面来看一下如何将球谐函数应用到GI中。光照探针是用来采集某个空间位置的光照强度，也就是各个方向射向该位置的光照强度。因此需要用一个球面来记录这些光照强度。前面讲到球谐函数是用来拟合球面的二维函数。那么一个球谐函数就可以表示球面上各个点的亮度，三个球谐函数可以用来表示球面上各个点的颜色。

光照探针只记录Lambertian漫反射光(入射光)，所以低次球谐函数就足够了。光照探针的球谐函数求解思路很简单，就是先基于光照探针位置捕捉一个Cube环境贴图，然后将环境贴图投影到球面，然后再拟合球谐函数，计算出球谐因子。

当我们渲染模型时，我们通过筛选出附件几个光照探针，然后对这些光照探针进行插值，从而计算出指定空间点的入射光。例如，我们直接对附近光照探针的球谐因子进行插值，然后执行基于像素点法向量的卷积操作。










