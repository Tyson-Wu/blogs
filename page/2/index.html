<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/blogs/images/girl_180_0.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blogs/images/girl_32_0.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blogs/images/girl_16_0.png">
  <link rel="mask-icon" href="/blogs/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blogs/css/main.css">


<link rel="stylesheet" href="/blogs/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"tyson-wu.github.io","root":"/blogs/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="If you want, Just do it!">
<meta property="og:type" content="website">
<meta property="og:title" content="TysonWu&#39;s Blog">
<meta property="og:url" content="https://tyson-wu.github.io/blogs/page/2/index.html">
<meta property="og:site_name" content="TysonWu&#39;s Blog">
<meta property="og:description" content="If you want, Just do it!">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Tyson Wu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://tyson-wu.github.io/blogs/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>TysonWu's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blogs/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">TysonWu's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">AiCooXiao</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blogs/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blogs/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/blogs/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blogs/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blogs/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2021/04/14/Spherical-harmonics-light/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2021/04/14/Spherical-harmonics-light/" class="post-title-link" itemprop="url">Basics of Spherical Harmonics And Light Probes</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-14 10:01:00" itemprop="dateCreated datePublished" datetime="2021-04-14T10:01:00+08:00">2021-04-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-29 11:27:08" itemprop="dateModified" datetime="2021-06-29T11:27:08+08:00">2021-06-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/URP/" itemprop="url" rel="index"><span itemprop="name">URP</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/URP/Light/" itemprop="url" rel="index"><span itemprop="name">Light</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Basics-of-Spherical-Harmonics"><a href="#Basics-of-Spherical-Harmonics" class="headerlink" title="Basics of Spherical Harmonics"></a><a target="_blank" rel="noopener" href="https://computergraphics.stackexchange.com/questions/4164/what-are-spherical-harmonics-light-probes">Basics of Spherical Harmonics</a></h2><p>球谐函数是一种球面二维函数。在图形学中可以使用Cube六面体来表示空间区域，以及环境贴图等，但是它表示的还是三维空间。球谐空间是定义在频域的一种空间，具有很多有趣的属性，而且很多操作和光有一定的关联，因此在光照渲染中使用球谐空间可以提高性能。随着球谐空间“次”的提升，我们可以拟合出高频函数，如下图所示，l表示的是“次”。通过对下面基本函数的组合，我们可以拟合出球面上的二维函数。这些基础函数是由“associated legendre polynomials”-<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Associated_Legendre_polynomials">关联拉格朗日多项式</a>定义。但是我们并不需要自行推导这些函数，因为别人已经推导过了<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Table_of_spherical_harmonics#Real_spherical_harmonics">spherical harmonics</a></p>
<p><img src="https://i.stack.imgur.com/QPNGz.png"></p>
<p>在球谐函数中有一个高效的操作叫做<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Convolution">卷积</a>，通过卷积我们可以对两个球面函数求积和，这在光学中是一个非常常用的操作。例如我们用一个球谐函数表示入射光，另一个表示BRDF，这样的话，我们只需要简单的点乘两个球谐因子向量。</p>
<p>另一个有趣的操作是可以实现低通滤波。因为球谐函数本身表示的是频域。我们只需要对球谐函数进行缩放，然后剔除小于零的值就行。但是也有一些操作，相较于空域来说，会比较复杂。例如，我们使用球谐函数来表达旋转函数时，随着球谐函数“次”的增高（高次球谐函数），计算量也会急剧升高。所以需要考虑球谐函数的适用场景。</p>
<p>球谐函数通常只是用来拟合低频函数，因为高频函数需要增加球谐因子，以及运算量。因此我们不会用球谐函数来拟合高光反射。</p>
<p>还有一个操作叫做“球谐投影”，用来将空域转换到球谐函数。这个操作是通过对空域数据和球谐基本函数进行卷积。相比于空域，转换后的球谐函数不会产生锯齿效果，即便是低次球谐函数也是如此。</p>
<h2 id="Light-Probes"><a href="#Light-Probes" class="headerlink" title="Light Probes"></a>Light Probes</h2><p>前面介绍了球谐函数的一些操作和特性。下面来看一下如何将球谐函数应用到GI中。光照探针是用来采集某个空间位置的光照强度，也就是各个方向射向该位置的光照强度。因此需要用一个球面来记录这些光照强度。前面讲到球谐函数是用来拟合球面的二维函数。那么一个球谐函数就可以表示球面上各个点的亮度，三个球谐函数可以用来表示球面上各个点的颜色。</p>
<p>光照探针只记录Lambertian漫反射光(入射光)，所以低次球谐函数就足够了。光照探针的球谐函数求解思路很简单，就是先基于光照探针位置捕捉一个Cube环境贴图，然后将环境贴图投影到球面，然后再拟合球谐函数，计算出球谐因子。</p>
<p>当我们渲染模型时，我们通过筛选出附件几个光照探针，然后对这些光照探针进行插值，从而计算出指定空间点的入射光。例如，我们直接对附近光照探针的球谐因子进行插值，然后执行基于像素点法向量的卷积操作。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2021/04/06/URP_Render_1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2021/04/06/URP_Render_1/" class="post-title-link" itemprop="url">URP 学习总结1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-06 10:01:00" itemprop="dateCreated datePublished" datetime="2021-04-06T10:01:00+08:00">2021-04-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-29 11:27:08" itemprop="dateModified" datetime="2021-06-29T11:27:08+08:00">2021-06-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/URP/" itemprop="url" rel="index"><span itemprop="name">URP</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="URP提供的工具函数"><a href="#URP提供的工具函数" class="headerlink" title="URP提供的工具函数"></a>URP提供的工具函数</h2><p><code>VertexPositionInputs GetVertexPositionInputs(positionOS)</code><br>计算出各个空间下的顶点坐标</p>
<p><code>VertexNormalInputs GetVertexNormalInputs(normalOS)</code><br>计算出各个空间下的顶点法向坐标</p>
<p><code>half3 VertexLighting(positionWS, normalWS)</code><br>获取指定顶点的顶点光照，当定义了<code>_ADDITIONAL_LIGHTS_VERTEX</code>，表明使用顶点光照，并返回光照值，否则返回零<br><code>uint GetAdditionalLightsCount()</code><br>获取作用在当前空间位置上的辅光源数量，其中<code>_AdditionalLightsCount.x</code>表示场景中所有被激活的灯光，在场景剔除的过程中，由渲染管线计算并提交。而<code>unity_LightData.y</code>应该是表示所有的光照数量。<br><code>Light GetAdditionalLight(lightIndex, positionWS)</code><br>获取指定辅光源作用在指定空间位置的光照值，<code>lightIndex</code>表示辅光源在当前空间点辅光源列表中的索引值。<br><code>int GetPerObjectLightIndex(lightIndex)</code><br>基于当前辅光源在当前空间点辅光源列表中的索引值，计算辅光源在所有激活光源中的索引值<br><code>Light GetAttitionalPerObjectLight</code>(perObjectLightIndex, positionWS)`<br>场景中的每个物体受部分光源的影响，具体受哪些光源的影响根据光源排序确定，然后每个物体记录其受光源的索引值。需要清楚地是所有的光源信息是统一存放在一个公共Buffer里面。</p>
<p>shadowParams.x : 阴影强度<br>shadowParams.y : 1.0 表示软阴影， 0.0表示其他</p>
<p>unity_LightData.x ：表示当前模型灯光在灯光缓存中的起始索引偏移值</p>
<p>unity_LightData.z : 表示该光源是否可见，可见为1.0，不可见为0.0</p>
<p>float4 unity_LightIndices[2] : 每个模型最大辅光源个数为8， 这里面便存着实际光源的索引值</p>
<p>物理含义<br>NdotH : 表示观察视角和镜面反射的重合度，重合度越高，观察的光越强<br>LdotH : 表示入射光和观察视角的重合度</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2021/04/06/Unity-Editor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2021/04/06/Unity-Editor/" class="post-title-link" itemprop="url">Unity Editor</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-06 10:01:00" itemprop="dateCreated datePublished" datetime="2021-04-06T10:01:00+08:00">2021-04-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-29 11:27:08" itemprop="dateModified" datetime="2021-06-29T11:27:08+08:00">2021-06-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/Editor/" itemprop="url" rel="index"><span itemprop="name">Editor</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="获取当前选择的目录"><a href="#获取当前选择的目录" class="headerlink" title="获取当前选择的目录"></a>获取当前选择的目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public static string GetCurrentAssetDirectory()</span><br><span class="line">&#123;</span><br><span class="line">	foreach(var obj in Selection.GetFiltered&lt;Object&gt;(SelectionMode.Assets))</span><br><span class="line">	&#123;</span><br><span class="line">		var path &#x3D; AssetDataBase.GetAssetPath(obj);</span><br><span class="line">		if(string.IsNullOrEmpty(path))</span><br><span class="line">		&#123;</span><br><span class="line">			return path;</span><br><span class="line">		&#125;</span><br><span class="line">		else if(System.IO.File.Exists(path))</span><br><span class="line">		&#123;</span><br><span class="line">			return System.IO.Path.GetDirectory(path);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return &quot;Assets&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建hlsl脚本"><a href="#创建hlsl脚本" class="headerlink" title="创建hlsl脚本"></a>创建hlsl脚本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public static class AssetsMenu</span><br><span class="line">&#123;</span><br><span class="line">	[MenuItem(&quot;Assets&#x2F;Create HLSL&quot;)]</span><br><span class="line">	public static void CreateHLSL()</span><br><span class="line">	&#123;</span><br><span class="line">		&#x2F;&#x2F;string projectPath &#x3D; Path.GetDirectoryName(Application.dataPath);</span><br><span class="line">		</span><br><span class="line">		string assetPath &#x3D; Path.Combine(GetCurrentAssetDirectory(), &quot;temp.hlsl&quot;);</span><br><span class="line">		assetPath &#x3D; AssetDataBase.generateuniqueAssetPath(assetPath);</span><br><span class="line">		</span><br><span class="line">		AssetDataBase.CreateAsset(new TextAsset(&quot;--&quot;, assetPath);</span><br><span class="line">		File.WriteAllText(assetPath, &quot;&quot;); &#x2F;&#x2F; clean</span><br><span class="line">		</span><br><span class="line">		AssetDataBase.SaveAssets();</span><br><span class="line">		AssetDataBase.Refresh();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2021/01/30/EmmyLua-for-IntelliJ-IDEA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2021/01/30/EmmyLua-for-IntelliJ-IDEA/" class="post-title-link" itemprop="url">EmmyLua 的使用方法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-30 10:38:34" itemprop="dateCreated datePublished" datetime="2021-01-30T10:38:34+08:00">2021-01-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-29 11:27:08" itemprop="dateModified" datetime="2021-06-29T11:27:08+08:00">2021-06-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Lua/" itemprop="url" rel="index"><span itemprop="name">Lua</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Lua/EmmyLua/" itemprop="url" rel="index"><span itemprop="name">EmmyLua</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>EmmyLua是Jetbrains IDE的一个插件，它提供了一套注解的语法，可以帮助IDE进行代码之间索引跳转，以及变量名称提示等功能。总而言之，EmmyLua是丰富IDE的功能，和实际的代码没有关系，IDE的跳转也只是限于注释之间。</p>
<h2 id="类的声明"><a href="#类的声明" class="headerlink" title="类的声明"></a>类的声明</h2><p>EmmyLua使用@class来模拟面向对象编程，支持继承和属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--- my supper class</span><br><span class="line">---@class Transport</span><br><span class="line">local p &#x3D; Class()</span><br><span class="line"></span><br><span class="line">--- 子类</span><br><span class="line">---@class Car : Transport</span><br><span class="line">local cls &#x3D; Class(p)</span><br><span class="line">function c:test()</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--@class my_type[: parent_type] [@comment]</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---@class Car : Transport @define class Car extends Transport</span><br><span class="line">local cls &#x3D; class()</span><br><span class="line">function clas:test()</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>上面定义了一个Car类，我们可以使用@type Car来表明某个变量属于Car类</p>
<h2 id="变量的声明"><a href="#变量的声明" class="headerlink" title="变量的声明"></a>变量的声明</h2><p>使用<code>@type</code>可以指明某个变量的类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---@type Car</span><br><span class="line">local car1 &#x3D; getCar()</span><br><span class="line">---@type Car</span><br><span class="line">global_car &#x3D; getCar()</span><br><span class="line">global_car:test()</span><br></pre></td></tr></table></figure>
<p>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@type my_type[|other_type] [@comment]</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">---@type Car @instance of car</span><br><span class="line">local car1 &#x3D; &#123;&#125;</span><br><span class="line"></span><br><span class="line">---@type Car|Ship @transport tools, car or ship. Since lua is dynamic-typed, a variable may be of different types</span><br><span class="line">---use | to list all possible types</span><br><span class="line">local transport &#x3D; &#123;&#125;</span><br><span class="line"></span><br><span class="line">---@type Car @global variable type</span><br><span class="line">global_car &#x3D; &#123;&#125;</span><br><span class="line"></span><br><span class="line">local obj &#x3D; &#123;&#125;</span><br><span class="line">---@type Car @property type</span><br><span class="line">obj.car &#x3D; getCar()</span><br></pre></td></tr></table></figure>

<h2 id="别名注释"><a href="#别名注释" class="headerlink" title="别名注释"></a>别名注释</h2><p>使用<code>@alias</code>将一些复杂不容易输入的类型注册为新的容易输入的类型<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@alias new_name type</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---@alias Handler fun( type: string, data: any):void</span><br><span class="line">---@param handler Handler</span><br><span class="line">function addHandler(handler)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h2 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h2><p>使用<code>@param</code>来指定函数的参数类型<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@param param_name my_type[|other_type] [@comment]</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">---@param car Car</span><br><span class="line">local function setCar(car)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">---@param car Car</span><br><span class="line">setCallback(function(car)</span><br><span class="line">end)</span><br><span class="line"></span><br><span class="line">---@param car Car</span><br><span class="line">for k, car in pairs(list) do</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h2 id="函数返回值类型说明"><a href="#函数返回值类型说明" class="headerlink" title="函数返回值类型说明"></a>函数返回值类型说明</h2><p>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@return my_type[|other_type] [@comment]</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">---@return Car|Ship</span><br><span class="line">local function crate()</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">---here car_or_ship doesn&#39;t need @type annotation, EmmyLua has already inferred the type via &quot;create&quot; function</span><br><span class="line">local car_or_ship &#x3D; create()</span><br><span class="line"></span><br><span class="line">---@return Car</span><br><span class="line">function factory:create()</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h2 id="属性声明"><a href="#属性声明" class="headerlink" title="属性声明"></a>属性声明</h2><p>使用<code>@field</code>可以标明类所具有的属性，即使类中没有使用到这个属性<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@field [public|protected|private] field_name field_type[|other_type] [@comment]</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">---@class Car</span><br><span class="line">---@field public name string @add name field to class Car, you&#39;ll see it in code completion</span><br><span class="line">local cls &#x3D; class()</span><br></pre></td></tr></table></figure>

<h2 id="泛型声明"><a href="#泛型声明" class="headerlink" title="泛型声明"></a>泛型声明</h2><p>使用<code>@generic</code>来模拟一些高级语言的泛型<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@generic T1 [: parent_type] [, T2 [: parent_type]]</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">---@generic T : Transport, K</span><br><span class="line">---@param param1 T</span><br><span class="line">---@param param2 K</span><br><span class="line">---@return T</span><br><span class="line">local function test(param1, param2)</span><br><span class="line">	-- todo</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">---@type Car</span><br><span class="line">local car &#x3D; ...</span><br><span class="line">local value &#x3D; test(car)</span><br></pre></td></tr></table></figure>
<p>这里说明一下，上面的<code>T</code>和<code>K</code>都是类型，只不过<code>T</code>是继承自<code>Transport</code>的一种类型，而<code>K</code>可以是任何类型。<br>然后<code>param1</code>是类型<code>T</code>的实例</p>
<h2 id="不定参数的注释"><a href="#不定参数的注释" class="headerlink" title="不定参数的注释"></a>不定参数的注释</h2><p>使用<code>@vararg</code>注解函数不定参数部分<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@vararg type</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">---@vararg string</span><br><span class="line">---@return string</span><br><span class="line">local function format(...)</span><br><span class="line">	local tbl &#x3D; &#123;...&#125; --inferred as string[]</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h2 id="嵌入其他语言"><a href="#嵌入其他语言" class="headerlink" title="嵌入其他语言"></a>嵌入其他语言</h2><p>使用<code>@language</code>可以在lua代码中嵌入其他语言<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@language language_id</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---@language JSON</span><br><span class="line">local jsonText &#x3D; [[&#123;</span><br><span class="line">	&quot;name&quot;:&quot;Emmy&quot;</span><br><span class="line">	&#125;]]</span><br></pre></td></tr></table></figure>

<h2 id="数组类型声明"><a href="#数组类型声明" class="headerlink" title="数组类型声明"></a>数组类型声明</h2><p>使用<code>@type mytype[]</code>可以指定变量类型为数组<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@type my_type[]</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---@type Car[]</span><br><span class="line">local list &#x3D; &#123;&#125;</span><br><span class="line">local car &#x3D; list[1]</span><br><span class="line">-- car, and you &#39;ll see completion</span><br><span class="line"></span><br><span class="line">for i, car in pairs(list) do</span><br><span class="line">	-- car. and you&#39;ll see completion</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h2 id="table类型声明"><a href="#table类型声明" class="headerlink" title="table类型声明"></a>table类型声明</h2><p>使用<code>@type table</code>可以表示某变量为表格类型<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@type table&lt;key_type, value_type&gt;</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---@type table&lt;string, Car&gt;</span><br><span class="line">local dict &#x3D; &#123;&#125;</span><br><span class="line">local car &#x3D; dict[&#39;key&#39;]</span><br><span class="line">-- car. and you&#39;ll see completion</span><br><span class="line">for key, car in pairs(dict) do</span><br><span class="line">	-- car. and you&#39;ll see completion</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h2 id="函数声明"><a href="#函数声明" class="headerlink" title="函数声明"></a>函数声明</h2><p>使用<code>fun(param:my_type):return_type</code>来表示函数类型变量<br>其格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">---@type fun(param:my_type):return_type</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@type fun(key:string):Car</span><br><span class="line">local carCreatorFn1</span><br><span class="line"></span><br><span class="line">local car &#x3D; carCreatorFn1(&#39;key&#39;)</span><br><span class="line">-- car. and you see code completion</span><br><span class="line"></span><br><span class="line">---@type fun():Car[]</span><br><span class="line">local carCreatorFn2</span><br><span class="line"></span><br><span class="line">for i, car in pairs(carCreatorFn2()) do</span><br><span class="line">	-- car. and you see completion</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<h2 id="字面常量类型声明"><a href="#字面常量类型声明" class="headerlink" title="字面常量类型声明"></a>字面常量类型声明</h2><p>字面常量也可以指定特定字符串来作为代码提示，结合别名，可以起到类似于枚举的效果<br>举个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---@alias Handler fun(type: string, data: any): void</span><br><span class="line"></span><br><span class="line">---@param event string | &quot;&#39;onClised&#39;&quot; | &quot;&#39;onData&#39;&quot;</span><br><span class="line">---@param handler Handler | &quot;function(type, data) print(data) end&quot;</span><br><span class="line">function addEventListener(event, handler)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>上面的写法还是比较复杂，我们可以用<code>@alias</code>再简化一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---@alias Handler fun(type: string, data: any): void</span><br><span class="line">---@alias IOEventEnum string | &quot;&#39;onClised&#39;&quot; | &quot;&#39;onData&#39;&quot;</span><br><span class="line">---@param event IOEventEnum</span><br><span class="line">---@param handler Handler | &quot;function(type, data) print(data) end&quot;</span><br><span class="line">function addEventListener(event, handler)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<pre><code>

</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2020/12/23/Joy-Stick-Function-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2020/12/23/Joy-Stick-Function-2/" class="post-title-link" itemprop="url">摇杆实现方法2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-23 22:02:00" itemprop="dateCreated datePublished" datetime="2020-12-23T22:02:00+08:00">2020-12-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-29 11:27:08" itemprop="dateModified" datetime="2021-06-29T11:27:08+08:00">2021-06-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/Component/" itemprop="url" rel="index"><span itemprop="name">Component</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>自己做了个飞行模拟的小游戏，发布到手机上需要用到摇杆来控制。原先是通过一个Joystick类来实现，摇杆位置固定，详细请参考<a href="https://tyson-wu.github.io/blogs/2020/12/23/Joy-Stick-Function/">这里</a><br>但是后面策划说要做成王者荣耀那种，摇杆的位置会根据手指的位置有一定的活动区域，所以我重新写了一份逻辑，并且对代码进行一定的逻辑细分，效果如下：<br><img src="/blogs/images/src/ezgif.com-gif-maker-2.gif" alt="wwwwwww"></p>
<p>首先，我这里将摇杆分为几个部分：</p>
<ul>
<li>摇杆可触发区域，紫色区域，当手指放在该区域时，可以操控摇杆</li>
<li>摇杆中心位置可活动区域，黄色区域，绿色的圆形摇杆背景图的中心点可到达的区域</li>
<li>最后是白色的摇杆和绿色摇杆背景的组合</li>
</ul>
<p>前两个都挂载了一个区域判断的类-<code>TriggerAreaHandler</code>，主要用来判断屏幕点是否在该区域内，如图所示：<br><img src="/blogs/images/src/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20201223224837.png" alt="wwwwwww"><br>详细代码如下：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">using System.Collections;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using UnityEngine;</span><br><span class="line">/// <span class="xml"><span class="tag">&lt;<span class="name">summary</span>&gt;</span></span></span><br><span class="line">/// 用于UI区域判定</span><br><span class="line">/// <span class="xml"><span class="tag">&lt;/<span class="name">summary</span>&gt;</span></span></span><br><span class="line">public class TriggerAreaHandler : MonoBehaviour</span><br><span class="line">&#123;</span><br><span class="line"><span class="code">    RectTransform[] _triggerArea = null;//触发区域</span></span><br><span class="line"><span class="code">    Camera _camera = null;//画布摄像机</span></span><br><span class="line"><span class="code">    Canvas _canvas = null;//画布</span></span><br><span class="line"><span class="code">    void InitTriggerArea()</span></span><br><span class="line"><span class="code">    &#123;//初始化区域</span></span><br><span class="line"><span class="code">        if (_triggerArea != null) return;</span></span><br><span class="line"><span class="code">        _triggerArea = GetComponentsInChildren&lt;RectTransform&gt;();</span></span><br><span class="line"><span class="code">        _canvas = GetComponentInParent&lt;Canvas&gt;();</span></span><br><span class="line"><span class="code">        _camera = _canvas.worldCamera;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    /// &lt;summary&gt;</span></span><br><span class="line"><span class="code">    /// 计算屏幕区域是否在当前区域内</span></span><br><span class="line"><span class="code">    /// &lt;/summary&gt;</span></span><br><span class="line"><span class="code">    /// &lt;param name=&quot;screenPos&quot;&gt;屏幕坐标&lt;/param&gt;</span></span><br><span class="line"><span class="code">    /// &lt;returns&gt;&lt;/returns&gt;</span></span><br><span class="line"><span class="code">    public bool CheckScreenPosInArea(Vector2 screenPos)</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        InitTriggerArea();</span></span><br><span class="line"><span class="code">        for (int i=0;i&lt; _triggerArea.Length;++i)</span></span><br><span class="line"><span class="code">        &#123;</span></span><br><span class="line"><span class="code">            if (RectTransformUtility.RectangleContainsScreenPoint(_triggerArea[i], screenPos, _camera))</span></span><br><span class="line"><span class="code">                return true;</span></span><br><span class="line"><span class="code">        &#125;</span></span><br><span class="line"><span class="code">        return false;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    /// &lt;summary&gt;</span></span><br><span class="line"><span class="code">    /// 将屏幕点夹紧到该区域</span></span><br><span class="line"><span class="code">    /// &lt;/summary&gt;</span></span><br><span class="line"><span class="code">    /// &lt;param name=&quot;screenPos&quot;&gt;&lt;/param&gt;</span></span><br><span class="line"><span class="code">    /// &lt;returns&gt;&lt;/returns&gt;</span></span><br><span class="line"><span class="code">    public Vector2 Clamp(Vector2 screenPos)</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        InitTriggerArea();</span></span><br><span class="line"><span class="code">        Vector2 clampPos = _camera.WorldToScreenPoint(_triggerArea[0].position);</span></span><br><span class="line"><span class="code">        float len = float.MaxValue;</span></span><br><span class="line"><span class="code">        InitTriggerArea();</span></span><br><span class="line"><span class="code">        for (int i = 0; i &lt; _triggerArea.Length; ++i)</span></span><br><span class="line"><span class="code">        &#123;</span></span><br><span class="line"><span class="code">            RectTransform rectTransform = _triggerArea[i];</span></span><br><span class="line"><span class="code">            if (RectTransformUtility.RectangleContainsScreenPoint(_triggerArea[i], screenPos, _camera))</span></span><br><span class="line"><span class="code">            &#123;</span></span><br><span class="line"><span class="code">                return screenPos;</span></span><br><span class="line"><span class="code">            &#125;</span></span><br><span class="line"><span class="code">            else</span></span><br><span class="line"><span class="code">            &#123;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">                Vector2 rectPos = _camera.WorldToScreenPoint(rectTransform.position);</span></span><br><span class="line"><span class="code">                Rect rect = RectTransformUtility.PixelAdjustRect(rectTransform, _canvas);</span></span><br><span class="line"><span class="code">                Vector2 clampPos_temp = Clamp(screenPos, rectPos, new Vector2(rect.width/2, rect.height/2));</span></span><br><span class="line"><span class="code">                float distance = (clampPos_temp - screenPos).sqrMagnitude;</span></span><br><span class="line"><span class="code">                if (distance &lt; len)</span></span><br><span class="line"><span class="code">                &#123;</span></span><br><span class="line"><span class="code">                    len = distance;</span></span><br><span class="line"><span class="code">                    clampPos = clampPos_temp;</span></span><br><span class="line"><span class="code">                &#125;</span></span><br><span class="line"><span class="code">            &#125;</span></span><br><span class="line"><span class="code">        &#125;</span></span><br><span class="line"><span class="code">        return clampPos;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    Vector2 Clamp(Vector2 value,Vector2 center, Vector2 halfSize)</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        return new Vector2(Clamp(value.x, center.x - halfSize.x, center.x + halfSize.x),</span></span><br><span class="line"><span class="code">            Clamp(value.y, center.y - halfSize.y, center.y + halfSize.y));</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    float Clamp(float value, float min, float max)</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        value = value &gt; min ? value : min;</span></span><br><span class="line"><span class="code">        value = value &lt; max ? value : max;</span></span><br><span class="line"><span class="code">        return value;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">&#125;</span></span><br></pre></td></tr></table></figure>
<p>第三部分的摇杆组合，主要是用来显示的，所以下面挂载了一个控制其显示的脚本-<code>JoyStickView</code>，该脚本控制摇杆组合的位置显示，如图所示：<br><img src="/blogs/images/src/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20201223225034.png" alt="wwwwwww"><br>代码如下：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">using System.Collections;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using UnityEngine;</span><br><span class="line">/// <span class="xml"><span class="tag">&lt;<span class="name">summary</span>&gt;</span></span></span><br><span class="line">/// 控制摇杆显示</span><br><span class="line">/// <span class="xml"><span class="tag">&lt;/<span class="name">summary</span>&gt;</span></span></span><br><span class="line">public class JoyStickView : MonoBehaviour</span><br><span class="line">&#123;</span><br><span class="line"><span class="code">    [SerializeField] RectTransform _joyStickCenter;//摇杆的端点</span></span><br><span class="line"><span class="code">    [SerializeField] RectTransform _joyStickOutline;//摇杆端点区域背景,设置为摇杆端点的父节点</span></span><br><span class="line"><span class="code">    [SerializeField] float _joyStickAreaScale = 1;//在背景区域的基础上进行缩放，得到一个活动区域</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    bool _initSize = false;</span></span><br><span class="line"><span class="code">    Canvas _canvas = null;</span></span><br><span class="line"><span class="code">    Vector3 _joyStickOriginScreenPos0 = Vector3.zero; //摇杆初始原点</span></span><br><span class="line"><span class="code">    Vector3 _joyStickOriginScreenPos = Vector3.zero; //摇杆原点</span></span><br><span class="line"><span class="code">    float _joyStickRadius = 0;//摇杆真实的屏幕活动半径</span></span><br><span class="line"><span class="code">    /// &lt;summary&gt;</span></span><br><span class="line"><span class="code">    /// 获取摇杆屏幕活动半径</span></span><br><span class="line"><span class="code">    /// &lt;/summary&gt;</span></span><br><span class="line"><span class="code">    /// &lt;returns&gt;&lt;/returns&gt;</span></span><br><span class="line"><span class="code">    public float GetJoyStickRadius()</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        return _joyStickRadius;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    /// &lt;summary&gt;</span></span><br><span class="line"><span class="code">    /// 计算背景区域的屏幕尺寸</span></span><br><span class="line"><span class="code">    /// 在所有函数之前调用</span></span><br><span class="line"><span class="code">    /// &lt;/summary&gt;</span></span><br><span class="line"><span class="code">    public void CalculateAreaSize()</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        if (_initSize) return; </span></span><br><span class="line"><span class="code">        _initSize = true;</span></span><br><span class="line"><span class="code">        if(_canvas==null)  _canvas = GetComponentInParent&lt;Canvas&gt;();</span></span><br><span class="line"><span class="code">        _joyStickOriginScreenPos0 = _canvas.worldCamera.WorldToScreenPoint(_joyStickOutline.position);</span></span><br><span class="line"><span class="code">        _joyStickOriginScreenPos = _joyStickOriginScreenPos0;</span></span><br><span class="line"><span class="code">        SetJoyStickOriginPos(_joyStickOriginScreenPos0);</span></span><br><span class="line"><span class="code">        Rect rect = RectTransformUtility.PixelAdjustRect(_joyStickOutline, _canvas);</span></span><br><span class="line"><span class="code">        _joyStickRadius = _joyStickAreaScale * rect.width / 2;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    /// &lt;summary&gt;</span></span><br><span class="line"><span class="code">    /// 重置摇杆原点为初始原点</span></span><br><span class="line"><span class="code">    /// &lt;/summary&gt;</span></span><br><span class="line"><span class="code">    /// &lt;returns&gt;摇杆中心点在屏幕上的位置&lt;/returns&gt;</span></span><br><span class="line"><span class="code">    public Vector2 ResetJoyStickOrigionPos()</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        SetJoyStickOriginPos(_joyStickOriginScreenPos0);</span></span><br><span class="line"><span class="code">        return _joyStickOriginScreenPos0;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    /// &lt;summary&gt;</span></span><br><span class="line"><span class="code">    /// 设置整个摇杆的位置</span></span><br><span class="line"><span class="code">    /// &lt;/summary&gt;</span></span><br><span class="line"><span class="code">    /// &lt;param name=&quot;screenPos&quot;&gt;屏幕坐标&lt;/param&gt;</span></span><br><span class="line"><span class="code">    public void SetJoyStickOriginPos(Vector3 screenPos)</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        _joyStickOriginScreenPos.x = screenPos.x;</span></span><br><span class="line"><span class="code">        _joyStickOriginScreenPos.y = screenPos.y;</span></span><br><span class="line"><span class="code">        _joyStickOutline.position = _canvas.worldCamera.ScreenToWorldPoint(_joyStickOriginScreenPos);</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    /// &lt;summary&gt;</span></span><br><span class="line"><span class="code">    /// 基于偏移向量，设置摇杆显示位置</span></span><br><span class="line"><span class="code">    /// &lt;/summary&gt;</span></span><br><span class="line"><span class="code">    /// &lt;param name=&quot;dir&quot;&gt;移动向量&lt;/param&gt;</span></span><br><span class="line"><span class="code">    public void SetJoyStick(Vector2 dir)</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        Vector3 dir3 = dir.sqrMagnitude &gt; 1 ? dir.normalized : dir;</span></span><br><span class="line"><span class="code">        Vector3 joyStickScreenPos = dir3 * _joyStickRadius + _joyStickOriginScreenPos;</span></span><br><span class="line"><span class="code">        _joyStickCenter.position = _canvas.worldCamera.ScreenToWorldPoint(joyStickScreenPos);</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    /// &lt;summary&gt;</span></span><br><span class="line"><span class="code">    /// 判断屏幕坐标是否在摇杆触发区域里</span></span><br><span class="line"><span class="code">    /// &lt;/summary&gt;</span></span><br><span class="line"><span class="code">    /// &lt;param name=&quot;screenPos&quot;&gt;屏幕坐标&lt;/param&gt;</span></span><br><span class="line"><span class="code">    /// &lt;returns&gt;&lt;/returns&gt;</span></span><br><span class="line"><span class="code">    public bool InJoyStickArea(Vector2 screenPos)</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        float len = Vector2.Distance(screenPos, _joyStickOriginScreenPos);</span></span><br><span class="line"><span class="code">        return  len &lt; _joyStickRadius;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">&#125;</span></span><br></pre></td></tr></table></figure>
<p>最后是整个摇杆逻辑实现部分-<code>JoyStickTrigger</code>，这个类里面记录了触发事件，以及对外的参数，如图所示：<br><img src="/blogs/images/src/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20201223223000.png"><br>同样的，通过属性器可以获取当前摇杆的状态参数，包括偏移方向以及强度，方向是360度，强度是[0-1]。详细代码如下：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">using UnityEngine;</span><br><span class="line">using UnityEngine.EventSystems;</span><br><span class="line">/// <span class="xml"><span class="tag">&lt;<span class="name">summary</span>&gt;</span></span></span><br><span class="line">/// 摇杆控制模块</span><br><span class="line">/// <span class="xml"><span class="tag">&lt;/<span class="name">summary</span>&gt;</span></span></span><br><span class="line">public class JoyStickTrigger : MonoBehaviour, IPointerDownHandler, IPointerUpHandler, IDragHandler</span><br><span class="line">&#123;</span><br><span class="line"><span class="code">    public static JoyStickTrigger instance;</span></span><br><span class="line"><span class="code">    [SerializeField] TriggerAreaHandler _joyStickCenterArea;//摇杆背景中心点活动区域</span></span><br><span class="line"><span class="code">    [SerializeField] TriggerAreaHandler _joyStickTriggerArea;//可激活摇杆的区域</span></span><br><span class="line"><span class="code">    [SerializeField] JoyStickView _joyStick;//摇杆</span></span><br><span class="line"><span class="code">    [SerializeField] float _sensitivity = 1;//摇杆灵敏度</span></span><br><span class="line"><span class="code">    [SerializeField] float _triggerAreaScale = 1;//摇杆控制区域</span></span><br><span class="line"><span class="code">    /// &lt;summary&gt;</span></span><br><span class="line"><span class="code">    /// 摇杆偏移方向</span></span><br><span class="line"><span class="code">    /// &lt;/summary&gt;</span></span><br><span class="line"><span class="code">    public Vector2 MoveDir &#123; get; private set; &#125;</span></span><br><span class="line"><span class="code">    /// &lt;summary&gt;</span></span><br><span class="line"><span class="code">    /// 摇杆偏移长度[0-1]</span></span><br><span class="line"><span class="code">    /// &lt;/summary&gt;</span></span><br><span class="line"><span class="code">    public float MoveLen &#123; get; private set; &#125;</span></span><br><span class="line"><span class="code">    /// &lt;summary&gt;</span></span><br><span class="line"><span class="code">    /// 是否在操控摇杆</span></span><br><span class="line"><span class="code">    /// &lt;/summary&gt;</span></span><br><span class="line"><span class="code">    public bool IsDraging &#123; get &#123; return _onJoyStickActive; &#125; &#125;</span></span><br><span class="line"><span class="code">    /// &lt;summary&gt;</span></span><br><span class="line"><span class="code">    /// 摇杆横向偏移量</span></span><br><span class="line"><span class="code">    /// &lt;/summary&gt;</span></span><br><span class="line"><span class="code">    public float Horizontal &#123; get &#123; return MoveDir.x * MoveLen; &#125; &#125;</span></span><br><span class="line"><span class="code">    /// &lt;summary&gt;</span></span><br><span class="line"><span class="code">    /// 摇杆纵向偏移量</span></span><br><span class="line"><span class="code">    /// &lt;/summary&gt;</span></span><br><span class="line"><span class="code">    public float Vertical &#123; get &#123; return MoveDir.y * MoveLen; &#125; &#125;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    Vector2 _originScreenPos = Vector2.zero;//激活摇杆的手指点击位置</span></span><br><span class="line"><span class="code">    Vector2 _dragScreenPos = Vector2.zero;//实时拖动手指位置</span></span><br><span class="line"><span class="code">    Vector2 _interpolateScreenPos = Vector2.zero;//实时摇杆位置</span></span><br><span class="line"><span class="code">    bool _onJoyStickActive = false;//摇杆是否激活</span></span><br><span class="line"><span class="code">    void Awake()</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        instance = this;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    void OnEnable()</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        _joyStick.CalculateAreaSize();</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    void OnDisable()</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        OnPointerUp(null);</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    public void OnPointerDown(PointerEventData eventData)</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        if (!_joyStickTriggerArea.CheckScreenPosInArea(eventData.position))</span></span><br><span class="line"><span class="code">            return;</span></span><br><span class="line"><span class="code">        _onJoyStickActive = true;</span></span><br><span class="line"><span class="code">        //_originScreenPos = eventData.position;</span></span><br><span class="line"><span class="code">        _originScreenPos = _joyStickCenterArea.Clamp(eventData.position);</span></span><br><span class="line"><span class="code">        _interpolateScreenPos = _dragScreenPos = eventData.position;</span></span><br><span class="line"><span class="code">        _joyStick.SetJoyStickOriginPos(_originScreenPos);</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">    public void OnDrag(PointerEventData eventData)</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        if (!_onJoyStickActive) return;</span></span><br><span class="line"><span class="code">        _dragScreenPos = eventData.position;</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    public void OnPointerUp(PointerEventData eventData)</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        _onJoyStickActive = false;</span></span><br><span class="line"><span class="code">        _dragScreenPos = _joyStick.ResetJoyStickOrigionPos();//手指位置归于原点</span></span><br><span class="line"><span class="code">        //_interpolateScreenPos += _dragScreenPos - _originScreenPos;//将插值点随摇杆位置一起归位</span></span><br><span class="line"><span class="code">        _interpolateScreenPos = _dragScreenPos;//</span></span><br><span class="line"><span class="code">        _originScreenPos = _dragScreenPos;//</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    private void Update()</span></span><br><span class="line"><span class="code">    &#123;</span></span><br><span class="line"><span class="code">        _interpolateScreenPos = Vector2.Lerp(_interpolateScreenPos, _dragScreenPos, Time.deltaTime * _sensitivity);</span></span><br><span class="line"><span class="code">        Vector2 dir = _interpolateScreenPos - _originScreenPos;</span></span><br><span class="line"><span class="code">        dir /= _joyStick.GetJoyStickRadius();</span></span><br><span class="line"><span class="code">        dir = dir.sqrMagnitude &gt; 1 ? dir.normalized : dir;</span></span><br><span class="line"><span class="code">        MoveDir = dir;</span></span><br><span class="line"><span class="code">        MoveLen = dir.magnitude;</span></span><br><span class="line"><span class="code">        _joyStick.SetJoyStick(dir);</span></span><br><span class="line"><span class="code">    &#125;</span></span><br><span class="line"><span class="code">&#125;</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2020/12/23/Joy-Stick-Function/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2020/12/23/Joy-Stick-Function/" class="post-title-link" itemprop="url">摇杆实现方法1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-23 22:01:00" itemprop="dateCreated datePublished" datetime="2020-12-23T22:01:00+08:00">2020-12-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-29 11:27:08" itemprop="dateModified" datetime="2021-06-29T11:27:08+08:00">2021-06-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/Component/" itemprop="url" rel="index"><span itemprop="name">Component</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/blogs/images/src/ezgif.com-gif-maker-1.gif" alt="wwwwwww"><br>自己做了个飞行模拟的小游戏，发布到手机上需要用到摇杆来控制，所以自己写了一个Joystick类，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">using UnityEngine;</span><br><span class="line">using UnityEngine.EventSystems;</span><br><span class="line">using System;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; UGUI游戏摇杆</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">public class Joystick : MonoBehaviour, IPointerDownHandler, IPointerUpHandler, IDragHandler</span><br><span class="line">&#123;</span><br><span class="line">    public static Joystick instance;</span><br><span class="line">    [SerializeField] Camera uiCamera;&#x2F;&#x2F;摇杆对应的ui摄像机</span><br><span class="line">    [SerializeField] RectTransform _triggerArea;&#x2F;&#x2F;触发启动摇杆区域</span><br><span class="line">    [SerializeField] RectTransform _joyStickArea;&#x2F;&#x2F;摇杆活动区域</span><br><span class="line">    [SerializeField] RectTransform centerTrans;&#x2F;&#x2F;摇杆图标</span><br><span class="line">    [SerializeField] float sensitivity &#x3D; 1;&#x2F;&#x2F;摇杆灵敏度</span><br><span class="line">    [SerializeField] float triggerAreaScale &#x3D; 1;&#x2F;&#x2F;摇杆控制区域</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 摇杆偏移方向</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public Vector2 moveDir &#123; get; private set; &#125;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 摇杆偏移长度[0-1]</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public float moveLen &#123; get; private set; &#125;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 是否在操控摇杆</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public bool isDraging &#123; get; private set; &#125;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 摇杆横向偏移量</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public float Horizontal &#123; get &#123; return moveDir.x * moveLen; &#125; &#125;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 摇杆纵向偏移量</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public float Vertical &#123; get &#123; return moveDir.y * moveLen; &#125; &#125;</span><br><span class="line"></span><br><span class="line">    Canvas _canvas;</span><br><span class="line">    Canvas canvas &#123; get &#123; if (_canvas &#x3D;&#x3D; null) _canvas &#x3D; transform.GetComponentInParent&lt;Canvas&gt;(); return _canvas; &#125; &#125;</span><br><span class="line">    Vector3 targetScreenPointPos &#x3D; Vector3.zero;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    float radius &#x3D; 0f;</span><br><span class="line">    Vector3 centerScreenPos;</span><br><span class="line">    float depth &#123; get &#123; return centerScreenPos.z; &#125; &#125;</span><br><span class="line">    bool hasInit &#x3D; false;</span><br><span class="line"></span><br><span class="line">    public Action onJoyStickPointerUp;</span><br><span class="line">    private void Start()</span><br><span class="line">    &#123;</span><br><span class="line">        instance &#x3D; this;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    void OnEnable()</span><br><span class="line">    &#123;</span><br><span class="line">        InitParam();</span><br><span class="line">    &#125;</span><br><span class="line">    void OnDisable()</span><br><span class="line">    &#123;</span><br><span class="line">        isDraging &#x3D; false;</span><br><span class="line">        targetScreenPointPos &#x3D; centerScreenPos;</span><br><span class="line">        centerTrans.localPosition &#x3D; Vector3.zero;</span><br><span class="line">    &#125;</span><br><span class="line">    void InitParam()</span><br><span class="line">    &#123;</span><br><span class="line">        if (hasInit) return;</span><br><span class="line">        hasInit &#x3D; true;</span><br><span class="line">        centerScreenPos &#x3D; uiCamera.WorldToScreenPoint(_joyStickArea.position);</span><br><span class="line">        Rect rect &#x3D; RectTransformUtility.PixelAdjustRect(_joyStickArea, canvas);</span><br><span class="line">        radius &#x3D; triggerAreaScale * rect.width&#x2F;2;</span><br><span class="line">        targetScreenPointPos &#x3D; centerScreenPos;</span><br><span class="line">    &#125;</span><br><span class="line">    public void OnPointerDown(PointerEventData eventData)</span><br><span class="line">    &#123;</span><br><span class="line">        InitParam();</span><br><span class="line">        Vector2 pointScreenPos &#x3D; eventData.position;</span><br><span class="line">        &#x2F;&#x2F;if (Vector2.Distance(pointScreenPos, centerScreenPos) &gt; radius) return;</span><br><span class="line"></span><br><span class="line">        isDraging &#x3D; true;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F;targetScreenPointPos &#x3D; uiCamera.WorldToScreenPoint(eventData.pointerCurrentRaycast.worldPosition);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public void OnDrag(PointerEventData eventData)</span><br><span class="line">    &#123;</span><br><span class="line">        if (!isDraging) return;</span><br><span class="line">        Vector3 pointScreenPos &#x3D; eventData.position;</span><br><span class="line">        pointScreenPos.z &#x3D; depth;</span><br><span class="line">        Vector3 dir &#x3D; pointScreenPos - centerScreenPos;</span><br><span class="line">        float len &#x3D; dir.magnitude;</span><br><span class="line">        len &#x3D; len &gt; radius ? radius : len;</span><br><span class="line">        dir &#x3D; len * dir.normalized;</span><br><span class="line">        targetScreenPointPos &#x3D; centerScreenPos + dir;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void OnPointerUp(PointerEventData eventData)</span><br><span class="line">    &#123;</span><br><span class="line">        isDraging &#x3D; false;</span><br><span class="line">        targetScreenPointPos &#x3D; centerScreenPos;</span><br><span class="line">        onJoyStickPointerUp?.Invoke();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private void Update()</span><br><span class="line">    &#123;</span><br><span class="line">        Vector3 screenPointPos &#x3D; uiCamera.WorldToScreenPoint(centerTrans.position);</span><br><span class="line">        if(Vector3.Distance(screenPointPos, targetScreenPointPos)&lt;4)</span><br><span class="line">        &#123;</span><br><span class="line">            screenPointPos &#x3D; targetScreenPointPos;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            screenPointPos &#x3D; Vector3.Lerp(screenPointPos, targetScreenPointPos, sensitivity * Time.deltaTime);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        centerTrans.position &#x3D; uiCamera.ScreenToWorldPoint(screenPointPos);</span><br><span class="line">        moveDir &#x3D; screenPointPos - centerScreenPos;</span><br><span class="line">        moveDir &#x2F;&#x3D; radius;</span><br><span class="line">        moveLen &#x3D; moveDir.magnitude;</span><br><span class="line">        moveLen &#x3D; moveLen &gt; 1 ? 1 : moveLen;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过属性器可以获取当前摇杆的状态参数，包括偏移方向以及强度，方向是360度，强度是[0-1]。还有几个<code>SerializeField</code>面板设置参数，结构如下图：<br><img src="/blogs/images/src/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20201223220715.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2020/12/20/OpenGL-Rendering-Pipeline/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2020/12/20/OpenGL-Rendering-Pipeline/" class="post-title-link" itemprop="url">OpenGL Rendering Pipeline</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-20 15:01:00" itemprop="dateCreated datePublished" datetime="2020-12-20T15:01:00+08:00">2020-12-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-29 11:27:08" itemprop="dateModified" datetime="2021-06-29T11:27:08+08:00">2021-06-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/OpenGL/" itemprop="url" rel="index"><span itemprop="name">OpenGL</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/OpenGL/Render-Pipeline/" itemprop="url" rel="index"><span itemprop="name">Render Pipeline</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>OpengGL 渲染管线包含一连串的、有序的处理过程；主要处理两类几何信息：顶点数据和片段数据；最终将处理结果存储到帧缓存中。另外，OpenGL 可以将处理后的数据传递给CPU–也就是我们的应用程序，下图中的灰色线条表示的就是从GPU到CPU的数据传输：<br><img src="http://www.songho.ca/opengl/files/gl_pipeline.gif"><br>OpenGL Pipeline</p>
<h2 id="Display-List"><a href="#Display-List" class="headerlink" title="Display List"></a>Display List</h2><p>Display list 中存储的是一组OpenGL渲染命令，这些命令是已经编译好的、以供后续渲染操作。当然与渲染相关的所有数据，包括顶点、片段数据都可以存储在Display list中。如果将命令和数据都存储在一起，可能会提高渲染效率。特别是，如果OpenGL渲染程序是在服务端执行，那么使用Display list可以有效减少网络传输次数。因为Display list是服务端的渲染参数，并且由服务器进行执行，因此客户端只需要将命令和数据一同存储到Display list中，然后一次性发送给服务器。关于Display list更详细的介绍请参考<a target="_blank" rel="noopener" href="http://www.songho.ca/opengl/gl_displaylist.html">Display list</a></p>
<h2 id="Vertex-Operation"><a href="#Vertex-Operation" class="headerlink" title="Vertex Operation"></a>Vertex Operation</h2><p>每个顶点坐标以及法向经过GL_MODELVIEW矩阵变换，使得坐标点或者法向从模型坐标系变换到摄像机坐标系。所以，如果这时候有光照参与的话，那么这些基于顶点的光照计算是使用变换后的顶点坐标和法向，也就是在观察坐标系下进行光照计算。然后使用光照计算后的颜色值替换掉原先的顶点颜色。想了解更多关于坐标变换的请参考<a target="_blank" rel="noopener" href="http://www.songho.ca/opengl/gl_transform.html">Transformation</a>。</p>
<h2 id="Primitive-Assembly"><a href="#Primitive-Assembly" class="headerlink" title="Primitive Assembly"></a>Primitive Assembly</h2><p>在顶点变换后，点、线、多边形这些图元会使用投影矩阵，进一步从摄像机空间变换到裁剪空间，然后基于裁剪空间的裁剪平面进行裁剪，数学上的操作原理是将变换后的坐标的x、y、z这三个分量与[-w,w]进行比较，如果三个分量都在里面的话，说明这个点在裁剪包围盒内。经过裁剪后的图元数量会减少很多，然后也就是后续需要处理的数据量减少了。然后我们再做透视除法，也就是将x、y、z三个分量分别处以w，得到齐次设备空间坐标。齐次设备空间x、y、z三个坐标范围是在[-1,1]。然后再经过ViewPot变换，从三维场景变换到屏幕空间坐标系，也就是具体的像素坐标位置。图元拼装的最后一步是图元剔除，例如当前开启的是背面剔除，那么图元法向与视角方向内积小于零的会被剔除。</p>
<h2 id="Pixel-Transfer-Operation"><a href="#Pixel-Transfer-Operation" class="headerlink" title="Pixel Transfer Operation"></a>Pixel Transfer Operation</h2><p>当从内存中读取像素数据，并且对像素值进行解析后，我们会对这些像素数据进行缩放、偏移、映射、裁剪操作。这些操作就叫做像素变换操作。这些变换后的数据可以存储在纹理图片中，也可以直接栅格化到片段中，进入后续的片段着色过程。</p>
<h2 id="Texture-Memory"><a href="#Texture-Memory" class="headerlink" title="Texture Memory"></a>Texture Memory</h2><p>纹理图像被加载后是存储在纹理存储块中，当我们渲染模型时，可以直接从纹理存储块中读取纹理数据。</p>
<h2 id="Rasterization"><a href="#Rasterization" class="headerlink" title="Rasterization"></a>Rasterization</h2><p>栅格化处理是指，将几何数据(包括顶点、法向、uv等)和像素数据转换到片段中，片段数据是一组矩形数组，包含颜色、深度、线宽、点的大小、以及抗锯齿算法模型(GL_POINT_SMOOTH, GL_LINE_SMOOTH, GL_POLYGON_SMOOTH)。如果渲染模式设置的是填充模式GL_FILL,那么多边形区域内的像素填充将发生在这个阶段。每一个片段对应于帧缓存中的一个像素。这里要提一下，帧缓存的尺寸和屏幕大小没有必然关系。</p>
<h2 id="Fragment-Operation"><a href="#Fragment-Operation" class="headerlink" title="Fragment Operation"></a>Fragment Operation</h2><p>片段操作是渲染流程的最后一步，从片段数据转换为帧缓存中的像素值。这个阶段的第一步是像素生成；从纹理缓存开中的纹理元素被应用于每一个片段。然后计算雾的颜色。最后，需要进行各种测试，测试顺序为： 剪刀测试 –&gt; 透明通道测试 –&gt; 模板测试 –&gt;  深度测试。</p>
<h2 id="Feedback"><a href="#Feedback" class="headerlink" title="Feedback"></a>Feedback</h2><p>OpenGL 可以通过glGet()、gllsEnabled()两个命令获取当前渲染过程中大部分的状态以及信息。如果需要，我们还可以使用glReadPixels()从帧缓存中截取一块像素数据，也可以使用glRenderMode(GL_FEEDBACK)来获取所有变换后的顶点数据。值得注意的是，glCopyPixels()并不是将像素数据返回到CPU，而实将其复制到其他的帧缓存，例如从前置帧到后置帧。这里前置和后置构成了双帧缓存机制。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2020/12/19/OpenGL-Overview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2020/12/19/OpenGL-Overview/" class="post-title-link" itemprop="url">OpenGL Overview</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-19 15:01:00" itemprop="dateCreated datePublished" datetime="2020-12-19T15:01:00+08:00">2020-12-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-29 11:27:08" itemprop="dateModified" datetime="2021-06-29T11:27:08+08:00">2021-06-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/OpenGL/" itemprop="url" rel="index"><span itemprop="name">OpenGL</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/OpenGL/Overview/" itemprop="url" rel="index"><span itemprop="name">Overview</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="OpenGL-Introduction"><a href="#OpenGL-Introduction" class="headerlink" title="OpenGL Introduction"></a>OpenGL Introduction</h2><p>OpenGL 是图形硬件的软件接口，接口功能与硬件无关，可以在不同的硬件平台上使用。OpenGL程序也可以通过网络的方式执行，例如客户端-服务器这种分布方式。OpenGL的客户端是指执行OpenGL程序的计算机，而服务端是指执行绘图操作的计算机。</p>
<p>OpenGL使用gl前置符来标记OpenGL内核命令，使用glu来标记OpenGL Utility库命令。另外，OpenGL所有以GL_开头的命令全部是大写。OpenGL也会用后置标志符来指明命令参数的个数以及类型。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">glColor3f(1,0,0);		//使用三个浮点数设置颜色</span><br><span class="line">glColor4d(0,1,0,0.2);	//使用双精度浮点数设置颜色，并具有Alpha通道</span><br><span class="line">glVertex3fv(vertex);	//使用三维向量设置顶点坐标</span><br></pre></td></tr></table></figure>

<h2 id="State-Machine"><a href="#State-Machine" class="headerlink" title="State Machine"></a>State Machine</h2><p>OpenGL是一个状态机。其中设置的各种状态参数，包括模式、属性等，会一直有效，直到我们对其手动修改。绝大多数的状态值可以直接使用glEnable() 或 glDisable()来开启和禁用。我们也可以使用gllsEnabled()来获取某个状态值当前的开启状态。我们也可以使用glPushAttrib()和glPopAttrib()来保存或提取一组状态值。GL_ALL_ATTRIB_BITS参数表示保存或提取所有的状态值。在标准的OpenGL中，栈的个数不少于16个。我们可以使用<a target="_blank" rel="noopener" href="http://www.songho.ca/opengl/files/glinfo.zip">glinfo</a>来获取栈的大小信息。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">glPushAttrib(GL<span class="emphasis">_LIGHTING_</span>BIT);			//</span><br><span class="line"><span class="code">	glDisable(GL_LIGHTING);</span></span><br><span class="line"><span class="code">	glEnable(GL_COLOR_MATERIAL);</span></span><br><span class="line"><span class="code">glPushAttrib(GL_COLOR_BUFFER_BIT);</span></span><br><span class="line"><span class="code">	glDisable(GL_DITHER);</span></span><br><span class="line"><span class="code">	glEnable(GL_BLEND);</span></span><br><span class="line"><span class="code">	</span></span><br><span class="line"><span class="code">...//其他代码</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">glPopAttrib();		//提取GL_COLOR_BUFFER_BIT</span></span><br><span class="line"><span class="code">glPopAttrib();		//提取GL_LIGHTING_BIT</span></span><br></pre></td></tr></table></figure>

<h2 id="glBegin-和glEnd"><a href="#glBegin-和glEnd" class="headerlink" title="glBegin()和glEnd()"></a>glBegin()和glEnd()</h2><p>我们可以直接在glBegin()和glEnd()方法之间，指定一组顶点数据来绘制几何图元，例如点、线、三角形等等。这种绘制方式称为及时模式。我们也可以使用其他的方式进行绘制，例如<a target="_blank" rel="noopener" href="http://www.songho.ca/opengl/gl_vertexarray.html">vertex array</a>。</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">glBegin(GL<span class="emphasis">_TRIANGLES);</span></span><br><span class="line"><span class="emphasis">	glColor3f(1,0,0);		//设置颜色为红色</span></span><br><span class="line"><span class="emphasis">	glVertex3fv(v1);		//设置三角形的三个顶点坐标</span></span><br><span class="line"><span class="emphasis">	glVertex3fv(v2);</span></span><br><span class="line"><span class="emphasis">	glVertex3fv(v3);</span></span><br><span class="line"><span class="emphasis">glEnd();</span></span><br></pre></td></tr></table></figure>

<p>OpenGL中包含十种图元类型：GL_POINTS, GL_LINES, GL_LINE_STRIP, GL_LINE_LOOP, GL_TRIANGLES, GL_TRIANGLE_STRIP, GL_TRIANGLE_FAN, GL_QUADS, GL_QUAD_STRIP, GL_POLYGON。</p>
<p>这里需要注意的是，不是所有的命令都可以放在glBegin()和glEnd()之间，只有一小部分命令可以，例如glVertex*(), glColor*(), glNormal*(), glTexCoord*(), glMaterial*(), glCallList()等等。</p>
<h2 id="glFlush-和glFinish"><a href="#glFlush-和glFinish" class="headerlink" title="glFlush()和glFinish()"></a>glFlush()和glFinish()</h2><p>类似于计算机的IO缓存，OpenGL命令也不是立刻执行的。所有的命令首先是存储在缓存中，包括网络缓存以及图形加速器，都是在缓存满了之后，再一并执行缓存中的命令。举个例子，我们的应用程序是通过网络连接的，那么最有效的数据传输方式是将所有数据打包到一起，然后一并发送。相比于每一个命令发送一次，这种批处理的方式效率更高。</p>
<p>glFlush()是用来清空命令缓存，同时强制立即执行缓存中的所有命令。也就是说，使用glFlush()是一种手动执行的操作，它不需要等到命令缓存满了才执行。虽然glFlush()会立即执行缓存中的命令，但是其实际操作应该是将缓存中的命令插入到GPU已有命令的队列里面，当然这种插入是优先插入到最前面，等当前执行的操作完成之后，就会立即开始执行这些命令，然后这些命令执行完后，glFlush()会立即返回到CPU程序，而原先被强制插队的操作会依次执行。所以对glFlush()更为准确的描述应该是，在调用glFlush()后，缓存中的命令会在短暂的等待后立即执行，然后在这些命令执行完成后，glFlush()会立即返回到CPU程序，而原先在GPU中排队的操作会继续执行。</p>
<p>glFinish()和glFlush()方法类似，都是清空命令缓存并强制立即执行缓存中的命令。但是glFinsh()会打断已经开始执行的操作，然后等命令缓存中的所有操作都执行完，再恢复原先被打断的操作。这里面打断，是指GPU中正在执行的操作被暂停。因此，glFinsh()方法，在命令缓存中的命令全部执行完后，不会立即返回到CPU程序，而是等之前未完成的操作全部执行完后，再返回到CPU程序。所以，我们可以是在一些同步任务(也就是GPU的执行操作和CPU的执行操作是串在一起的)中使用glFinsh(),也可以用于测量原先操作的执行时间，因为glFinsh()会等原先的操作执行完再返回。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2020/12/19/OpenGL-Transformation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2020/12/19/OpenGL-Transformation/" class="post-title-link" itemprop="url">OepnGL Transformation</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-19 15:01:00" itemprop="dateCreated datePublished" datetime="2020-12-19T15:01:00+08:00">2020-12-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-29 11:27:08" itemprop="dateModified" datetime="2021-06-29T11:27:08+08:00">2021-06-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/OpenGL/" itemprop="url" rel="index"><span itemprop="name">OpenGL</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/OpenGL/Transformation/" itemprop="url" rel="index"><span itemprop="name">Transformation</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>顶点、法向这些几何数据的坐标变换是发生在Vertex Operation，而<a target="_blank" rel="noopener" href="http://www.songho.ca/opengl/gl_pipeline.html">OpenGL Pipeline</a>图元拼装是发生在栅格化操作之前。<br><img src="http://www.songho.ca/opengl/files/gl_transform02.png"><br>OpenGL vertex transformation</p>
<h3 id="Object-Coordinates"><a href="#Object-Coordinates" class="headerlink" title="Object Coordinates"></a>Object Coordinates</h3><p>模型坐标系表示的是模型的初始位置和朝向，也是模型在所有坐标变换之前的初始状态。我们可以使用glRotatef(), glTranslatef(), glScalef()来对模型进行坐标变换。</p>
<h3 id="Eye-Coordinates"><a href="#Eye-Coordinates" class="headerlink" title="Eye Coordinates"></a>Eye Coordinates</h3><p>模型坐标经过GL_MODELVIEW矩阵变换后，进入摄像机坐标系。GL_MODELVIEW矩阵结合了模型矩阵和观测矩阵(Mview * Mmodel)。模型矩阵变换是从模型坐标系到世界坐标系，而观察矩阵变换是从世界坐标系到观察坐标系。<br><img src="http://www.songho.ca/opengl/files/gl_transform07.png"></p>
<p>在OpenGL中，没有单独的观察矩阵(Mview)。因此，要模拟摄像机变换，也就是移动摄像机，我们通常是对场景中的物体做一个反向变换，例如，我们控制摄像机右移，实际上是将整个场景左移。更具体一点就是，在OpenGL中，摄像机的位置永远都是在原点，面向观察坐标系下的-z方向。关于GL_MODELVIEW更详细的介绍请参考<a target="_blank" rel="noopener" href="http://www.songho.ca/opengl/gl_transform.html#modelview">ModelView Matrix</a>。</p>
<p>模型的法向主要是用来进行光照计算的，在OpenGL中，用于光照计算的法向是在观察坐标系下的法向。也就是我们先使用GL_MODELVIEW对法向进行变换，然后再进行光照计算。需要注意的是，法向的变换和坐标点的变换操作有所区别。我们这里坐标变换是直接将坐标左乘GL_MODELVIEW变换矩阵。但是法向变换是左乘GL_MODELVIEW变换矩阵逆矩阵的转置矩阵。关于法向变换请参考<a target="_blank" rel="noopener" href="http://www.songho.ca/opengl/gl_normaltransform.html">Normal Vector Transformation</a>。<br><img src="http://www.songho.ca/opengl/files/gl_normaltransform01.png"></p>
<h3 id="Clip-Coordinates"><a href="#Clip-Coordinates" class="headerlink" title="Clip Coordinates"></a>Clip Coordinates</h3><p>使用GL_PROJECTION投影矩阵，从观察坐标系变换到裁剪坐标系。其中GL_PROJECTION定义了裁剪区域，以及投影方式，是透视投影还是正交投影呢。之所以称作裁剪坐标系，是因为我们可以通过变换后的坐标来实现裁剪操作。更具体一点就是，变换后的坐标(x,y,z,w)。其中w表示的裁剪边界，当(x,y,z)都在[-w,w]这个范围内时，说明这个点在裁剪区域内；而不在这个范围的点将会被剔除。如果某个图元的所有点都不在裁剪区域内，那么整个图元都会被剔除，如果部分顶点在裁剪区域内，那么不在区域内的点将会被剔除，但是会基于裁剪边界对图元进行一个缝合操作。关于GL_PROJECTION的更多介绍请参考<a target="_blank" rel="noopener" href="http://www.songho.ca/opengl/gl_transform.html#projection">Projection Matix</a>。<br><img src="http://www.songho.ca/opengl/files/gl_transform08.png"></p>
<h3 id="Normalized-Device-Coordinates-NDC"><a href="#Normalized-Device-Coordinates-NDC" class="headerlink" title="Normalized Device Coordinates (NDC)"></a>Normalized Device Coordinates (NDC)</h3><p>经过裁剪变换后，在裁剪区域内的坐标点的x,y,z的范围在[-w,w]之间，将x,y,z除以w后，得到齐次设备空间坐标。这个操作叫做投影除法。齐次设备空间坐标的x,y,z的范围现在是[-1,1]。<br><img src="http://www.songho.ca/opengl/files/gl_transform12.png"></p>
<h3 id="Window-Coordinates-Screen-Coordinates"><a href="#Window-Coordinates-Screen-Coordinates" class="headerlink" title="Window Coordinates (Screen Coordinates"></a>Window Coordinates (Screen Coordinates</h3><p>使用视窗变换(ViewPort)，从齐次设备空间变换到屏幕空间。通过对齐次设备空间进行缩放、平移，来对齐屏幕渲染窗口区域。这个时候，虽然属于屏幕坐标系，但是整个空间还是属于几何意义上的、连续的空间，和像素表示的离散的空间有本质的区别。因为我们的图形还是通过点、线、多边形图元表示，而离散的像素空间是使用单个像素表示。<br>屏幕空间下的坐标、法向等几何信息，最终通过栅格化处理，得到离散化的片段数据，坐标变换和栅格化操作之间的关系请参考<a target="_blank" rel="noopener" href="http://www.songho.ca/opengl/gl_pipeline.html">OpenGL pipeline</a>中的管线图。glViewport()方法是用来定义屏幕空间哪个矩形区域用来显示最终的渲染画面。glDepthRange()方法是用来确定屏幕坐标系的z值。最终得到的屏幕坐标是基于这两个方法所设置的参数决定的：</p>
<ul>
<li>glViewport(x,y,w,h);</li>
<li>glDepthRange(n,f);</li>
</ul>
<p><img src="http://www.songho.ca/opengl/files/gl_transform13.png"><br><img src="/blogs/images/src/d626436913e4116bd6112677aa7b026.jpg" alt="wwwwwww"></p>
<p>视窗变换只是简单的线性映射：</p>
<p><img src="http://www.songho.ca/opengl/files/gl_transform14.png"></p>
<h2 id="OpenGL-Transformation-Matrix"><a href="#OpenGL-Transformation-Matrix" class="headerlink" title="OpenGL Transformation Matrix"></a>OpenGL Transformation Matrix</h2><p><img src="http://www.songho.ca/opengl/files/gl_transform04.png"><br>OpenGL Transformation Matrix</p>
<p>OpenGL使用<a target="_blank" rel="noopener" href="http://www.songho.ca/opengl/gl_matrix.html">4X4的矩阵</a>作为变换矩阵。值得注意的是，这16个元素是按列主序存储在一维数组里面。我们可以通过转置操作将其变为行主序。行主序是标准公约。</p>
<p>OpenGL有4中不同类型的矩阵：GL_MODELVIEW, GL_PROJECTION, GL_TEXTURE, GL_COLOR。我们可以通过glMatrixMode()方法来切换当前矩阵类型。例如，我们想选择GL_MODELVIEW矩阵，那么可以使用<code>glMatrixMode(GL_MODELVIEW)</code>。</p>
<h3 id="Model-View-Matrix-GL-MODELVIEW"><a href="#Model-View-Matrix-GL-MODELVIEW" class="headerlink" title="Model-View Matrix (GL_MODELVIEW)"></a>Model-View Matrix (GL_MODELVIEW)</h3><p>GL_MODELVIEW将观察矩阵和模型矩阵结合到一起。如果我们想从模型坐标系变换到观察坐标系，那么我们需要GL_MODELVIEW的逆矩阵进行变换。gluLookAt()主要用来设置观察矩阵。</p>
<p><img src="http://www.songho.ca/opengl/files/gl_anglestoaxes01.png"><br>GL_MODELVIEW矩阵</p>
<p>上图中，最右边的三个元素(m12,m13,14)，表示的是平移变换–glTranslatef()。元素m15表示的是<a target="_blank" rel="noopener" href="http://www.songho.ca/math/homogeneous/homogeneous.html">齐次坐标</a>，主要用来做透视变换用的。</p>
<p>另外9个元素(m0,m1,m2),(m4,m5,m6),(m8,m9,10)是用来进行欧式变换以及仿射变换，相关的函数是glRotatef()和glScalef()。另外值得指出的是，这三组向量表示的是相互正交的轴。</p>
<ul>
<li>(m0,m1,m2) : +X轴,   left 向量，默认是(1,0,0)</li>
<li>(m4,m5,m6) : +Y轴,    up  向量，默认是(0,1,0)</li>
<li>(m8,m9,m10): +Z轴, forward向量，默认是(0,0,1)</li>
</ul>
<p>除了使用变换函数，如glRotatef()，来修改GL_MODELVIEW矩阵，我们也可以根据摄像机偏转角或者朝向来手动计算GL_MODELVIEW矩阵，例如以下几种方法：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.songho.ca/opengl/gl_anglestoaxes.html">Angles to Axes</a></li>
<li><a target="_blank" rel="noopener" href="http://www.songho.ca/opengl/gl_lookattoaxes.html">Lookat to Axes</a></li>
<li><a target="_blank" rel="noopener" href="http://www.songho.ca/opengl/gl_rotate.html">Rotation About Arbitrary Axis</a></li>
<li><a target="_blank" rel="noopener" href="http://www.songho.ca/opengl/gl_matrix.html">Matrix4 class</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tyson-wu.github.io/blogs/2020/11/22/Rendering-with-Replaced-Shaders/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blogs/images/avatar.png">
      <meta itemprop="name" content="Tyson Wu">
      <meta itemprop="description" content="If you want, Just do it!">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="TysonWu's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/blogs/2020/11/22/Rendering-with-Replaced-Shaders/" class="post-title-link" itemprop="url">Rendering with Replaced Shaders</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-22 18:01:34" itemprop="dateCreated datePublished" datetime="2020-11-22T18:01:34+08:00">2020-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-29 11:27:08" itemprop="dateModified" datetime="2021-06-29T11:27:08+08:00">2021-06-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/" itemprop="url" rel="index"><span itemprop="name">Unity</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blogs/categories/Unity/Shader/" itemprop="url" rel="index"><span itemprop="name">Shader</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>通常每个需要渲染的物体都自带材质以及相应的shader，但是有时候我们可能希望使用同一个Shader对场景中的进行渲染。例如，当我们对屏幕图像进行边缘检测时，需要知道每个像素点所对应三维空间点的法向量，然后根据法向量的差异来判断是否是边缘。还有一些情况我们需要场景的深度信息。无论是法向纹理还是深度散纹理等，都可以通过Relpace Shader来实现。<br>Replace Shader和普通shader没什么区别，我们只需要调用Camera.RenderWithShader或者<code>Camera.SetReplacementShader</code>函数，并指定需要用于替换的shader,以及shader的Tags值。<br>假如我们有以下三个shader，其中shaderA被设置为Relace Shader，且repalcementTag为”ReplacementTag”，其余两个都是挂载在模型上的shader：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Shader A&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">	SubShader</span><br><span class="line">	&#123;</span><br><span class="line">		Tags &#123;<span class="string">&quot;ReplacementTag&quot;</span>=<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	SubShader</span><br><span class="line">	&#123;</span><br><span class="line">		Tags &#123;<span class="string">&quot;OtherTag&quot;</span>=<span class="string">&quot;whatever&quot;</span>&#125;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Shader B&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">	SubShader</span><br><span class="line">	&#123;</span><br><span class="line">		Tags &#123;<span class="string">&quot;ReplacementTag&quot;</span>=<span class="string">&quot;false&quot;</span>&#125;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	SubShader</span><br><span class="line">	&#123;</span><br><span class="line">		Tags &#123;<span class="string">&quot;OtherTag&quot;</span>=<span class="string">&quot;whatever&quot;</span>&#125;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;Shader C&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">	SubShader</span><br><span class="line">	&#123;</span><br><span class="line">		Tags &#123;<span class="string">&quot;ReplacementTag&quot;</span>=<span class="string">&quot;true&quot;</span>&#125;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	SubShader</span><br><span class="line">	&#123;</span><br><span class="line">		Tags &#123;<span class="string">&quot;OtherTag&quot;</span>=<span class="string">&quot;whatever&quot;</span>&#125;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这时候，只有挂载ShaderC的模型会被渲染。虽然ShaderB和ShaderC都含有“ReplacementTag”,但是ShaderA中的<code>&quot;ReplacementTag&quot;=&quot;true&quot;</code>，只有ShaderC中的第一个SubShader有匹配的Tag值。</p>
<h2 id="Lit-Shader-replacement"><a href="#Lit-Shader-replacement" class="headerlink" title="Lit Shader replacement"></a>Lit Shader replacement</h2><p>replacement渲染需要指定一个camera来实现，被指定camera的渲染设置都会应用到repalcement渲染过程中，例如render path、light、shadow等。</p>
<h2 id="Built-in-scene-depth-normals-texture"><a href="#Built-in-scene-depth-normals-texture" class="headerlink" title="Built-in scene depth/normals texture"></a>Built-in scene depth/normals texture</h2><p>camera本身内置了深度、法向纹理的渲染功能，只需要设置<code>Camera.depthTextureMode</code>，便可以开启这些功能，而渲染后的深度纹理可以用全局的<code>_CameraDepthTexture</code>变量来引用。<br>而这种内置的渲染功能的实际渲染方法与硬件相关。有些硬件就是通过replacement渲染的方式来实现的。因为ReplacementTag会对实际渲染的物体进行筛选，所以在编写Shader时，要正确使用“RenderType”这个标签。</p>
<h2 id="Code-Example"><a href="#Code-Example" class="headerlink" title="Code Example"></a>Code Example</h2><p>在Start()函数中指定replacement shader:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void Start()</span><br><span class="line">&#123;</span><br><span class="line">	camera.SetReplacementShader(EffiectShader,<span class="string">&quot;RenderType&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>EffiectShader需要包含”RenderType”这个标签，如果没有”RenderType”这个，那么不会有任何物体被渲染。另外，EffiectShader可以有多个SubShader，每个SubShader对应一个”RenderType”。例如，我们需要渲染透明物体，可以指定两个SubShader分别渲染”RenderType”=”Transparent”和”RenderType”=”TransparentCutout”。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Shader <span class="string">&quot;EffectShader&quot;</span> &#123;</span><br><span class="line">     SubShader &#123;</span><br><span class="line">         Tags &#123; <span class="string">&quot;RenderType&quot;</span>=<span class="string">&quot;Opaque&quot;</span> &#125;</span><br><span class="line">         Pass &#123;</span><br><span class="line">             ...</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     SubShader &#123;</span><br><span class="line">         Tags &#123; <span class="string">&quot;RenderType&quot;</span>=<span class="string">&quot;SomethingElse&quot;</span> &#125;</span><br><span class="line">         Pass &#123;</span><br><span class="line">             ...</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>SetReplacementShader函数会查找场景中所有物体，这些物体自带的Shader的”RenderType”值和EffectShader中的”RenderType”值匹配的话，那么这些物体将会使用EffectShader中相对应的SubShader进行渲染。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blogs/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/blogs/">1</a><span class="page-number current">2</span><a class="page-number" href="/blogs/page/3/">3</a><a class="extend next" rel="next" href="/blogs/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Tyson Wu"
      src="/blogs/images/avatar.png">
  <p class="site-author-name" itemprop="name">Tyson Wu</p>
  <div class="site-description" itemprop="description">If you want, Just do it!</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blogs/archives/">
        
          <span class="site-state-item-count">28</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blogs/categories/">
          
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blogs/tags/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Tyson-Wu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Tyson-Wu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/zhao-wu-zhu-43" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;zhao-wu-zhu-43" rel="noopener" target="_blank"><i class="知乎 fa-fw"></i>知乎</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.cnblogs.com/Hi-blog/" title="https:&#x2F;&#x2F;www.cnblogs.com&#x2F;Hi-blog&#x2F;" rel="noopener" target="_blank">starnight_cyber</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tyson Wu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/blogs/lib/anime.min.js"></script>
  <script src="/blogs/lib/velocity/velocity.min.js"></script>
  <script src="/blogs/lib/velocity/velocity.ui.min.js"></script>

<script src="/blogs/js/utils.js"></script>

<script src="/blogs/js/motion.js"></script>


<script src="/blogs/js/schemes/pisces.js"></script>


<script src="/blogs/js/next-boot.js"></script>




  















  

  

</body>
</html>
